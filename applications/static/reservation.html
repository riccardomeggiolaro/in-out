<!DOCTYPE html>
<html lang="it">
    <head>
        <link rel="icon" href="https://on.baron.it/tecnico/pesi/FAVICON_BARONPESI.ico">
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Prenotazioni</title>
        <meta name="description" content="About this app" />
        <link rel="stylesheet" href="/static/css/dynamic-table.css">
        <link rel="stylesheet" href="/static/css/snackbar.css">
        <style>
            .table-container {
                max-width: 1500px;
            }
            #dateRange {
                width: 200px;
            }
            .popup.active {
                max-width: 800px !important;
            }
            .detail-cell {
                padding: 0px;
            }
            .list-detail-tr li {
                padding: 0px 0px 10px 0px;
                list-style-type: disc;
            }
            .list-detail-tr li:last-child {
                padding: 0px;
            }
        </style>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
        <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    </head>
<body>
    <div id="navbar-container"></div>

    <br>

    <div class="table-container">
        <div class="title">
            <h2>Prenotazioni</h2>
            <button class="register-button" onclick="addRow()">Registra</button>
        </div>
        <table>
            <thead>
                <tr id="filters">
                    <th name="date_created">
                        <input type="text" id="dateRange" placeholder="Data accettazione" autocomplete="off" onclick="this.select()">
                        <input type="date" id="filter.fromDate" name="fromDate" autocomplete="off">
                        <input type="date" id="filter.toDate" name="toDate" autocomplete="off">
                    </th>
                    <th name="status">
                        <select id="filter.status" name="status" onchange="updateTable()">
                            <option value="">Stato</option>
                            <option value="WAITING">Attesa</option>
                            <option value="CALLED">Chiamato</option>
                            <option value="ENTERED">Entrato</option>
                            <option value="CLOSED">Chiusa</option>
                        </select>
                    </th>
                    <th name="waiting">Attesa</th>
                    <th name="subject.social_reason">
                        <input id="filter.subject.social_reason" name="subject.social_reason" type="text" placeholder="Soggetto" oninput="updateTable()">
                    </th>
                    <th name="vector.social_reason">
                        <input id="filter.vector.social_reason" name="vector.social_reason" type="text" placeholder="Vettore" oninput="updateTable()">
                    </th>
                    <th name="driver.social_reason">
                        <input id="filter.driver.social_reason" name="driver.social_reason" type="text" placeholder="Autista" oninput="updateTable()">
                    </th>
                    <th name="driver.telephone">
                        <input id="filter.driver.telephone" name="driver.telephone" type="text" placeholder="Tel. Autista" oninput="updateTable()">
                    </th>
                    <th name="vehicle.plate">
                        <input id="filter.vehicle.plate" name="vehicle.plate" type="text" placeholder="Targa" oninput="updateTable()">
                    </th>
                    <th name="note">
                        <input id="filter.note" name="note" type="text" placeholder="Note" oninput="updateTable()">
                    </th>
                    <th name="number_weighings">Pesate</th>
                    <th name="document_reference">
                        <input id="filter.document_reference" name="document_reference" type="text" placeholder="Bolla" oninput="updateTable()">
                    </th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
            </tbody>
            <tfoot>
                <tr>
                    <td colspan="12" style="text-align: center;">
                        <label for="rows-per-page">Righe per pagina:</label>
                        <select id="rows-per-page" onchange="changeRowsPerPage()">
                            <option value="10">10</option>
                            <option value="15">15</option>
                            <option value="25">25</option>
                            <option value="50">50</option>
                        </select>
                        <button id="previous-page" onclick="previousPage()">&laquo; Precedente</button>
                        <select id="page-select" onchange="goToPage()"></select>
                        <button id="next-page" onclick="nextPage()">Successiva &raquo;</button>
                        <span id="total-rows" style="margin-left: 20px;"></span> <!-- Aggiungi il numero totale di righe qui -->
                    </td>
                </tr>
            </tfoot>            
        </table>
    </div>

    <div class="overlay" id="overlay" onclick="closePopups(['add-popup', 'edit-popup', 'delete-popup', 'confirm-popup'])"></div>
    
    <div id="add-popup" class="modal-content popup">
        <h3>Nuova prenotazione:</h3>
        <form id="register" class="content form-content" autocomplete="off" oninput="document.querySelector('#add-popup .save-btn').disabled = !this.checkValidity()">
            <h4>Soggetto</h4>

            <div class="radio">
                <div class="radio-option left">
                  <label class="flexRadio">
                    <input id="customer" type="radio" name="typeSubject" value="CUSTOMER" checked>
                    Cliente
                  </label>
                </div>
                <div class="radio-option right">
                  <label class="flexRadio">
                    <input id="supplier" type="radio" name="typeSubject" value="SUPPLIER">
                    Fornitore
                  </label>
                </div>
            </div>

            <div>
                <div class="item">
                    <input id="subject.id" name="subject.id" type="number" class="suggestionId">
                    <input placeholder="Ragione Sociale" id="subject.social_reason" name="subject.social_reason" type="text"
                        oninput="
                            populateSuggestions('#add-popup', '#register #suggestions\\.subject\\.social_reason', 'social_reason', 'subject', this.value);
                            if (document.querySelector('#add-popup #subject\\.id').value != '') {
                                deselectAnagrafic(document.querySelector('#add-popup #subject\\.id').value, 'subject');
                                document.querySelector('#add-popup #subject\\.id').value = '';
                                document.querySelector('#add-popup #subject\\.telephone').disabled = false;
                                document.querySelector('#add-popup #subject\\.telephone').value = '';
                                document.querySelector('#add-popup #subject\\.cfpiva').disabled = false;
                                document.querySelector('#add-popup #subject\\.cfpiva').value = '';
                            }
                        "
                        onfocus="
                            if (!document.querySelector('#add-popup #subject\\.id').value) {
                                populateSuggestions('#add-popup', '#register #suggestions\\.subject\\.social_reason', 'social_reason', 'subject', this.value);
                            }
                        "
                        onblur="closeSuggestions('#add-popup', '#register #suggestions\\.subject\\.social_reason', 'social_reason', 'subject', this.value)">
                    <div id="suggestions.subject.social_reason" class="suggestions"></div>
                </div>
    
                <div class="item-25">
                    <input placeholder="Telefono" id="subject.telephone" name="subject.telephone" type="text" pattern="\d*" oninput="this.value = this.value.replace(/\D/g, '')">
                </div>
                    
                <div class="item-25">
                    <input placeholder="CF/P.Iva" id="subject.cfpiva" name="subject.cfpiva" type="text" pattern="(^[A-Z0-9]{16}$|^\d{11}$)" oninput="this.value = this.value.toUpperCase().replace(/[^A-Z0-9]/g, '')">
                </div>
            </div>

            <hr>

            <h4>Vettore</h4>

            <div>
                <div class="item">
                    <input id="vector.id" name="vector.id" type="number" class="suggestionId">
                    <input placeholder="Ragione Sociale" id="vector.social_reason" name="vector.social_reason" type="text"
                        oninput="
                            populateSuggestions('#add-popup', '#register', '#register #suggestions\\.vector\\.social_reason', 'social_reason', 'vector', this.value);
                            if (document.querySelector('#add-popup #vector\\.id').value != '') {
                                deselectAnagrafic('#add-popup', document.querySelector('#add-popup #vector\\.id').value, 'vector');
                                document.querySelector('#add-popup #vector\\.id').value = '';
                                document.querySelector('#add-popup #vector\\.telephone').disabled = false;
                                document.querySelector('#add-popup #vector\\.telephone').value = '';
                                document.querySelector('#add-popup #vector\\.cfpiva').disabled = false;
                                document.querySelector('#add-popup #vector\\.cfpiva').value = '';
                            }
                        "
                        onfocus="
                            if (!document.querySelector('#add-popup #vector\\.id').value) {
                                populateSuggestions('#add-popup', '#register #suggestions\\.vector\\.social_reason', 'social_reason', 'vector', this.value);
                            }
                        "
                        onblur="closeSuggestions('#add-popup', '#register #suggestions\\.vector\\.social_reason', 'social_reason', 'vector', this.value)">
                    <div id="suggestions.vector.social_reason" class="suggestions"></div>
                </div>
    
                <div class="item-25">
                    <input placeholder="Telefono" id="vector.telephone" name="vector.telephone" type="text" pattern="\d*" oninput="this.value = this.value.replace(/\D/g, '');"><br>
                </div>
                    
                <div class="item-25">
                    <input placeholder="CF/P.Iva" id="vector.cfpiva" name="vector.cfpiva" type="text" pattern="(^[A-Z0-9]{16}$|^\d{11}$)" oninput="this.value = this.value.toUpperCase().replace(/[^A-Z0-9]/g, '')"><br>
                </div>
            </div>

            <hr>

            <h4>Autista</h4>

            <div>
                <div class="item-25">
                    <input id="driver.id" name="driver.id" type="number" class="suggestionId">
                    <input placeholder="Nome Cognome" id="driver.social_reason" name="driver.social_reason" type="text"
                        oninput="
                            populateSuggestions('#add-popup', '#register #suggestions\\.driver\\.social_reason', 'social_reason', 'driver', this.value);
                            if (document.querySelector('#add-popup #driver\\.id').value != '') {
                                deselectAnagrafic(document.querySelector('#add-popup #driver\\.id').value, 'driver');
                                document.querySelector('#add-popup #driver\\.id').value = '';
                                document.querySelector('#add-popup #driver\\.telephone').disabled = false;
                                document.querySelector('#add-popup #driver\\.telephone').value = '';
                            }
                        "
                        onfocus="
                            if (!document.querySelector('#add-popup #driver\\.id').value) {
                                populateSuggestions('#add-popup', '#register #suggestions\\.driver\\.social_reason', 'social_reason', 'driver', this.value);
                            }
                        "
                        onblur="closeSuggestions('#add-popup', '#register #suggestions\\.driver\\.social_reason', 'social_reason', 'driver', this.value)">
                    <div id="suggestions.driver.social_reason" class="suggestions"></div>
                </div>
    
                <div class="item-25">
                    <input placeholder="Telefono" id="driver.telephone" name="driver.telephone" type="text" pattern="\d*" oninput="this.value = this.value.replace(/\D/g, '');">
                </div>
            </div>

            <hr>

            <h4>Veicolo</h4>

            <div>
                <div class="item-25">
                    <input id="vehicle.id" name="vehicle.id" type="number" class="suggestionId">
                    <input placeholder="Targa" id="vehicle.plate" name="vehicle.plate" type="text" pattern="[A-Za-z]{2}\d{3}[A-Za-z]{2}" required
                        oninput="
                            this.value = this.value.toUpperCase();
                            populateSuggestions('#add-popup', '#register #suggestions\\.vehicle\\.plate', 'plate', 'vehicle', this.value);
                            if (document.querySelector('#add-popup #vehicle\\.id').value != '') {
                                deselectAnagrafic(document.querySelector('#add-popup #vehicle\\.id').value, 'vehicle');
                                document.querySelector('#add-popup #vehicle\\.id').value = '';
                                document.querySelector('#add-popup #vehicle\\.description').disabled = false;
                                document.querySelector('#add-popup #vehicle\\.description').value = '';
                            }
                        "
                        onfocus="
                            if (!document.querySelector('#add-popup #vehicle\\.id').value) {
                                populateSuggestions('#add-popup', '#register #suggestions\\.vehicle\\.plate', 'plate', 'vehicle', this.value);
                            }
                        "
                        onblur="closeSuggestions('#add-popup', '#register #suggestions\\.vehicle\\.plate', 'plate', 'vehicle', this.value)">
                    <div id="suggestions.vehicle.plate" class="suggestions"></div>
                </div>
    
                <div class="item-25">
                    <input placeholder="Descrizione" id="vehicle.description" name="vehicle.description" type="text">
                </div>
            </div>

            <hr>

            <div>
                <div class="item-25">
                    <input placeholder="Numero pesate" id="number_weighings" name="number_weighings" type="number" pattern="\d*" required
                        oninput="this.value = this.value.replace(/\D/g, '');" min="1" max="10">
                </div>

                <div class="item-25">
                    <input placeholder="Note" id="note" name="note" type="text">
                </div>
            </div>
        </form>
        <div class="container-buttons right">                
            <button class="cancel-btn" onclick="closePopups(['add-popup'])">Indietro</button>
            <button id="save-btn" class="save-btn" disabled>Avanti</button><br>
        </div>
    </div>

    <div id="edit-popup" class="modal-content popup">
        <h3>Modifica prenotazione:</h3>
        <form id="edit" class="content form-content" autocomplete="off" oninput="document.querySelector('#edit-popup .save-btn').disabled = !this.checkValidity()">
            <h4>Soggetto</h4>

            <div class="radio">
                <div class="radio-option left">
                  <label class="flexRadio">
                    <input type="radio" id="typeSubject" name="typeSubject" value="CUSTOMER">
                    Cliente
                  </label>
                </div>
                <div class="radio-option right">
                  <label class="flexRadio">
                    <input type="radio" id="typeSubject" name="typeSubject" value="SUPPLIER">
                    Fornitore
                  </label>
                </div>
            </div>

            <div>
                <div class="item">
                    <input id="subject.id" name="subject.id" type="number" class="suggestionId id"
                        oninput="
                            if (this.value != '') {
                                document.querySelector('#edit-popup #subject\\.telephone').disabled = true;
                                document.querySelector('#edit-popup #subject\\.cfpiva').disabled = true;
                            }">
                    <input placeholder="Ragione Sociale" id="subject.social_reason" name="subject.social_reason" type="text"
                        oninput="
                            populateSuggestions('#edit-popup', '#edit #suggestions\\.subject\\.social_reason', 'social_reason', 'subject', this.value);
                            if (document.querySelector('#edit-popup #subject\\.id').value != '') {
                                deselectAnagrafic(document.querySelector('#edit-popup #subject\\.id').value, 'subject');
                                document.querySelector('#edit-popup #subject\\.id').value = '';
                                document.querySelector('#edit-popup #subject\\.telephone').disabled = false;
                                document.querySelector('#edit-popup #subject\\.telephone').value = '';
                                document.querySelector('#edit-popup #subject\\.cfpiva').disabled = false;
                                document.querySelector('#edit-popup #subject\\.cfpiva').value = '';
                            }
                        "
                        onfocus="
                            if (!document.querySelector('#edit-popup #subject\\.id').value) {
                                populateSuggestions('#edit-popup', '#edit #suggestions\\.subject\\.social_reason', 'social_reason', 'subject', this.value);
                            }
                        "
                        onblur="closeSuggestions('#edit-popup', '#edit #suggestions\\.subject\\.social_reason', 'social_reason', 'subject', this.value)">
                    <div id="suggestions.subject.social_reason" class="suggestions"></div>
                </div>
    
                <div class="item-25">
                    <input placeholder="Telefono" id="subject.telephone" name="subject.telephone" type="text" pattern="\d*" oninput="this.value = this.value.replace(/\D/g, '')">
                </div>
                    
                <div class="item-25">
                    <input placeholder="CF/P.Iva" id="subject.cfpiva" name="subject.cfpiva" type="text" pattern="(^[A-Z0-9]{16}$|^\d{11}$)" oninput="this.value = this.value.toUpperCase().replace(/[^A-Z0-9]/g, '')">
                </div>
            </div>

            <hr>

            <h4>Vettore</h4>

            <div>
                <div class="item">
                    <input id="vector.id" name="vector.id" type="number" class="suggestionId id"
                        oninput="
                            if (this.value != '') {
                                document.querySelector('#edit-popup #vector\\.telephone').disabled = true;
                                document.querySelector('#edit-popup #vector\\.cfpiva').disabled = true;
                            }">
                    <input placeholder="Ragione Sociale" id="vector.social_reason" name="vector.social_reason" type="text"
                        oninput="
                            populateSuggestions('#edit-popup', '#edit #suggestions\\.vector\\.social_reason', 'social_reason', 'vector', this.value);
                            if (document.querySelector('#edit-popup #vector\\.id').value != '') {
                                deselectAnagrafic(document.querySelector('#edit-popup #vector\\.id').value, 'vector');
                                document.querySelector('#edit-popup #vector\\.id').value = '';
                                document.querySelector('#edit-popup #vector\\.telephone').disabled = false;
                                document.querySelector('#edit-popup #vector\\.telephone').value = '';
                                document.querySelector('#edit-popup #vector\\.cfpiva').disabled = false;
                                document.querySelector('#edit-popup #vector\\.cfpiva').value = '';
                            }
                        "
                        onfocus="
                            if (!document.querySelector('#edit-popup #vector\\.id').value) {
                                populateSuggestions('#edit-popup', '#edit #suggestions\\.vector\\.social_reason', 'social_reason', 'vector', this.value);
                            }
                        "
                        onblur="closeSuggestions('#edit-popup', '#edit #suggestions\\.vector\\.social_reason', 'social_reason', 'vector', this.value)">
                    <div id="suggestions.vector.social_reason" class="suggestions"></div>
                </div>
    
                <div class="item-25">
                    <input placeholder="Telefono" id="vector.telephone" name="vector.telephone" type="text" pattern="\d*" oninput="this.value = this.value.replace(/\D/g, '');"><br>
                </div>
                    
                <div class="item-25">
                    <input placeholder="CF/P.Iva" id="vector.cfpiva" name="vector.cfpiva" type="text" pattern="(^[A-Z0-9]{16}$|^\d{11}$)" oninput="this.value = this.value.toUpperCase().replace(/[^A-Z0-9]/g, '')"><br>
                </div>
            </div>

            <hr>

            <h4>Autista</h4>

            <div>
                <div class="item-25">
                    <input id="driver.id" name="driver.id" type="number" class="suggestionId id"
                        oninput="
                            if (this.value != '') {
                                document.querySelector('#edit-popup #driver\\.telephone').disabled = true;
                            }                           
                        ">
                    <input placeholder="Nome Cognome" id="driver.social_reason" name="driver.social_reason" type="text"
                        oninput="
                            populateSuggestions('#edit-popup', '#edit #suggestions\\.driver\\.social_reason', 'social_reason', 'driver', this.value);
                            if (document.querySelector('#edit-popup #driver\\.id').value != '') {
                                deselectAnagrafic(document.querySelector('#edit-popup #driver\\.id').value, 'driver');
                                document.querySelector('#edit-popup #driver\\.id').value = '';
                                document.querySelector('#edit-popup #driver\\.telephone').disabled = false;
                                document.querySelector('#edit-popup #driver\\.telephone').value = '';
                            }
                        "
                        onfocus="
                            if (!document.querySelector('#edit-popup #driver\\.id').value) {
                                populateSuggestions('#edit-popup', '#edit #suggestions\\.driver\\.social_reason', 'social_reason', 'driver', this.value);
                            }
                        "
                        onblur="closeSuggestions('#edit-popup', '#edit #suggestions\\.driver\\.social_reason', 'social_reason', 'driver', this.value)">
                    <div id="suggestions.driver.social_reason" class="suggestions"></div>
                </div>
    
                <div class="item-25">
                    <input placeholder="Telefono" id="driver.telephone" name="driver.telephone" type="text" pattern="\d*" 
                        oninput="this.value = this.value.replace(/\D/g, '');">
                </div>
            </div>

            <hr>

            <h4>Veicolo</h4>

            <div>
                <div class="item-25">
                    <input id="vehicle.id" name="vehicle.id" type="number" class="suggestionId id"
                        oninput="
                            if (this.value != '') {
                                document.querySelector('#edit-popup #vehicle\\.description').disabled = true;
                            }
                        ">
                    <input placeholder="Targa" id="vehicle.plate" name="vehicle.plate" type="text" pattern="[A-Za-z]{2}\d{3}[A-Za-z]{2}" required
                        oninput="
                            this.value = this.value.toUpperCase();
                            populateSuggestions('#edit-popup', '#edit #suggestions\\.vehicle\\.plate', 'plate', 'vehicle', this.value);
                            if (document.querySelector('#edit-popup #vehicle\\.id').value != '') {
                                deselectAnagrafic(document.querySelector('#edit-popup #vehicle\\.id').value, 'vehicle');
                                document.querySelector('#edit-popup #vehicle\\.id').value = '';
                                document.querySelector('#edit-popup #vehicle\\.description').disabled = false;
                                document.querySelector('#edit-popup #vehicle\\.description').value = '';
                            }
                        "
                        onfocus="
                            if (!document.querySelector('#edit-popup #vehicle\\.id').value) {
                                populateSuggestions('#edit-popup', '#edit #suggestions\\.vehicle\\.plate', 'plate', 'vehicle', this.value);
                            }
                        "
                        onblur="closeSuggestions('#edit-popup', '#edit #suggestions\\.vehicle\\.plate', 'plate', 'vehicle', this.value)">
                    <div id="suggestions.vehicle.plate" class="suggestions"></div>
                </div>
    
                <div class="item-25">
                    <input placeholder="Descrizione" id="vehicle.description" name="vehicle.description" type="text">
                </div>
            </div>

            <hr>

            <div>
                <div class="item-25">
                    <input placeholder="Numero pesate" id="number_weighings" name="number_weighings" type="number" pattern="\d*" required
                        oninput="this.value = this.value.replace(/\D/g, '');" min="1" max="10">
                </div>

                <div class="item-25">
                    <input placeholder="Note" id="note" name="note" type="text">
                </div>
            </div>
        </form>
        <div class="container-buttons right">                
            <button class="cancel-btn" onclick="closePopups(['edit-popup'])">Indietro</button>
            <button id="save-btn" class="save-btn" disabled>Avanti</button><br>
        </div>
    </div>

    <div id="delete-popup" class="modal-content popup">
        <div id="delete">
            <h3>Elimina ragione sociale:</h3>
            <p><b>Tipo soggetto:</b> <u><em><span id="typeSubject"></span></em></u></p>
            <p><b>Soggetto:</b> <u><em><span id="subject.social_reason"></span></em></u></p>
            <p><b>Vettore:</b> <u><em><span id="vector.social_reason"></span></em></u></p>
            <p><b>Autista:</b> <u><em><span id="driver.social_reason"></span></em></u></p>
            <p><b>Targa:</b> <u><em><span id="vehicle.plate"></span></em></u></p>
            <p><b>Stato:</b> <u><em><span id="status"></span></em></u></p>
            <p><b>Numero pesate:</b> <u><em><span id="number_weighings"></span></em></u></p>
            <div class="container-buttons right">                
                <button class="cancel-btn" onclick="closePopups(['delete-popup'])">Annulla</button>
                <button id="save-btn" class="delete-save-btn">Elimina</button><br>
            </div>
        </div>
    </div>

    <div id="confirm-popup" class="modal-content popup">
        <h3 id="confirm-title"></h3>
        <span id="confirm-content"></span>
        <div class="container-buttons right">                
            <button class="cancel-btn" onclick="closePopups(['confirm-popup'])">Annulla</button>
            <button id="save-btn" class="confirm-btn">Ok</button><br>
        </div>
    </div>

    <!-- Snackbar -->
    <div id="snackbar"></div>

    <script type="module" src="/static/javascript/auth.js"></script>
    <script type="module" src="/static/javascript/interceptor.js"></script>
    <script src="/static/javascript/navbar.js"></script>
    <script src="/static/javascript/snackbar.js"></script>
    <script src="/static/javascript/dynamic-table.js"></script>
    <script>
        const fromDate = document.querySelector('#filter\\.fromDate');
        const toDate = document.querySelector('#filter\\.toDate');

        document.addEventListener("DOMContentLoaded", () => {
            itemName = 'reservation';
            lastChar = 'a';
            canAlwaysDelete = true;
            listUrlPath = '/anagrafic/reservation/list';
            addUrlPath = '/anagrafic/reservation';
            setUrlPath = '/anagrafic/reservation';
            deleteUrlPath = '/anagrafic/reservation';
            websocketUrlPath = '/anagrafic/reservation';
            callback_populate_select = populateForm;
            callback_close_popups = deselectAllAnagrafic;
            populate_detail_tr = populateDetailTr;
            params = {
                "prenotazione con targa": "reservation.vehicle.plate",
                "soggetto": "subject.social_reason",
                "vettore": "vector.social_reason",
                "autista": "driver.social_reason",
                "veicolo con targa": "vehicle.plate",
                "veicolo con descrizione": "vehicle.description",
                "materiale": "material.description",
                "pesata con il veicolo": "weighing.vehicle.plate"
            }
            init();
        });

        flatpickr("#dateRange", {
            locale: {
                rangeSeparator: ' / '
            },
            mode: 'range',
            // allowInput: true,
            dateFormat: "d-m-Y", // Formato della data
            onClose: function(selectedDates, dateStr, instance) {
                document.querySelector('#dateRange').setSelectionRange(0, 0);
                const firstDay = selectedDates[0];
                let secondDay = selectedDates[1];
                // Verifica se una data è selezionata o meno
                if (firstDay && secondDay === undefined) {
                    secondDay = new Date(Date.now());
                    secondDay.setHours(12, 0, 0, 0);
                } else if (selectedDates.length === 2 && firstDay == secondDay) {
                    secondDay.setHours(12, 0, 0, 0);
                }
                // Imposta l'istanza flatpickr con le date selezionate
                instance.setDate([firstDay, secondDay]);
                const adjustedFirstDay = new Date(firstDay);
                adjustedFirstDay.setHours(12, 0, 0, 0);
                const adjustedSecondDay = new Date(secondDay);
                adjustedSecondDay.setHours(12, 0, 0, 0);
                fromDate.valueAsDate = adjustedFirstDay;
                toDate.valueAsDate = adjustedSecondDay;
                updateTable();
            }
        });

        function populateForm(idForm, item={typeSocialReason: 0, idSocialReason: null, idVector: null, idVehicle: null, idMaterial: null}) {
            if (idForm !== '#delete') {
            }
        }

        // function highlightText(suggestion, input, filter) {
        //     const regex = new RegExp(`(${input})`, 'gi'); // Regex per evidenziare
        //     return suggestion[filter] ? suggestion[filter].replace(regex, `<span class="highlight">$1</span>`) : '';
        // }

        function highlightText(suggestion, input, filter) {
            // Creiamo un'espressione regolare che cerca l'input solo all'inizio della stringa
            const regex = new RegExp(`^(${input})`, 'i');
            if (suggestion[filter]) {
                // Se c'è una corrispondenza all'inizio, evidenziala
                if (regex.test(suggestion[filter])) {
                    return suggestion[filter].replace(regex, '<span class="highlight">$1</span>');
                }
                // Altrimenti, restituisci la stringa originale senza evidenziazioni
                return suggestion[filter];
            }
            return '';
        }

        function deleteLastWeighing(idReservation, plate, weighing, pid, bil) {
            confirm_exec_funct = () => {
                fetch(`/anagrafic/reservation/last-weighing/${idReservation}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(res => res.json())
                .catch(error => console.error(error));
            }
            document.querySelector('#confirm-title').textContent = "Attenzione!";
            document.querySelector('#confirm-content').innerHTML = `
                Sei sicuro di voler eliminare l'ultima pesata effettuata dal veicolo '${plate}'?'.
                <br><br>
                <h4><u>Dettagli pesata</u></h4>
                <br>
                <b>Peso:</b> <em><u>${weighing}</u></em>
                <br><br>
                <b>PID:</b> <em><u>${pid}</u></em>
                <br><br>
                <b>Bilancia:</b> <em><u>${bil}</u></em>
            `;
            openPopup('confirm-popup');
        }

        function populateDetailTr(item) {
            let content = `<ul class="list-detail-tr">`;
            let lengthWighings = item.weighings.length;
            item.weighings.reverse().forEach(weighing => {
                if (lengthWighings === item.weighings.length) {
                    // Pulsante Elimina
                    const deleteWeighingButton = document.createElement("button");
                    deleteWeighingButton.style.visibility = 'hidden';
                    deleteWeighingButton.textContent = "🗑️";
                    deleteWeighingButton.onclick = (e) => {
                        e.preventDefault();
                    };
                    console.log(item.vehicle.plate);
                    content += `
                        <li>
                            <em><strong>${weighing.weight} kg</strong></em>, 
                            <em>Pid: ${weighing.pid}</em>, 
                            <em>Pesa: ${weighing.weigher}</em>
                            <button>📥</button>
                            <button onclick="deleteLastWeighing(${item.id}, '${item.vehicle.plate}', '${weighing.weight}', '${weighing.pid}', '${weighing.weigher}')">🗑️</button>
                        </li>`;
                } else {
                    content += `
                        <li>
                            <em><strong>${weighing.weight} kg</strong></em>,
                            <em>Pid: ${weighing.pid}</em>,
                            <em>Pesa: ${weighing.weigher}</em>
                            <button>📥</button>
                        </li>`;
                }
                lengthWighings--;
            })
            content += `</ul>`;
            return content;
        }

        function populateSuggestions(popup, suggestions, key, anagrafic, value) {
            let currentSuggestions = document.querySelector(suggestions);
            fetch(`/anagrafic/${anagrafic}/list?${key}=${value}%`)
            .then(res => res.json())
            .then(res => {
                currentSuggestions.innerHTML = '';
                res.data.forEach(item => {
                    const option = document.createElement('p');
                    option.innerHTML = highlightText(item, value, key);
                    option.id = item.id;
                    option.dataset.item = JSON.stringify(item);
                    option.onmousedown = (e) => {
                        let callback_select_anagrafic;
                        if (anagrafic === 'subject') {
                            callback_select_anagrafic = () => {
                                document.querySelector(`${popup} #subject\\.id`).value = item.id;
                                document.querySelector(`${popup} #subject\\.social_reason`).value = item.social_reason;
                                document.querySelector(`${popup} #subject\\.telephone`).value = item.telephone;
                                document.querySelector(`${popup} #subject\\.telephone`).disabled = true;
                                document.querySelector(`${popup} #subject\\.cfpiva`).value = item.cfpiva;
                                document.querySelector(`${popup} #subject\\.cfpiva`).disabled = true;
                                document.querySelector(`${popup} .save-btn`).disabled = !document.querySelector(`${popup} form`).checkValidity();
                            }
                        } else if (anagrafic === 'vector') {
                            callback_select_anagrafic = () => {
                                document.querySelector(`${popup} #vector\\.id`).value = item.id;
                                document.querySelector(`${popup} #vector\\.social_reason`).value = item.social_reason;
                                document.querySelector(`${popup} #vector\\.telephone`).value = item.telephone;
                                document.querySelector(`${popup} #vector\\.telephone`).disabled = true;
                                document.querySelector(`${popup} #vector\\.cfpiva`).value = item.cfpiva;
                                document.querySelector(`${popup} #vector\\.cfpiva`).disabled = true;
                                document.querySelector(`${popup} .save-btn`).disabled = !document.querySelector(`${popup} form`).checkValidity();
                            }
                        } else if (anagrafic === 'driver') {
                            callback_select_anagrafic = () => {
                                document.querySelector(`${popup} #driver\\.id`).value = item.id;
                                document.querySelector(`${popup} #driver\\.social_reason`).value = item.social_reason;
                                document.querySelector(`${popup} #driver\\.telephone`).value = item.telephone;                            
                                document.querySelector(`${popup} #driver\\.telephone`).disabled = true;
                                document.querySelector(`${popup} .save-btn`).disabled = !document.querySelector(`${popup} form`).checkValidity();
                            }
                        } else if (anagrafic === 'vehicle') {
                            callback_select_anagrafic = () => {
                                document.querySelector(`${popup} #vehicle\\.id`).value = item.id;
                                document.querySelector(`${popup} #vehicle\\.plate`).value = item.plate;
                                document.querySelector(`${popup} #vehicle\\.description`).value = item.description;
                                document.querySelector(`${popup} #vehicle\\.description`).disabled = true;
                                document.querySelector(`${popup} .save-btn`).disabled = !document.querySelector(`${popup} form`).checkValidity();
                            }
                        }
                        if (callback_select_anagrafic) selectAnagrafic(item.id, "SELECT", anagrafic, callback_select_anagrafic);
                    };
                    currentSuggestions.appendChild(option);  
                });
                currentSuggestions.style.display = 'block';
            });
        }        

        function closeSuggestions(popup, suggestions, key, anagrafic, value) {
            const currentSuggestions = document.querySelector(suggestions);
            currentSuggestions.style.display = 'none';
            const options = currentSuggestions.querySelectorAll('p');
            let continues = false;
            if (options.length === 1) {
                const item = JSON.parse(options[0].dataset.item);
                if (item[key].toLowerCase() == value.toLowerCase()) {
                    let callback_select_anagrafic;
                    if (anagrafic === 'subject' && document.querySelector(`${popup} #subject\\.id`).value != item.id) {
                        callback_select_anagrafic = () => {
                            document.querySelector(`${popup} #subject\\.id`).value = item.id;
                            document.querySelector(`${popup} #subject\\.social_reason`).value = item.social_reason;
                            document.querySelector(`${popup} #subject\\.telephone`).value = item.telephone;
                            document.querySelector(`${popup} #subject\\.telephone`).disabled = true;
                            document.querySelector(`${popup} #subject\\.cfpiva`).value = item.cfpiva;
                            document.querySelector(`${popup} #subject\\.cfpiva`).disabled = true;
                        }
                    } else if (anagrafic === 'vector' && document.querySelector(`${popup} #vector\\.id`).value != item.id) {
                        callback_select_anagrafic = () => {
                            document.querySelector(`${popup} #vector\\.id`).value = item.id;
                            document.querySelector(`${popup} #vector\\.social_reason`).value = item.social_reason;
                            document.querySelector(`${popup} #vector\\.telephone`).value = item.telephone;
                            document.querySelector(`${popup} #vector\\.telephone`).disabled = true;
                            document.querySelector(`${popup} #vector\\.cfpiva`).value = item.cfpiva;
                            document.querySelector(`${popup} #vector\\.cfpiva`).disabled = true;
                        }
                    } else if (anagrafic === 'driver' && document.querySelector(`${popup} #driver\\.id`).value != item.id && document.querySelector(`${popup} #driver\\.telephone`).value === item.telephone) {
                        callback_select_anagrafic = () => {
                            document.querySelector(`${popup} #driver\\.id`).value = item.id;
                            document.querySelector(`${popup} #driver\\.social_reason`).value = item.social_reason;
                            document.querySelector(`${popup} #driver\\.telephone`).value = item.telephone;                            
                            document.querySelector(`${popup} #driver\\.telephone`).disabled = true;
                            document.querySelector(`${popup} .save-btn`).disabled = !document.querySelector(`${popup} form`).checkValidity();
                        }
                    } else if (anagrafic === 'vehicle' && document.querySelector(`${popup} #vehicle\\.id`).value != item.id) {
                        callback_select_anagrafic = () => {
                            document.querySelector(`${popup} #vehicle\\.id`).value = item.id;
                            document.querySelector(`${popup} #vehicle\\.plate`).value = item.plate;
                            document.querySelector(`${popup} #vehicle\\.description`).value = item.description;
                            document.querySelector(`${popup} #vehicle\\.description`).disabled = true;
                            document.querySelector(`${popup} .save-btn`).disabled = !document.querySelector(`${popup} form`).checkValidity();
                        }
                    }
                    if (callback_select_anagrafic) selectAnagrafic(item.id, "SELECT", anagrafic, callback_select_anagrafic);
                }
            }
        }

        function deselectAllAnagrafic() {
            document.querySelectorAll('#subject\\.id').forEach(input => {
                if (input.value != '') deselectAnagrafic(input.value, "subject");
            });
            document.querySelectorAll('#vector\\.id').forEach(input => {
                if (input.value != '') deselectAnagrafic(input.value, "vector");
            });
            document.querySelectorAll('#driver\\.id').forEach(input => {
                if (input.value != '') deselectAnagrafic(input.value, "driver");
            });
            document.querySelectorAll('#vehicle\\.id').forEach(input => {
                if (input.value != '') deselectAnagrafic(input.value, "vehicle");
            });
        }
    </script>
</body>
</html>