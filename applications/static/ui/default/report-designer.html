<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Report Designer - {{ type }}</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: cornflowerblue;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1450px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: #1362b8;
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
        }

        .toolbar {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .btn-primary {
            background: white;
            color: #667eea;
        }

        .btn-secondary {
            background: rgba(255,255,255,0.2);
            color: white;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .main-container {
            display: flex;
            height: calc(100vh - 140px);
        }

        .sidebar {
            width: 250px;
            background: aliceblue;
            padding: 20px;
            border-right: 1px solid #dee2e6;
            overflow-y: auto;
        }

        .sidebar h3 {
            font-size: 14px;
            text-transform: uppercase;
            color: #6c757d;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .page-global-settings {
            background: white;
            border-radius: 8px;
            padding: 15px;
            border: 1px solid #dee2e6;
            margin-bottom: 20px;
        }

        .format-selector {
            margin-bottom: 20px;
        }

        .format-selector select {
            width: 100%;
            padding: 8px;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            font-size: 14px;
        }

        .zoom-controls button {
            color: #6c757d;
            background: #ffffff;
            border: 1px solid #dee2e6;
        }

        .component-item {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            cursor: move;
            transition: all 0.3s ease;
            text-align: center;
            font-size: 14px;
        }

        .component-item:hover {
            border-color: #667eea;
            transform: translateX(5px);
            box-shadow: 0 3px 10px rgba(102, 126, 234, 0.2);
        }

        .component-item i {
            display: block;
            font-size: 24px;
            margin-bottom: 5px;
            color: #667eea;
        }

        .design-area {
            width: fit-content;
            flex: 1;
            padding: 20px;
            background: #ffffff;
            overflow: auto;
        }

        .canvas-container {
            width: fit-content;
            background: white;
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            position: relative;
            transform-origin: top left;
            transition: transform 0.3s ease;
            margin-left: auto;
            margin-right: auto;
        }

        .pages-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .page-wrapper {
            position: relative;
            background: white;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            page-break-after: always;
        }

        .page-number {
            position: absolute;
            bottom: -30px;
            left: 50%;
            transform: translateX(-50%);
            background: #667eea;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .margin-controls {
            margin-bottom: 20px;
        }

        .margin-input-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }

        .margin-input-group input {
            width: 100%;
            padding: 6px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            font-size: 12px;
        }

        .new-page-indicator {
            border-top: 3px dashed #667eea;
            margin-top: 20px;
            padding-top: 20px;
            position: relative;
        }

        .new-page-indicator::before {
            content: "Nuova Pagina";
            position: absolute;
            top: -12px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 0 10px;
            color: #667eea;
            font-size: 11px;
            font-weight: 600;
        }

        .canvas {
            min-height: 100%;
            background: white;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            margin: 0 auto;
            position: relative;
        }

        .canvas.A4 {
            width: 210mm;
            height: 297mm;
            padding: 25mm;
            font-size: 12pt;
        }

        .canvas.A5 {
            width: 148mm;
            height: 210mm;
            padding: 15mm;
            font-size: 11pt;
        }

        .canvas.A6 {
            width: 105mm;
            height: 148mm;
            padding: 10mm;
            font-size: 10pt;
        }

        .canvas.A7 {
            width: 74mm;
            height: 105mm;
            padding: 8mm;
            font-size: 9pt;
        }

        .canvas.A8 {
            width: 52mm;
            height: 74mm;
            padding: 6mm;
            font-size: 8pt;
        }

        .canvas.Receipt80 {
            width: 80mm;
            height: fit-content;
            min-height: 10mm;
            padding: 5mm;
            font-size: 9pt;
            background: white;
        }

        .canvas.Custom {
            min-height: 100%;
            padding: 3mm;
            font-size: 11pt;
            background: white;
        }

        .canvas::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            border: 1px dashed #667eea;
            opacity: 0.3;
        }

        .canvas::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            border-top: 1px dashed #667eea;
            opacity: 0.3;
            pointer-events: none;
        }

        .canvas .vertical-guide {
            position: absolute;
            top: 0;
            bottom: 0;
            left: 50%;
            border-left: 1px dashed #667eea;
            opacity: 0.3;
            pointer-events: none;
        }

        .dropped-element {
            border: none;
            position: relative;
            transition: all 0.3s ease;
        }

        .dropped-element:hover {
            border: 1px dashed #667eea;
            background: rgba(102, 126, 234, 0.05);
        }

        .dropped-element.selected {
            border: 2px solid #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        .canvas .dropped-element table {
            font-size: inherit;
            table-layout: fixed;
        }

        .canvas .dropped-element table th,
        .canvas .dropped-element table td {
            padding: 2mm 3mm;
            white-space: nowrap;
            overflow: hidden;
        }

        img {
            border: 1px dashed #ccc;
        }

        .canvas.A8 .dropped-element table th,
        .canvas.A8 .dropped-element table td,
        .canvas.A7 .dropped-element table th,
        .canvas.A7 .dropped-element table td {
            padding: 1mm 2mm;
            font-size: 0.9em;
        }

        .canvas.Receipt80 .dropped-element table th,
        .canvas.Receipt80 .dropped-element table td {
            padding: 1mm 2mm;
            font-size: 0.95em;
        }

        .table-cell-selected {
            background: rgba(102, 126, 234, 0.2) !important;
            outline: 2px solid #667eea !important;
        }

        .element-controls {
            position: absolute;
            top: -30px;
            right: 0;
            display: none;
            gap: 5px;
        }

        .dropped-element.selected .element-controls {
            display: flex;
        }

        .control-btn {
            width: 25px;
            height: 25px;
            border: none;
            background: #667eea;
            color: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .control-btn:hover {
            background: #764ba2;
        }

        .properties-panel {
            width: 300px;
            background: aliceblue;
            padding: 20px;
            border-left: 1px solid #dee2e6;
            overflow-y: auto;
        }

        .property-group {
            margin-bottom: 15px;
        }

        .property-group label {
            display: block;
            font-size: 12px;
            color: #6c757d;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .header select {
            border: 1px solid #dee2e6;
            border-radius: 6px;
            font-size: 14px;
        }

        .property-group input,
        .property-group select,
        .property-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            font-size: 14px;
        }

        .property-group textarea {
            min-height: 60px;
            resize: vertical;
        }

        .jinja-section {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border: 1px solid #90caf9;
        }

        .jinja-section h4 {
            margin: 0 0 10px 0;
            color: #1976d2;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .input-group {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
        }

        .input-group input {
            flex: 1;
        }

        .dragging {
            opacity: 0.5;
        }

        .drag-over {
            background: rgba(102, 126, 234, 0.1);
            border: 2px dashed #667eea;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            position: relative;
            background: white;
            margin: 50px auto;
            padding: 30px;
            width: 90%;
            max-width: 800px;
            border-radius: 12px;
            max-height: 80vh;
            overflow-y: auto;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            color: #333;
        }

        .close-modal {
            font-size: 28px;
            cursor: pointer;
            color: #999;
            border: none;
            background: none;
        }

        .close-modal:hover {
            color: #333;
        }

        .code-output {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 400px;
            overflow-y: auto;
        }

        .copy-btn, .download-btn {
            margin-top: 15px;
            background: #667eea;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
        }

        .copy-btn:hover, .download-btn:hover {
            background: #764ba2;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .jinja-variable {
            background: #e3f2fd;
            border: 1px solid #90caf9;
            color: #1976d2;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
        }

        .jinja-loop {
            background: #f3e5f5;
            border: 1px solid #ce93d8;
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
        }

        .jinja-condition {
            background: #e8f5e9;
            border: 1px solid #81c784;
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
        }

        @media (max-width: 1200px) {
            .properties-panel {
                width: 250px;
            }
        }

        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
            }
            
            .sidebar, .properties-panel {
                width: 100%;
                border: none;
            }
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
    </style>
</head>
<body onclick="selectElement()">
    <div class="container">
        <div class="header">
            <h1>üìÑ Report Designer - {{ type }}</h1>
            <div class="toolbar">
                <button class="btn btn-primary" onclick="loadDefaultTemplate('{{ default_report_template }}')">Ripristina ultimo salvato</button>
                <select id="defaultReportSelect" onfocus="populateTemplates('{{ type_default_report }}')" onchange="loadDefaultTemplate(this.value)">
                    <option>--Template di default--</option>
                </select>
                <button class="btn btn-primary" onclick="previewReport()">üëÅÔ∏è Anteprima</button>
                <button class="btn btn-primary" onclick="showCode()" style="display: none;">üìù Mostra Codice</button>
                <button class="btn btn-primary" onclick="saveProject('{{ report }}')">üíæ Salva</button>
                <button class="btn btn-primary" onclick="downloadProjectLocal()">üì• Download</button>
                <button class="btn btn-primary" onclick="importProject()">üì• Importa</button>
            </div>
        </div>

        <div class="main-container">
            <div class="sidebar">
                <div class="page-global-settings">
                    <div class="format-selector">
                        <h3>Formato Pagina</h3>
                        <select id="pageFormat" onchange="changePageFormat()">
                            <option value="A4">A4 (210 √ó 297 mm)</option>
                            <option value="A5">A5 (148 √ó 210 mm)</option>
                            <option value="A6">A6 (105 √ó 148 mm)</option>
                            <option value="A7">A7 (74 √ó 105 mm)</option>
                            <option value="A8">A8 (52 √ó 74 mm)</option>
                            <option value="Receipt80">Scontrino 80mm (80 √ó ‚àû)</option>
                            <option value="Custom">üìê Personalizzato</option>
                        </select>
                    </div>

                    <div id="customSizeSection" style="display: none; margin-top: 15px;">
                        <h3>Dimensioni Custom (mm)</h3>
                        <div class="margin-input-group">
                            <div>
                                <label style="font-size: 11px; color: #6c757d;">Larghezza</label>
                                <input type="number" id="customWidth" value="" min="50" max="500" placeholder="auto" onchange="applyCustomSize()">
                            </div>
                            <div>
                                <label style="font-size: 11px; color: #6c757d;">Altezza</label>
                                <input type="number" id="customHeight" value="" min="50" max="1000" placeholder="auto" onchange="applyCustomSize()">
                            </div>
                        </div>
                        <small style="color: #666; display: block; margin-top: 5px; font-size: 11px;">Lascia vuoto per dimensione automatica</small>
                    </div>

                    <div class="margin-controls">
                        <h3>Margini (mm)</h3>
                        <div class="margin-input-group">
                            <div>
                                <label style="font-size: 11px; color: #6c757d;">Superiore</label>
                                <input type="number" id="marginTop" value="25" min="0" max="50" onchange="updatePageMargins()">
                            </div>
                            <div>
                                <label style="font-size: 11px; color: #6c757d;">Inferiore</label>
                                <input type="number" id="marginBottom" value="25" min="0" max="50" onchange="updatePageMargins()">
                            </div>
                            <div>
                                <label style="font-size: 11px; color: #6c757d;">Sinistro</label>
                                <input type="number" id="marginLeft" value="25" min="0" max="50" onchange="updatePageMargins()">
                            </div>
                            <div>
                                <label style="font-size: 11px; color: #6c757d;">Destro</label>
                                <input type="number" id="marginRight" value="25" min="0" max="50" onchange="updatePageMargins()">
                            </div>
                        </div>
                        <div class="property-group" style="margin-top: 15px;">
                            <h3>Font Globale</h3>
                            <select id="globalFont" onchange="updateGlobalFont(this.value)">
                                <option value="Arial, sans-serif">Arial</option>
                                <option value="'Times New Roman', serif">Times New Roman</option>
                                <option value="'Courier New', monospace">Courier New</option>
                                <option value="Verdana, sans-serif">Verdana</option>
                                <option value="Georgia, serif">Georgia</option>
                            </select>
                        </div>
                    </div>

                    <div class="zoom-controls">
                        <h3>Zoom</h3>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <button class="btn btn-secondary btn-small" style="flex: 1;" onclick="changeZoom(-10)">-</button>
                            <span id="zoomDisplay" style="flex: 1;">100%</span>
                            <button class="btn btn-secondary btn-small" style="flex: 1;" onclick="changeZoom(10)">+</button>
                        </div>
                        <button class="btn btn-secondary btn-small" onclick="resetZoom()" style="margin-top: 5px; width: 100%;">Reset</button>
                    </div>
                </div>

                <h3>Componenti Base</h3>
                <div class="component-item" draggable="true" data-type="heading">
                    <i>üìù</i>
                    Intestazione
                </div>
                <div class="component-item" draggable="true" data-type="paragraph">
                    <i>üìÑ</i>
                    Paragrafo
                </div>
                <div class="component-item" draggable="true" data-type="table">
                    <i>üìä</i>
                    Tabella
                </div>
                <div class="component-item" draggable="true" data-type="image">
                    <i>üñºÔ∏è</i>
                    Immagine
                </div>
                <div class="component-item" draggable="true" data-type="carousel">
                    <i>üé†</i>
                    Carosello
                </div>
                <div class="component-item" draggable="true" data-type="divider">
                    <i>‚ûñ</i>
                    Separatore
                </div>
            </div>

            <div class="design-area">
                <div class="canvas-container">
                    <div id="pagesContainer" class="pages-container">
                        <div class="page-wrapper">
                            <div id="canvas" class="canvas A4" data-page-number="1">
                                <div class="vertical-guide"></div>
                            </div>
                            <span class="page-number">Pagina 1</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="properties-panel" onclick="event.stopPropagation()">
                <h3>Propriet√†</h3>
                <div id="propertiesContent">
                    <p style="color: #999; text-align: center; margin-top: 20px;">
                        Seleziona un elemento per modificarne le propriet√†
                    </p>
                </div>
            </div>
        </div>
    </div>

    <div id="codeModal" class="modal" onclick="closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2>Template HTML/Jinja2</h2>
                <span class="close-modal" onclick="closeModal()">&times;</span>
            </div>
            <div class="code-output" id="codeOutput"></div>
            <div class="modal-buttons">
                <button class="copy-btn" onclick="copyCode()">üìã Copia Codice</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script type="module" src="/static/javascript/auth.js"></script>
    <script type="module" src="/static/javascript/interceptor.js"></script>
    <script>
        let selectedElement = null;
        let selectedTableCell = null;
        let elementCounter = 0;
        let currentZoom = 100;
        let currentPage = 1;
        let totalPages = 1;
        let pageHeights = {
            'A4': 297,
            'A5': 210,
            'A6': 148,
            'A7': 105,
            'A8': 74,
            'Receipt80': null,
            'Custom': null
        };

        let globalFont = "Arial, sans-serif";
        
        // Memorizza formato e padding del file importato
        let importedFileFormat = null;
        let importedFilePadding = null;
        let importedCustomSize = null;

        document.addEventListener('DOMContentLoaded', () => {
            loadDefaultTemplate('{{ default_report_template }}', false);
        });

        function getEffectiveColumnCount(row) {
            let totalCols = 0;
            row.querySelectorAll('th, td').forEach(cell => {
                const colspan = parseInt(cell.getAttribute('colspan') || cell.getAttribute('data-colspan') || '1');
                totalCols += colspan;
            });
            return totalCols;
        }

        function getAvailablePageHeight(pageElement) {
            const format = document.getElementById('pageFormat').value;
            if (format === 'Receipt80') return Infinity;
            
            let pageHeightMm;
            if (format === 'Custom') {
                const customHeightInput = document.getElementById('customHeight').value.trim();
                if (customHeightInput === '') return Infinity;
                pageHeightMm = parseInt(customHeightInput) || 297;
            } else {
                pageHeightMm = pageHeights[format];
            }
            
            const marginTop = parseInt(document.getElementById('marginTop').value) || 25;
            const marginBottom = parseInt(document.getElementById('marginBottom').value) || 25;
            
            const mmToPx = 3.78;
            const availableHeight = (pageHeightMm - marginTop - marginBottom) * mmToPx;
            
            return availableHeight;
        }

        function calculatePageContentHeight(pageElement) {
            const elements = pageElement.querySelectorAll('.dropped-element');
            let totalHeight = 0;
            
            elements.forEach(element => {
                const rect = element.getBoundingClientRect();
                const styles = window.getComputedStyle(element);
                const marginTop = parseFloat(styles.marginTop) || 0;
                const marginBottom = parseFloat(styles.marginBottom) || 0;
                totalHeight += rect.height + marginTop + marginBottom;
            });
            
            return totalHeight;
        }

        function canAddElement(pageElement, newElementHeight = 100) {
            const format = document.getElementById('pageFormat').value;
            if (format === 'Receipt80') return true;
            
            const currentHeight = calculatePageContentHeight(pageElement);
            const availableHeight = getAvailablePageHeight(pageElement);
            
            return (currentHeight + newElementHeight) <= availableHeight;
        }

        function createNewPage() {
            totalPages++;
            const pagesContainer = document.getElementById('pagesContainer');
            const format = document.getElementById('pageFormat').value;
            
            const newPageWrapper = document.createElement('div');
            newPageWrapper.className = 'page-wrapper';
            newPageWrapper.dataset.page = totalPages;
            
            const newPage = document.createElement('div');
            newPage.id = `canvas-page-${totalPages}`;
            newPage.className = `canvas ${format}`;
            newPage.dataset.pageNumber = totalPages;
            
            if (format === 'Custom') {
                const widthInput = document.getElementById('customWidth').value.trim();
                const heightInput = document.getElementById('customHeight').value.trim();
                
                newPage.style.width = widthInput === '' ? 'auto' : (parseInt(widthInput) + 'mm');
                newPage.style.height = heightInput === '' ? 'auto' : (parseInt(heightInput) + 'mm');
            } else {
                newPage.style.width = '';
                newPage.style.height = '';
            }
            
            updatePageMarginsForElement(newPage);
            
            const pageIndicator = document.createElement('div');
            pageIndicator.className = 'new-page-indicator';
            pageIndicator.style.display = 'none';
            newPage.appendChild(pageIndicator);
            
            const pageNumber = document.createElement('span');
            pageNumber.className = 'page-number';
            pageNumber.textContent = `Pagina ${totalPages}`;
            
            const verticalGuide = document.createElement('div');
            verticalGuide.className = 'vertical-guide';
            newPage.appendChild(verticalGuide);
            
            newPageWrapper.appendChild(newPage);
            newPageWrapper.appendChild(pageNumber);
            pagesContainer.appendChild(newPageWrapper);
            
            newPage.addEventListener('dragover', handleDragOver);
            newPage.addEventListener('drop', handleDrop);
            newPage.addEventListener('dragleave', handleDragLeave);
            
            return newPage;
        }

        function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }
            e.preventDefault();
            
            const canvas = e.currentTarget;
            canvas.classList.remove('drag-over');
            
            const componentType = e.dataTransfer.getData('componentType');
            
            // Aggiungi semplicemente l'elemento senza controlli
            addElement(componentType, canvas);
            
            return false;
        }

        function redistributeElements() {
            const format = document.getElementById('pageFormat').value;
            if (format === 'Receipt80') return;
            
            const allPages = document.querySelectorAll('.canvas');
            const allElements = [];
            
            allPages.forEach(page => {
                const elements = page.querySelectorAll('.dropped-element');
                elements.forEach(el => {
                    allElements.push(el.cloneNode(true));
                    el.remove();
                });
            });
            
            let currentPageIndex = 0;
            let currentPage = allPages[currentPageIndex];
            
            allElements.forEach(element => {
                if (!canAddElement(currentPage, element.offsetHeight)) {
                    currentPageIndex++;
                    if (currentPageIndex >= allPages.length) {
                        currentPage = createNewPage();
                    } else {
                        currentPage = allPages[currentPageIndex];
                    }
                }
                
                currentPage.appendChild(element);
                makeElementInteractive(element);
            });
            
            for (let i = allPages.length - 1; i > 0; i--) {
                if (allPages[i].querySelectorAll('.dropped-element').length === 0) {
                    allPages[i].closest('.page-wrapper').remove();
                    totalPages--;
                }
            }
            
            if (format !== 'Custom') {
                document.querySelectorAll('.canvas').forEach(page => {
                    page.style.width = '';
                    page.style.height = '';
                });
            }
        }

        function updatePageMargins() {
            const marginTop = document.getElementById('marginTop').value + 'mm';
            const marginBottom = document.getElementById('marginBottom').value + 'mm';
            const marginLeft = document.getElementById('marginLeft').value + 'mm';
            const marginRight = document.getElementById('marginRight').value + 'mm';
            
            const allPages = document.querySelectorAll('.canvas');
            allPages.forEach(page => {
                page.style.paddingTop = marginTop;
                page.style.paddingBottom = marginBottom;
                page.style.paddingLeft = marginLeft;
                page.style.paddingRight = marginRight;
            });
        }

        function updatePageMarginsForElement(element) {
            const marginTop = document.getElementById('marginTop').value + 'mm';
            const marginBottom = document.getElementById('marginBottom').value + 'mm';
            const marginLeft = document.getElementById('marginLeft').value + 'mm';
            const marginRight = document.getElementById('marginRight').value + 'mm';
            
            element.style.paddingTop = marginTop;
            element.style.paddingBottom = marginBottom;
            element.style.paddingLeft = marginLeft;
            element.style.paddingRight = marginRight;
        }

        function showNotification(message, isError = false, isPersistent = false) {
            const existingPersistent = document.querySelector('.notification-persistent');
            if (existingPersistent) {
                existingPersistent.remove();
            }
            
            const notification = document.createElement('div');
            notification.className = isPersistent ? 'notification-persistent' : '';
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${isError ? '#e74c3c' : '#667eea'};
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                z-index: 10000;
                animation: slideIn 0.3s ease;
                display: flex;
                align-items: center;
                gap: 10px;
            `;
            
            if (isPersistent) {
                const spinner = document.createElement('div');
                spinner.style.cssText = `
                    width: 16px;
                    height: 16px;
                    border: 2px solid rgba(255,255,255,0.3);
                    border-top-color: white;
                    border-radius: 50%;
                    animation: spin 0.6s linear infinite;
                `;
                notification.appendChild(spinner);
            }
            
            const messageSpan = document.createElement('span');
            messageSpan.textContent = message;
            notification.appendChild(messageSpan);
            
            document.body.appendChild(notification);
            
            if (!isPersistent) {
                setTimeout(() => {
                    notification.style.animation = 'fadeOut 0.3s ease';
                    setTimeout(() => notification.remove(), 300);
                }, 3000);
            }
            
            return notification;
        }

        function changePageFormat(preserveMargins = false) {
            const format = document.getElementById('pageFormat').value;
            const allPages = document.querySelectorAll('.canvas');
            const customSection = document.getElementById('customSizeSection');
            
            if (format === 'Custom') {
                customSection.style.display = 'block';
                
                if (importedFileFormat === 'Custom' && importedCustomSize !== null) {
                    document.getElementById('customWidth').value = importedCustomSize.width || '';
                    document.getElementById('customHeight').value = importedCustomSize.height || '';
                }
                
                applyCustomSize();
            } else {
                customSection.style.display = 'none';
                allPages.forEach(page => {
                    page.className = `canvas ${format}`;
                    page.style.width = '';
                    page.style.height = '';
                });
            }
            
            if (importedFileFormat === format && importedFilePadding !== null) {
                document.getElementById('marginTop').value = importedFilePadding.top;
                document.getElementById('marginBottom').value = importedFilePadding.bottom;
                document.getElementById('marginLeft').value = importedFilePadding.left;
                document.getElementById('marginRight').value = importedFilePadding.right;
            } else if (!preserveMargins) {
                updateDefaultMarginsForFormat(format);
            }
            
            updatePageMargins();
            updateAllElementsFontSize(format);
            
            if (format === 'A7' || format === 'A8' || format === 'Receipt80') {
                currentZoom = 150;
            } else if (format === 'A6') {
                currentZoom = 120;
            } else if (format === 'Custom') {
                currentZoom = 100;
            } else {
                currentZoom = 100;
            }
            applyZoom();
            updateZoomDisplay();
        }

        function updateAllElementsFontSize(format) {
            const fontSizeMap = {
                'A4': '12pt',
                'A5': '11pt',
                'A6': '10pt',
                'A7': '9pt',
                'A8': '8pt',
                'Receipt80': '9pt',
                'Custom': '11pt'
            };
            
            const newFontSize = fontSizeMap[format] || '12pt';
            
            document.querySelectorAll('.dropped-element').forEach(element => {
                const currentSize = element.style.fontSize;
                
                if (!currentSize || currentSize === '' || isDefaultFontSize(currentSize)) {
                    element.style.fontSize = newFontSize;
                }
            });
        }

        function isDefaultFontSize(fontSize) {
            const defaultSizes = ['12pt', '11pt', '10pt', '9pt', '8pt', '7pt'];
            return defaultSizes.includes(fontSize);
        }

        function applyCustomSize() {
            const format = document.getElementById('pageFormat').value;
            if (format !== 'Custom') return;
            
            const widthInput = document.getElementById('customWidth').value.trim();
            const heightInput = document.getElementById('customHeight').value.trim();
            
            const width = widthInput === '' ? 'auto' : (parseInt(widthInput) + 'mm');
            const height = heightInput === '' ? 'fit-content' : (parseInt(heightInput) + 'mm');
            
            const allPages = document.querySelectorAll('.canvas');
            
            allPages.forEach(page => {
                page.className = 'canvas Custom';
                page.style.width = width;
                page.style.height = height;
                if (heightInput === '') {
                    page.style.minHeight = '10mm';
                } else {
                    page.style.minHeight = '';
                }
            });
        }

        function updateDefaultMarginsForFormat(format) {
            const marginInputs = {
                'A4': { top: 25, bottom: 25, left: 20, right: 20 },
                'A5': { top: 15, bottom: 15, left: 12, right: 12 },
                'A6': { top: 10, bottom: 10, left: 10, right: 10 },
                'A7': { top: 8, bottom: 8, left: 8, right: 8 },
                'A8': { top: 6, bottom: 6, left: 6, right: 6 },
                'Receipt80': { top: 5, bottom: 5, left: 5, right: 5 },
                'Custom': { top: 3, bottom: 3, left: 3, right: 3 }
            };
            
            const margins = marginInputs[format];
            document.getElementById('marginTop').value = margins.top;
            document.getElementById('marginBottom').value = margins.bottom;
            document.getElementById('marginLeft').value = margins.left;
            document.getElementById('marginRight').value = margins.right;
        }

        document.addEventListener('DOMContentLoaded', function() {
            initializeDragAndDrop();
            updateZoomDisplay();
        });

        function changeZoom(delta) {
            currentZoom = Math.max(20, Math.min(300, currentZoom + delta));
            applyZoom();
            updateZoomDisplay();
        }

        function resetZoom() {
            currentZoom = 100;
            applyZoom();
            updateZoomDisplay();
        }

        function applyZoom() {
            const canvasContainer = document.querySelector('.canvas-container');
            canvasContainer.style.transform = `scale(${currentZoom / 100})`;
        }

        function updateZoomDisplay() {
            document.getElementById('zoomDisplay').textContent = currentZoom + '%';
        }

        function initializeDragAndDrop() {
            const components = document.querySelectorAll('.component-item');
            const canvas = document.getElementById('canvas');

            components.forEach(component => {
                component.addEventListener('dragstart', handleDragStart);
                component.addEventListener('dragend', handleDragEnd);
            });

            canvas.addEventListener('dragover', handleDragOver);
            canvas.addEventListener('drop', handleDrop);
            canvas.addEventListener('dragleave', handleDragLeave);
        }

        function handleDragStart(e) {
            e.dataTransfer.effectAllowed = 'copy';
            e.dataTransfer.setData('componentType', e.target.dataset.type);
            e.target.classList.add('dragging');
        }

        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
        }

        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'copy';
            e.currentTarget.classList.add('drag-over');
            return false;
        }

        function handleDragLeave(e) {
            e.currentTarget.classList.remove('drag-over');
        }

        function addElement(type, container) {
            const element = createElementByType(type);
            container.appendChild(element);
            makeElementInteractive(element);
        }

        function createElementByType(type) {
            const pageFormat = document.getElementById('pageFormat').value;
            let { size, pageStyle, fontSize } = getPageSize(pageFormat);
            const wrapper = document.createElement('div');
            wrapper.className = 'dropped-element';
            wrapper.dataset.elementId = `element_${++elementCounter}`;
            wrapper.dataset.type = type;
            wrapper.style.marginTop = "1mm";
            wrapper.style.marginBottom = "1mm";
            wrapper.style.fontSize = fontSize;

            let content = '';
            
            switch(type) {
                case 'heading':
                    wrapper.style.textAlign = "left";
                    content = `
                        <h2 contenteditable="true" style="white-space: nowrap; overflow: hidden;">Titolo Report</h2>
                    `;
                    break;
                case 'paragraph':
                    wrapper.style.textAlign = "left";
                    content = `
                        <p contenteditable="true" style="white-space: nowrap; overflow: hidden;">Inserisci qui il testo del paragrafo...</p>
                    `;
                    break;
                case 'table':
                    content = `
                        <table style="width: 100%; border-collapse: collapse; font-size: inherit; table-layout: fixed;" data-padding="2mm">
                            <thead>
                                <tr>
                                    <th style="border: 0.3mm solid #ddd; padding: 2mm 3mm; text-align: left; white-space: nowrap; overflow: hidden;" contenteditable="true" data-colspan="1">Colonna 1</th>
                                    <th style="border: 0.3mm solid #ddd; padding: 2mm 3mm; text-align: left; white-space: nowrap; overflow: hidden;" contenteditable="true" data-colspan="1">Colonna 2</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td style="border: 0.3mm solid #ddd; padding: 2mm 3mm; text-align: left; white-space: nowrap; overflow: hidden;" contenteditable="true" data-colspan="1">Dato 1</td>
                                    <td style="border: 0.3mm solid #ddd; padding: 2mm 3mm; text-align: left; white-space: nowrap; overflow: hidden;" contenteditable="true" data-colspan="1">Dato 2</td>
                                </tr>
                            </tbody>
                        </table>
                    `;
                    break;
                case 'image':
                    wrapper.style.textAlign = "center";
                    content = `
                        <div data-image-container>
                            <img alt="Immagine"
                                 style="width: 50mm; height: 37.5mm; display: inline-block;"
                                 data-width-mm="50" data-height-mm="37.5" data-image-type="file">
                        </div>
                    `;
                    break;
                case 'carousel':
                    wrapper.style.textAlign = "center";
                    content = `
                        <div data-carousel-container data-weight-source="weight2" style="display: flex; flex-wrap: wrap; gap: 5mm; justify-content: center;">
                            <img src="{{ weight2.weighing_pictures[0:1]|map(attribute='path_name')|first|default('') }}"
                                 alt="Uscita img 1"
                                 style="width: 50mm; height: 37.5mm;"
                                 data-width-mm="50"
                                 data-height-mm="37.5"
                                 data-source="weight2">
                            <img src="{{ weight2.weighing_pictures[1:2]|map(attribute='path_name')|first|default('') }}"
                                 alt="Uscita img 2"
                                 style="width: 50mm; height: 37.5mm;"
                                 data-width-mm="50"
                                 data-height-mm="37.5"
                                 data-source="weight2">
                            <img src="{{ weight2.weighing_pictures[2:3]|map(attribute='path_name')|first|default('') }}"
                                 alt="Uscita img 3"
                                 style="width: 50mm; height: 37.5mm;"
                                 data-width-mm="50"
                                 data-height-mm="37.5"
                                 data-source="weight2">
                        </div>
                    `;
                    break;
                case 'divider':
                    content = `<hr style="border: none; border-top: 2px solid #e0e0e0; margin: 0; padding: 0;">`;
                    wrapper.style.padding = "0";
                    break;
            }
            
            wrapper.innerHTML = content + `
                <div class="element-controls" onclick="event.stopPropagation()">
                    <button class="control-btn" onclick="moveUp(this)" title="Sposta su">‚Üë</button>
                    <button class="control-btn" onclick="moveDown(this)" title="Sposta gi√π">‚Üì</button>
                    <button class="control-btn" onclick="deleteElement(this)" title="Elimina">√ó</button>
                </div>
            `;
            
            if (type === 'table') {
                setupTableCellSelection(wrapper);
            }
            
            return wrapper;
        }

        function setupTableCellSelection(tableElement) {
            const cells = tableElement.querySelectorAll('td, th');
            cells.forEach(cell => {
                cell.removeEventListener('click', cell._clickHandler);
                cell._clickHandler = function(e) {
                    e.stopPropagation();
                    selectTableCell(this);
                };
                cell.addEventListener('click', cell._clickHandler);
            });
        }

        function selectTableCell(cell) {
            document.querySelectorAll('.table-cell-selected').forEach(c => {
                c.classList.remove('table-cell-selected');
            });
            
            cell.classList.add('table-cell-selected');
            selectedTableCell = cell;
            
            const tableWrapper = cell.closest('.dropped-element');
            if (tableWrapper) {
                selectElement(tableWrapper);
            } else {
                const cellPropertiesContent = document.getElementById('cellPropertiesContent');
                if (cellPropertiesContent) cellPropertiesContent.remove();
            }
        }

        function makeElementInteractive(element) {
            element.removeEventListener('click', element._clickHandler);
            element._clickHandler = function(e) {
                if (!e.target.matches('td, th')) {
                    selectElement(this);
                }
                e.stopPropagation();
            };
            element.addEventListener('click', element._clickHandler);
            
            if (element.dataset.type === 'table') {
                setupTableCellSelection(element);
            }
        }

        function selectElement(element) {
            document.querySelectorAll('.dropped-element').forEach(el => {
                el.classList.remove('selected');
            });

            if (element) {
                element.classList.add('selected');
                selectedElement = element;
            }
            
            showProperties(element);
        }

        function showProperties(element) {
            const propertiesContent = document.getElementById('propertiesContent');

            if (!element) {
                propertiesContent.innerHTML = `
                    <p style="color: #999; text-align: center; margin-top: 20px;">
                        Seleziona un elemento per modificarne le propriet√†
                    </p>
                `;
                return;
            }

            const type = element.dataset.type;
            const marginTop = element.style.marginTop.replace("mm", "");
            const marginBottom = element.style.marginBottom.replace("mm", "");
            const textAlign = element.style.textAlign;
            const fontSize = element.style.fontSize.replace("pt", "");
            const fontFamily = element.style.fontFamily;

            let propertiesHTML = `
                <div class="property-group">
                    <label>ID Elemento</label>
                    <input type="text" value="${element.dataset.elementId}" readonly>
                </div>
                <div class="property-group">
                    <label>Tipo</label>
                    <input type="text" value="${type}" readonly>
                </div>
            `;

            if (type !== 'image' && type !== 'carousel') {
                propertiesHTML += `
                    <div class="jinja-section">
                        <h4>üî§ Variabili Jinja2</h4>

                        <div class="property-group">
                            <label>Seleziona Variabile da Inserire</label>
                            <select onchange="insertQuickVariable(this.value); this.value='';">
                                <option value="">-- Seleziona variabile --</option>
                                <option value="{{ typeSubject }}">{{ typeSubject }} - Tipo SOGGETTO</option>
                                <option value="{{ subject.social_reason }}">{{ subject.social_reason }} - Ragione sociale SOGGETTO</option>
                                <option value="{{ subject.telephone }}">{{ subject.telephone }} - Telefono SOGGETTO</option>
                                <option value="{{ subject.cfpiva }}">{{ subject.cfpiva }} - CF/P.iVA SOGGETTO</option>
                                <option value="{{ vector.social_reason }}">{{ vector.social_reason }} - Ragione sociale VETTORE</option>
                                <option value="{{ vector.telephone }}">{{ vector.telephone }} - Telefono VETTORE</option>
                                <option value="{{ vector.cfpiva }}">{{ vector.cfpiva }} - CF/P.Iva VETTORE</option>
                                <option value="{{ driver.social_reason }}">{{ driver.social_reason }} - Ragione sociale AUTISTA</option>
                                <option value="{{ driver.telephone }}">{{ driver.telephone }} - Telefono AUTISTA</option>
                                <option value="{{ vehicle.plate }}">{{ vehicle.plate }} - Targa VEICOLO</option>
                                <option value="{{ vehicle.description }}">{{ vehicle.description }} - Descrizione VEICOLO</option>
                                <option value="{{ material.description }}">{{ material.description }} - Descrizione MATERIALE</option>
                                <option value="{{ note }}">{{ note }} - NOTE</option>
                                <option value="{{ document_reference }}">{{ document_reference }} - REFERENZA DOCUMENTO</option>
                                <option value="{{ weight1.weight }}">{{ weight1.weight }} - Peso ENTRATA</option>
                                <option value="{{ weight1.date }}">{{ weight1.date }} - Data ENTRATA</option>
                                <option value="{{ weight1.pid }}">{{ weight1.pid }} - Pid ENTRATA</option>
                                <option value="{{ weight2.weight }}">{{ weight2.weight }} - Peso USCITA</option>
                                <option value="{{ weight2.date }}">{{ weight2.date }} - Data USCITA</option>
                                <option value="{{ weight2.pid }}">{{ weight2.pid }} - Pid USCITA</option>
                                <option value="{{ net_weight }}">{{ net_weight }} - Peso NETTO</option>
                            </select>
                        </div>

                        <div class="property-group">
                            <small style="color: #666;">
                                ${type === 'table' ? 'Clicca su una cella della tabella per selezionarla, poi scegli la variabile.' : 'Clicca nel testo dove vuoi inserire la variabile, poi selezionala dal menu sopra.'}
                            </small>
                        </div>
                    </div>
                `;
            }
            
            switch(type) {
                case 'heading':
                    const typeTitle = element.firstElementChild.tagName;
                    const headingElement = element.firstElementChild;
                    const headingWhiteSpace = headingElement.style.whiteSpace || 'nowrap';
                    
                    propertiesHTML += `
                        <div class="property-group">
                            <label>Dimensione</label>
                            <select onchange="changeHeadingSize(this.value)">
                                <option value="h1" ${typeTitle == "H1" ? 'selected' : null}>H1 - Molto grande</option>
                                <option value="h2" ${typeTitle == "H2" ? 'selected' : null}>H2 - Grande</option>
                                <option value="h3" ${typeTitle == "H3" ? 'selected' : null}>H3 - Medio</option>
                                <option value="h4" ${typeTitle == "H4" ? 'selected' : null}>H4 - Piccolo</option>
                            </select>
                        </div>
                        <div class="property-group">
                            <label>Allineamento</label>
                            <select onchange="changeAlignment(this.value)">
                                <option value="left" ${textAlign == "left" ? 'selected' : null}>Sinistra</option>
                                <option value="center" ${textAlign == "center" ? 'selected' : null}>Centro</option>
                                <option value="right" ${textAlign == "right" ? 'selected' : null}>Destra</option>
                            </select>
                        </div>
                        <div class="property-group">
                            <label>Comportamento Testo</label>
                            <select onchange="changeTextWrap(this.value)">
                                <option value="nowrap" ${headingWhiteSpace == "nowrap" ? 'selected' : null}>Riga singola (tagliato)</option>
                                <option value="pre-wrap" ${headingWhiteSpace == "pre-wrap" || headingWhiteSpace == "normal" ? 'selected' : null}>A capo automatico</option>
                            </select>
                        </div>
                        <div class="property-group">
                            <label>Font</label>
                            <select onchange="changeElementFont(this.value)">
                                <option value="unset" ${!fontFamily || fontFamily == "unset" ? 'selected' : null}>Globale (${globalFont.split(',')[0]})</option>
                                <option value="Arial, sans-serif" ${fontFamily == "Arial, sans-serif" ? 'selected' : null}>Arial</option>
                                <option value="'Times New Roman', serif" ${fontFamily == "'Times New Roman', serif" ? 'selected' : null}>Times New Roman</option>
                                <option value="'Courier New', monospace" ${fontFamily == "'Courier New', monospace" ? 'selected' : null}>Courier New</option>
                                <option value="Verdana, sans-serif" ${fontFamily == "Verdana, sans-serif" ? 'selected' : null}>Verdana</option>
                                <option value="Georgia, serif" ${fontFamily == "Georgia, serif" ? 'selected' : null}>Georgia</option>
                            </select>
                        </div>
                    `;
                    break;
                case 'paragraph':
                    const paragraphElement = element.firstElementChild;
                    const paragraphWhiteSpace = paragraphElement.style.whiteSpace || 'nowrap';
                    
                    propertiesHTML += `
                        <div class="property-group">
                            <label>Allineamento</label>
                            <select onchange="changeAlignment(this.value)">
                                <option value="left" ${textAlign == "left" ? 'selected' : null}>Sinistra</option>
                                <option value="center" ${textAlign == "center" ? 'selected' : null}>Centro</option>
                                <option value="right" ${textAlign == "right" ? 'selected' : null}>Destra</option>
                            </select>
                        </div>
                        <div class="property-group">
                            <label>Comportamento Testo</label>
                            <select onchange="changeTextWrap(this.value)">
                                <option value="nowrap" ${paragraphWhiteSpace == "nowrap" ? 'selected' : null}>Riga singola (tagliato)</option>
                                <option value="pre-wrap" ${paragraphWhiteSpace == "pre-wrap" || paragraphWhiteSpace == "normal" ? 'selected' : null}>A capo automatico</option>
                            </select>
                        </div>
                        <div class="property-group">
                            <label>Dimensione font</label>
                            <input type="number" value="${fontSize}" min="8" max="32" onchange="changeFontSize(this.value)">
                        </div>
                        <div class="property-group">
                            <label>Font</label>
                            <select onchange="changeElementFont(this.value)">
                                <option value="unset" ${!fontFamily || fontFamily == "unset" ? 'selected' : null}>Globale (${globalFont.split(',')[0]})</option>
                                <option value="Arial, sans-serif" ${fontFamily == "Arial, sans-serif" ? 'selected' : null}>Arial</option>
                                <option value="'Times New Roman', serif" ${fontFamily == "'Times New Roman', serif" ? 'selected' : null}>Times New Roman</option>
                                <option value="'Courier New', monospace" ${fontFamily == "'Courier New', monospace" ? 'selected' : null}>Courier New</option>
                                <option value="Verdana, sans-serif" ${fontFamily == "Verdana, sans-serif" ? 'selected' : null}>Verdana</option>
                                <option value="Georgia, serif" ${fontFamily == "Georgia, serif" ? 'selected' : null}>Georgia</option>
                            </select>
                        </div>
                    `;
                    break;
                case 'image':
                    const img = element.querySelector('img');
                    const currentWidthMm = img.dataset.widthMm || '';
                    const currentHeightMm = img.dataset.heightMm || '';
                    const imageType = img.dataset.imageType || 'file';
                
                    propertiesHTML += `
                        <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin: 15px 0; border: 1px solid #ffeaa7;">
                            <h4 style="margin: 0 0 15px 0; color: #856404;">üñºÔ∏è Propriet√† Immagine</h4>
                            
                            <div class="property-group">
                                <label>Tipo Sorgente Immagine</label>
                                <select onchange="changeImageType(this.value)" id="imageTypeSelect">
                                    <option value="file" ${imageType === 'file' ? 'selected' : ''}>üìÅ File dal PC</option>
                                    <option value="variable" ${imageType === 'variable' ? 'selected' : ''}>üî§ Variabile Jinja2</option>
                                </select>
                            </div>
                            
                            <div id="fileUploadSection" style="display: ${imageType === 'file' ? 'block' : 'none'};">
                                <div class="property-group">
                                    <label>Carica Immagine dal PC</label>
                                    <div class="file-upload-container">
                                        <input type="file" accept="image/*" onchange="handleImageUpload(this)" id="imageFileInput">
                                        <div style="pointer-events: none;">
                                            <div style="font-size: 24px; color: #667eea;">üìÅ</div>
                                            <div class="file-upload-text">Clicca per selezionare un'immagine</div>
                                            <div style="font-size: 12px; color: #999; margin-top: 5px;">PNG, JPG, GIF, WebP</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="variableSection" style="display: ${imageType === 'variable' ? 'block' : 'none'};">
                                <div class="property-group">
                                    <label>Variabili Immagini</label>
                                    <select onchange="setImageVariable(this.value); this.value='';">
                                        <option value="">-- Seleziona variabile --</option>
                                        <option value="weight1.img">{{ weight1.img }} - Foto ENTRATA</option>
                                        <option value="weight2.img">{{ weight2.img }} - Foto USCITA</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div id="urlSection" style="display: ${imageType === 'url' ? 'block' : 'none'};">
                                <div class="property-group"></div>
                            </div>
                            
                            <div class="property-group">
                                <label>Dimensioni</label>
                                <div class="dimension-group">
                                    <div class="dimension-input">
                                        <input type="number" value="${currentWidthMm}" min="5" max="200" step="0.5" 
                                            onchange="changeImageWidth(this.value)" placeholder="Larghezza">
                                        <span>mm</span>
                                    </div>
                                    <div class="dimension-input">
                                        <input type="number" value="${currentHeightMm}" min="5" max="200" step="0.5" 
                                            onchange="changeImageHeight(this.value)" placeholder="Altezza">
                                        <span>mm</span>
                                    </div>
                                </div>
                                <small style="color: #666; margin-top: 5px; display: block;">
                                    Lascia un campo vuoto per mantenere le proporzioni
                                </small>
                            </div>
                        </div>
                    `;

                    propertiesHTML += `
                        <div class="property-group">
                            <label>Allineamento</label>
                            <select onchange="changeImageAlignment(this.value)">
                                <option value="center" ${textAlign === 'center' ? 'selected' : ''}>Centro</option>
                                <option value="left" ${textAlign === 'left' ? 'selected' : ''}>Sinistra</option>
                                <option value="right" ${textAlign === 'right' ? 'selected' : ''}>Destra</option>
                            </select>
                        </div>
                    `;
                    break;
                case 'carousel':
                    const carouselContainer = element.querySelector('[data-carousel-container]');
                    const carouselImages = carouselContainer.querySelectorAll('img');
                    const totalImages = carouselImages.length;
                    const firstCarouselImg = carouselImages[0];
                    const carouselWidthMm = firstCarouselImg ? (firstCarouselImg.dataset.widthMm || '50') : '50';
                    const carouselHeightMm = firstCarouselImg ? (firstCarouselImg.dataset.heightMm || '37.5') : '37.5';
                    const carouselGap = carouselContainer.style.gap.replace('mm', '') || '5';
                    const carouselAlign = carouselContainer.style.justifyContent || 'center';
                    const weightSource = carouselContainer.dataset.weightSource || 'weight2';

                    // Se √® "both", mostra il numero per singola sorgente, altrimenti il totale
                    const displayCount = weightSource === 'both' ? Math.floor(totalImages / 2) : totalImages;

                    propertiesHTML += `
                        <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin: 15px 0; border: 1px solid #ffeaa7;">
                            <h4 style="margin: 0 0 15px 0; color: #856404;">üé† Propriet√† Carosello</h4>

                            <div class="property-group">
                                <label>Sorgente Immagini</label>
                                <select onchange="changeCarouselWeightSource(this.value)">
                                    <option value="weight1" ${weightSource === 'weight1' ? 'selected' : ''}>Peso ENTRATA (weight1)</option>
                                    <option value="weight2" ${weightSource === 'weight2' ? 'selected' : ''}>Peso USCITA (weight2)</option>
                                    <option value="both" ${weightSource === 'both' ? 'selected' : ''}>Entrata e Uscita (entrambe)</option>
                                </select>
                            </div>

                            <div class="property-group">
                                <label>Numero di Immagini${weightSource === 'both' ? ' (per sorgente)' : ''}</label>
                                <input id="carouselImageCountInput" type="number" value="${displayCount}" min="1" max="20" onchange="changeCarouselImageCount(this.value)">
                            </div>

                            <div class="property-group">
                                <label>Dimensioni Immagini</label>
                                <div class="dimension-group">
                                    <div class="dimension-input">
                                        <input type="number" value="${carouselWidthMm}" min="5" max="200" step="0.5"
                                            onchange="changeCarouselImageWidth(this.value)" placeholder="Larghezza">
                                        <span>mm</span>
                                    </div>
                                    <div class="dimension-input">
                                        <input type="number" value="${carouselHeightMm}" min="5" max="200" step="0.5"
                                            onchange="changeCarouselImageHeight(this.value)" placeholder="Altezza">
                                        <span>mm</span>
                                    </div>
                                </div>
                                <small style="color: #666; margin-top: 5px; display: block;">
                                    Lascia un campo vuoto per mantenere le proporzioni
                                </small>
                            </div>

                            <div class="property-group">
                                <label>Spazio tra immagini (mm)</label>
                                <input type="number" value="${carouselGap}" min="0" max="50" step="0.5" onchange="changeCarouselGap(this.value)">
                            </div>

                            <div class="property-group">
                                <label>Allineamento Carosello</label>
                                <select onchange="changeCarouselAlignment(this.value)">
                                    <option value="center" ${carouselAlign === 'center' ? 'selected' : ''}>Centro</option>
                                    <option value="flex-start" ${carouselAlign === 'flex-start' ? 'selected' : ''}>Sinistra</option>
                                    <option value="flex-end" ${carouselAlign === 'flex-end' ? 'selected' : ''}>Destra</option>
                                    <option value="space-between" ${carouselAlign === 'space-between' ? 'selected' : ''}>Spazio tra</option>
                                    <option value="space-around" ${carouselAlign === 'space-around' ? 'selected' : ''}>Spazio intorno</option>
                                </select>
                            </div>
                        </div>
                    `;
                    break;
                case 'table':
                    const table = element.querySelector('table');
                    const currentPadding = table.dataset.padding ? table.dataset.padding.replace('mm', '') : '2';
                    const theadRow = table.querySelector('thead tr');
                    const currentCols = getEffectiveColumnCount(theadRow);
                    const tbodyRows = table.querySelectorAll('tbody tr');
                    const currentRows = tbodyRows.length;
                    
                    if (selectedTableCell) {
                        const cellAlign = selectedTableCell.style.textAlign || 'left';
                        const cellColspan = selectedTableCell.getAttribute('data-colspan') || '1';
                        const row = selectedTableCell.closest('tr');
                        const cells = Array.from(row.querySelectorAll('th, td'));
                        const cellIndex = cells.indexOf(selectedTableCell);
                        const maxColspan = (cells.length - cellIndex) + (Number(cellColspan) - 1);
                        const cellFontWeight = selectedTableCell.style.fontWeight || (selectedTableCell.tagName.toUpperCase() === 'TH' ? 'bold' : 'normal');

                        propertiesHTML += `
                            <div id="cellPropertiesContent" style="background: #e8f5e9; padding: 10px; border-radius: 6px; margin-bottom: 15px;">
                                <h4 style="margin: 0 0 10px 0; color: #2e7d32;">üìå Cella Selezionata</h4>
                                
                                <div class="property-group">
                                    <label>Allineamento Cella</label>
                                    <select onchange="changeCellAlignment(this.value)">
                                        <option value="left" ${cellAlign === 'left' ? 'selected' : ''}>Sinistra</option>
                                        <option value="center" ${cellAlign === 'center' ? 'selected' : ''}>Centro</option>
                                        <option value="right" ${cellAlign === 'right' ? 'selected' : ''}>Destra</option>
                                    </select>
                                </div>
                                
                                <div class="property-group">
                                    <label>Colspan (unisci colonne)</label>
                                    <input type="number" value="${cellColspan}" min="1" max="${maxColspan}" onchange="changeCellColspan(this.value)">
                                </div>

                                <div class="property-group">
                                    <label>Stile Testo</label>
                                    <select onchange="changeCellFontWeight(this.value)">
                                        <option value="normal" ${cellFontWeight === 'normal' ? 'selected' : ''}>Normale</option>
                                        <option value="bold" ${cellFontWeight === 'bold' ? 'selected' : ''}>Grassetto</option>
                                    </select>
                                </div>
                            </div>
                        `;
                    }

                    propertiesHTML += `
                        <div style="background: #f0f0f0; padding: 10px; border-radius: 6px; margin-bottom: 15px;">
                            <h4 style="margin: 0 0 10px 0; color: #333;">üìä Propriet√† Globali Tabella</h4>
                            
                            <div class="property-group">
                                <label>Numero Colonne</label>
                                <input id="inputTableColumns" type="number" value="${currentCols}" min="1" max="10" onchange="changeTableColumns(this, this.value);">
                            </div>
                            
                            <div class="property-group">
                                <label>Numero Righe</label>
                                <input id="inputTableRows" type="number" value="${currentRows}" min="1" max="20" onchange="changeTableRows(this.value)">
                            </div>
                            
                            <div class="property-group">
                                <label>Padding Celle (mm)</label>
                                <input type="number" value="${currentPadding}" min="1" max="10" step="0.5" onchange="changeTablePadding(this.value)">
                            </div>
                        </div>
                    `;

                    propertiesHTML += `
                            <div class="property-group">
                                <label>Dimensione Font (pt)</label>
                                <input type="number" value="${fontSize}" min="6" max="24" onchange="changeFontSize(this.value)">
                            </div>
                            <div class="property-group">
                                <label>Font</label>
                                <select onchange="changeElementFont(this.value)">
                                    <option value="unset" ${!fontFamily || fontFamily == "unset" ? 'selected' : null}>Globale (${globalFont.split(',')[0]})</option>
                                    <option value="Arial, sans-serif" ${fontFamily == "Arial, sans-serif" ? 'selected' : null}>Arial</option>
                                    <option value="'Times New Roman', serif" ${fontFamily == "'Times New Roman', serif" ? 'selected' : null}>Times New Roman</option>
                                    <option value="'Courier New', monospace" ${fontFamily == "'Courier New', monospace" ? 'selected' : null}>Courier New</option>
                                    <option value="Verdana, sans-serif" ${fontFamily == "Verdana, sans-serif" ? 'selected' : null}>Verdana</option>
                                    <option value="Georgia, serif" ${fontFamily == "Georgia, serif" ? 'selected' : null}>Georgia</option>
                                </select>
                            </div>
                    `;
                    break;
                case 'divider':
                    const hr = element.querySelector('hr');
                    const currentThickness = hr.style.borderTopWidth.replace('px', '') || '2';
                    propertiesHTML += `
                        <div class="property-group">
                            <label>Spessore linea (mm)</label>
                            <input type="number" value="${currentThickness}" min="1" max="10" onchange="changeDividerThickness(this.value)">
                        </div>
                    `;
                    break;
            }
            
            propertiesHTML += `
                <div class="property-group">
                    <label>Margine superiore (mm)</label>
                    <input type="number" value="${marginTop}" min="0" max="100" onchange="changeMarginTop(this.value)">
                </div>
                <div class="property-group">
                    <label>Margine inferiore (mm)</label>
                    <input type="number" value="${marginBottom}" min="0" max="100" onchange="changeMarginBottom(this.value)">
                </div>
            `;
            
            propertiesContent.innerHTML = propertiesHTML;
        }

        function changeImageType(type) {
            if (!selectedElement) return;
            
            const img = selectedElement.querySelector('img');
            if (!img) return;
            
            img.dataset.imageType = type;
            
            document.getElementById('fileUploadSection').style.display = 'none';
            document.getElementById('variableSection').style.display = 'none';
            document.getElementById('urlSection').style.display = 'none';
            
            switch(type) {
                case 'file':
                    document.getElementById('fileUploadSection').style.display = 'block';
                    if (!img.src.startsWith('data:image/')) {
                        img.removeAttribute('src');
                        img.alt = 'Immagine';
                    }
                    break;
                case 'variable':
                    document.getElementById('variableSection').style.display = 'block';
                    if (!img.src.includes('{{')) {
                        img.setAttribute('src', '{{ nome_variabile }}');
                        img.alt = 'Variabile Jinja2';
                    }
                    break;
                case 'url':
                    document.getElementById('urlSection').style.display = 'block';
                    if (img.src.includes('{{')) {
                        img.removeAttribute('src');
                        img.alt = 'Immagine';
                    }
                    break;
            }
        }

        function setImageVariable(variableName) {
            if (!selectedElement) return;
            
            const img = selectedElement.querySelector('img');
            if (!img) return;
            
            if (variableName.trim()) {
                const cleanVariable = variableName.replace(/^\{\{\s*/, '').replace(/\s*\}\}$/, '').trim();
                img.setAttribute('src', `{{ ${cleanVariable} }}`);
                img.alt = `Variabile: ${cleanVariable}`;
                
                const variableInput = document.getElementById('imageVariableInput');
                if (variableInput) {
                    variableInput.value = cleanVariable;
                }
            } else {
                img.setAttribute('src', '{{ nome_variabile }}');
                img.alt = 'Variabile Jinja2';
            }
        }

        function handleImageUpload(input) {
            const file = input.files[0];
            if (!file) return;
            
            if (!file.type.startsWith('image/')) {
                alert('Seleziona un file immagine valido');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = selectedElement.querySelector('img');
                if (img) {
                    img.setAttribute('src', e.target.result);
                    img.alt = file.name;
                    
                    const tempImg = new Image();
                    tempImg.onload = function() {
                        const aspectRatio = this.width / this.height;
                        let newWidth, newHeight;
                        
                        if (aspectRatio > 1) {
                            newWidth = Math.min(100, this.width * 0.1);
                            newHeight = newWidth / aspectRatio;
                        } else {
                            newHeight = Math.min(100, this.height * 0.1);
                            newWidth = newHeight * aspectRatio;
                        }
                        
                        newWidth = Math.round(newWidth * 10) / 10;
                        newHeight = Math.round(newHeight * 10) / 10;
                        
                        changeImageWidth(newWidth);
                        changeImageHeight(newHeight);
                        
                        showProperties(selectedElement);
                    };
                    tempImg.src = e.target.result;
                }
            };
            reader.readAsDataURL(file);
        }

        function changeImageSrc(src) {
            if (!selectedElement) return;
            const img = selectedElement.querySelector('img');
            if (img) {
                if (src && src.trim() !== '') {
                    img.setAttribute('src', src);
                } else {
                    img.removeAttribute('src');
                }
                img.alt = 'Immagine';
            }
        }

        function changeImageWidth(value) {
            if (!selectedElement) return;
            const img = selectedElement.querySelector('img');
            if (img) {
                if (value.trim() === '') {
                    img.style.width = 'auto';
                    img.dataset.widthMm = '';
                } else {
                    const width = parseFloat(value) || 50;
                    img.style.width = width + 'mm';
                    img.dataset.widthMm = width;
                }
            }
        }

        function changeImageHeight(value) {
            if (!selectedElement) return;
            const img = selectedElement.querySelector('img');
            if (img) {
                if (value.trim() === '') {
                    img.style.height = 'auto';
                    img.dataset.heightMm = '';
                } else {
                    const height = parseFloat(value) || 37.5;
                    img.style.height = height + 'mm';
                    img.dataset.heightMm = height;
                }
            }
        }

        function changeImageAlignment(alignment) {
            if (!selectedElement) return;
            selectedElement.style.textAlign = alignment;
        }

        function changeCarouselImageCount(count) {
            if (!selectedElement) return;
            const container = selectedElement.querySelector('[data-carousel-container]');
            if (!container) return;

            const newCount = parseInt(count) || 1;
            const currentImages = container.querySelectorAll('img');
            const weightSource = container.dataset.weightSource || 'weight2';

            const widthMm = currentImages[0]?.dataset.widthMm || '50';
            const heightMm = currentImages[0]?.dataset.heightMm || '37.5';

            if (weightSource === 'both') {
                // Modalit√† "both": newCount √® per sorgente, quindi totale = newCount * 2
                const currentCount = Math.floor(currentImages.length / 2);
                const targetTotal = newCount * 2;

                if (newCount > currentCount) {
                    // Aggiungi immagini per weight1
                    for (let i = currentCount; i < newCount; i++) {
                        const img1 = document.createElement('img');
                        img1.src = `{{ weight1.weighing_pictures[${i}:${i+1}]|map(attribute='path_name')|first|default('') }}`;
                        img1.alt = `Entrata img ${i + 1}`;
                        img1.style.width = widthMm + 'mm';
                        img1.style.height = heightMm + 'mm';
                        img1.dataset.widthMm = widthMm;
                        img1.dataset.heightMm = heightMm;
                        img1.dataset.source = 'weight1';

                        // Inserisci weight1 prima di tutte le immagini weight2
                        const firstWeight2 = container.querySelector('img[data-source="weight2"]');
                        if (firstWeight2) {
                            container.insertBefore(img1, firstWeight2);
                        } else {
                            container.appendChild(img1);
                        }
                    }

                    // Aggiungi immagini per weight2
                    for (let i = currentCount; i < newCount; i++) {
                        const img2 = document.createElement('img');
                        img2.src = `{{ weight2.weighing_pictures[${i}:${i+1}]|map(attribute='path_name')|first|default('') }}`;
                        img2.alt = `Uscita img ${i + 1}`;
                        img2.style.width = widthMm + 'mm';
                        img2.style.height = heightMm + 'mm';
                        img2.dataset.widthMm = widthMm;
                        img2.dataset.heightMm = heightMm;
                        img2.dataset.source = 'weight2';
                        container.appendChild(img2);
                    }
                } else if (newCount < currentCount) {
                    // Rimuovi immagini in eccesso
                    const toRemove = currentCount - newCount;

                    // Rimuovi da weight1
                    const weight1Images = container.querySelectorAll('img[data-source="weight1"]');
                    for (let i = weight1Images.length - 1; i >= newCount; i--) {
                        weight1Images[i].remove();
                    }

                    // Rimuovi da weight2
                    const weight2Images = container.querySelectorAll('img[data-source="weight2"]');
                    for (let i = weight2Images.length - 1; i >= newCount; i--) {
                        weight2Images[i].remove();
                    }
                }
            } else {
                // Modalit√† singola sorgente
                const currentCount = currentImages.length;
                const altPrefix = weightSource === 'weight1' ? 'Entrata' : 'Uscita';

                if (newCount > currentCount) {
                    for (let i = currentCount; i < newCount; i++) {
                        const img = document.createElement('img');
                        img.src = `{{ ${weightSource}.weighing_pictures[${i}:${i+1}]|map(attribute='path_name')|first|default('') }}`;
                        img.alt = `${altPrefix} img ${i + 1}`;
                        img.style.width = widthMm + 'mm';
                        img.style.height = heightMm + 'mm';
                        img.dataset.widthMm = widthMm;
                        img.dataset.heightMm = heightMm;
                        img.dataset.source = weightSource;
                        container.appendChild(img);
                    }
                } else if (newCount < currentCount) {
                    for (let i = currentCount - 1; i >= newCount; i--) {
                        currentImages[i].remove();
                    }
                }
            }

            showProperties(selectedElement);
            setTimeout(() => {
                const input = document.getElementById('carouselImageCountInput');
                if (input) input.focus();
            }, 0);
        }

        function changeCarouselWeightSource(source) {
            if (!selectedElement) return;
            const container = selectedElement.querySelector('[data-carousel-container]');
            if (!container) return;

            const oldSource = container.dataset.weightSource || 'weight2';
            container.dataset.weightSource = source;

            const currentImages = Array.from(container.querySelectorAll('img'));
            const widthMm = currentImages[0]?.dataset.widthMm || '50';
            const heightMm = currentImages[0]?.dataset.heightMm || '37.5';

            if (source === 'both') {
                // Passaggio a "both": duplica le immagini aggiungendo l'altra sorgente
                const count = currentImages.length;
                const otherSource = oldSource === 'weight1' ? 'weight2' : 'weight1';

                // Aggiorna le immagini esistenti con data-source
                currentImages.forEach((img, index) => {
                    img.dataset.source = oldSource;
                    img.src = `{{ ${oldSource}.weighing_pictures[${index}:${index+1}]|map(attribute='path_name')|first|default('') }}`;
                });

                // Aggiungi le immagini dell'altra sorgente
                for (let i = 0; i < count; i++) {
                    const img = document.createElement('img');
                    img.src = `{{ ${otherSource}.weighing_pictures[${i}:${i+1}]|map(attribute='path_name')|first|default('') }}`;
                    img.alt = `${otherSource === 'weight1' ? 'Entrata' : 'Uscita'} img ${i + 1}`;
                    img.style.width = widthMm + 'mm';
                    img.style.height = heightMm + 'mm';
                    img.dataset.widthMm = widthMm;
                    img.dataset.heightMm = heightMm;
                    img.dataset.source = otherSource;
                    container.appendChild(img);
                }

                // Riordina: prima weight1, poi weight2
                const weight1Images = Array.from(container.querySelectorAll('img[data-source="weight1"]'));
                const weight2Images = Array.from(container.querySelectorAll('img[data-source="weight2"]'));
                container.innerHTML = '';
                weight1Images.forEach(img => container.appendChild(img));
                weight2Images.forEach(img => container.appendChild(img));

            } else if (oldSource === 'both') {
                // Passaggio da "both" a singola sorgente: mantieni solo le immagini della sorgente selezionata
                const imagesToKeep = container.querySelectorAll(`img[data-source="${source}"]`);
                const imagesToRemove = container.querySelectorAll(`img[data-source]:not([data-source="${source}"])`);
                const altPrefix = source === 'weight1' ? 'Entrata' : 'Uscita';

                imagesToRemove.forEach(img => img.remove());

                // Aggiorna gli indici delle immagini rimanenti
                imagesToKeep.forEach((img, index) => {
                    img.src = `{{ ${source}.weighing_pictures[${index}:${index+1}]|map(attribute='path_name')|first|default('') }}`;
                    img.alt = `${altPrefix} img ${index + 1}`;
                });

            } else {
                // Passaggio tra weight1 e weight2: aggiorna tutte le sorgenti
                const altPrefix = source === 'weight1' ? 'Entrata' : 'Uscita';
                currentImages.forEach((img, index) => {
                    img.dataset.source = source;
                    img.src = `{{ ${source}.weighing_pictures[${index}:${index+1}]|map(attribute='path_name')|first|default('') }}`;
                    img.alt = `${altPrefix} img ${index + 1}`;
                });
            }

            showProperties(selectedElement);
        }

        function changeCarouselImageWidth(value) {
            if (!selectedElement) return;
            const container = selectedElement.querySelector('[data-carousel-container]');
            if (!container) return;

            const images = container.querySelectorAll('img');
            images.forEach(img => {
                if (value.trim() === '') {
                    img.style.width = 'auto';
                    img.dataset.widthMm = '';
                } else {
                    const width = parseFloat(value) || 50;
                    img.style.width = width + 'mm';
                    img.dataset.widthMm = width;
                }
            });
        }

        function changeCarouselImageHeight(value) {
            if (!selectedElement) return;
            const container = selectedElement.querySelector('[data-carousel-container]');
            if (!container) return;

            const images = container.querySelectorAll('img');
            images.forEach(img => {
                if (value.trim() === '') {
                    img.style.height = 'auto';
                    img.dataset.heightMm = '';
                } else {
                    const height = parseFloat(value) || 37.5;
                    img.style.height = height + 'mm';
                    img.dataset.heightMm = height;
                }
            });
        }

        function changeCarouselGap(value) {
            if (!selectedElement) return;
            const container = selectedElement.querySelector('[data-carousel-container]');
            if (!container) return;

            const gap = parseFloat(value) || 0;
            container.style.gap = gap + 'mm';
        }

        function changeCarouselAlignment(alignment) {
            if (!selectedElement) return;
            const container = selectedElement.querySelector('[data-carousel-container]');
            if (!container) return;

            container.style.justifyContent = alignment;
        }

        function insertQuickVariable(variable) {
            if (!selectedElement || !variable) return;
            insertTextAtCursor(variable);
        }

        function insertTextAtCursor(text) {
            if (!selectedElement) return;
            
            const editableElement = findEditableElement(selectedElement);
            if (editableElement) {
                const selection = window.getSelection();
                if (selection.rangeCount > 0) {
                    const range = selection.getRangeAt(0);
                    
                    if (editableElement.contains(range.commonAncestorContainer)) {
                        range.deleteContents();
                        const textNode = document.createTextNode(text);
                        range.insertNode(textNode);
                        
                        range.setStartAfter(textNode);
                        range.setEndAfter(textNode);
                        selection.removeAllRanges();
                        selection.addRange(range);
                    } else {
                        editableElement.focus();
                        const newText = document.createTextNode(' ' + text);
                        editableElement.appendChild(newText);
                    }
                } else {
                    editableElement.focus();
                    const newText = document.createTextNode(' ' + text);
                    editableElement.appendChild(newText);
                }
            }
        }

        function changeTableFontSize(size) {
            if (!selectedElement) return;
            const table = selectedElement.querySelector('table');
            if (table) {
                table.style.fontSize = size + 'pt';
            }
        }

        function changeTablePadding(padding) {
            if (!selectedElement) return;
            const table = selectedElement.querySelector('table');
            if (table) {
                table.dataset.padding = padding + 'mm';
                const cells = table.querySelectorAll('td, th');
                cells.forEach(cell => {
                    cell.style.padding = `${padding}mm ${parseFloat(padding) * 1.5}mm`;
                });
            }
        }

        function changeCellAlignment(alignment) {
            if (!selectedTableCell) return;
            selectedTableCell.style.textAlign = alignment;
        }

        function changeCellFontWeight(weight) {
            if (!selectedTableCell) return;
            selectedTableCell.style.fontWeight = weight;
        }

        function changeCellColspan(colspan) {
            if (!selectedTableCell) return;
            const table = selectedTableCell.closest('table');
            const row = selectedTableCell.closest('tr');
            const colspanValue = Math.max(1, parseInt(colspan) || 1);
            const oldColspan = parseInt(selectedTableCell.getAttribute('data-colspan') || '1');
            const padding = table.dataset.padding ? table.dataset.padding.replace('mm', '') : '2';

            let currentIndex = 0;
            let cellIndex = 0;
            row.querySelectorAll('th, td').forEach((cell, idx) => {
                if (cell === selectedTableCell) {
                    cellIndex = idx;
                }
                const span = parseInt(cell.getAttribute('data-colspan') || '1');
                currentIndex += span;
                if (cell === selectedTableCell) {
                    currentIndex -= span;
                }
            });

            if (colspanValue > oldColspan) {
                let nextCell = selectedTableCell.nextElementSibling;
                for (let i = oldColspan; i < colspanValue; i++) {
                    if (nextCell && (nextCell.tagName === 'TD' || nextCell.tagName === 'TH')) {
                        nextCell.remove();
                        nextCell = selectedTableCell.nextElementSibling;
                    } else {
                        break;
                    }
                }
            } else if (colspanValue < oldColspan) {
                for (let i = oldColspan - 1; i >= colspanValue; i--) {
                    const newCell = document.createElement(selectedTableCell.tagName === 'TH' ? 'th' : 'td');
                    newCell.style.border = '0.3mm solid #ddd';
                    newCell.style.padding = `${padding}mm ${parseFloat(padding) * 1.5}mm`;
                    newCell.style.textAlign = 'left';
                    newCell.style.whiteSpace = 'nowrap';
                    newCell.style.overflow = 'hidden';
                    newCell.contentEditable = true;
                    newCell.setAttribute('data-colspan', '1');
                    newCell.textContent = '';
                    newCell.addEventListener('click', function(e) {
                        e.stopPropagation();
                        selectTableCell(this);
                    });
                    row.insertBefore(newCell, selectedTableCell.nextElementSibling);
                }
            }

            selectedTableCell.setAttribute('colspan', colspanValue);
            selectedTableCell.setAttribute('data-colspan', colspanValue);

            const tableWrapper = selectedTableCell.closest('.dropped-element');
            if (tableWrapper) {
                setupTableCellSelection(tableWrapper);
            }
        }

        function changeHeadingSize(size) {
            if (!selectedElement) return;
            const heading = selectedElement.querySelector('h1, h2, h3, h4, h5, h6');
            if (heading) {
                const newHeading = document.createElement(size);
                newHeading.contentEditable = true;
                newHeading.textContent = heading.textContent;
                // Preserva gli stili esistenti
                newHeading.style.whiteSpace = heading.style.whiteSpace;
                newHeading.style.overflow = heading.style.overflow;
                newHeading.style.fontFamily = heading.style.fontFamily;
                heading.parentNode.replaceChild(newHeading, heading);
            }
        }

        function changeAlignment(alignment) {
            if (!selectedElement) return;
            selectedElement.style.textAlign = alignment;
        }

        function changeTextWrap(wrapValue) {
            if (!selectedElement) return;
            const textElement = selectedElement.querySelector('h1, h2, h3, h4, h5, h6, p');
            if (textElement) {
                textElement.style.whiteSpace = wrapValue;
                
                // Imposta automaticamente overflow in base al comportamento testo
                if (wrapValue === 'nowrap') {
                    // Riga singola ‚Üí testo tagliato
                    textElement.style.overflow = 'hidden';
                } else {
                    // A capo automatico (pre-wrap) ‚Üí testo visibile
                    textElement.style.overflow = 'visible';
                }
            }
        }

        function changeFontSize(size) {
            if (!selectedElement) return;
            selectedElement.style.fontSize = size + 'pt';
        }

        function changeTableColumns(event, cols) {
            if (!selectedElement) return;
            const table = selectedElement.querySelector('table');
            if (!table) return;
            
            const newCols = parseInt(cols) || 3;
            const thead = table.querySelector('thead tr');
            const tbodyRows = table.querySelectorAll('tbody tr');
            const currentEffectiveCols = getEffectiveColumnCount(thead);
            const padding = table.dataset.padding ? table.dataset.padding.replace('mm', '') : '2';
            
            if (newCols > currentEffectiveCols) {
                const cellsToAdd = newCols - currentEffectiveCols;
                const allRows = [thead, ...Array.from(tbodyRows)];
                allRows.forEach((row, rowIndex) => {
                    const isHeader = rowIndex === 0;
                    for (let i = 0; i < cellsToAdd; i++) {
                        const newCell = isHeader ? document.createElement('th') : document.createElement('td');
                        newCell.style.border = '0.3mm solid #ddd';
                        newCell.style.padding = `${padding}mm ${parseFloat(padding) * 1.5}mm`;
                        newCell.style.textAlign = 'left';
                        newCell.style.whiteSpace = 'nowrap';
                        newCell.style.overflow = 'hidden';
                        newCell.contentEditable = true;
                        newCell.setAttribute('data-colspan', '1');
                        newCell.textContent = isHeader ? `Colonna ${currentEffectiveCols + i + 1}` : `Dato ${currentEffectiveCols + i + 1}`;
                        newCell.addEventListener('click', function(e) {
                            e.stopPropagation();
                            selectTableCell(this);
                        });
                        row.appendChild(newCell);
                    }
                });
            } else if (newCols < currentEffectiveCols) {
                const cellsToRemove = currentEffectiveCols - newCols;
                const allRows = [thead, ...Array.from(tbodyRows)];
                allRows.forEach(row => {
                    let removed = 0;
                    while (removed < cellsToRemove) {
                        const lastCell = row.lastElementChild;
                        if (lastCell) {
                            const span = parseInt(lastCell.getAttribute('data-colspan') || '1');
                            if (span > 1) {
                                lastCell.setAttribute('data-colspan', span - 1);
                                lastCell.setAttribute('colspan', span - 1);
                            } else {
                                lastCell.remove();
                            }
                            removed += 1;
                        } else {
                            break;
                        }
                    }
                });
            }
            selectTableCell(selectedTableCell);
            document.getElementById('inputTableColumns').focus();
        }

        function changeTableRows(rows) {
            if (!selectedElement) return;
            const table = selectedElement.querySelector('table');
            if (!table) return;
            
            const newRows = parseInt(rows) || 1;
            const tbody = table.querySelector('tbody');
            const currentRows = tbody.children.length;
            const theadRow = table.querySelector('thead tr');
            const effectiveCols = getEffectiveColumnCount(theadRow);
            const padding = table.dataset.padding ? table.dataset.padding.replace('mm', '') : '2';
            
            if (newRows > currentRows) {
                for (let i = currentRows; i < newRows; i++) {
                    const tr = document.createElement('tr');
                    for (let j = 0; j < effectiveCols; j++) {
                        const td = document.createElement('td');
                        td.style.border = '0.3mm solid #ddd';
                        td.style.padding = `${padding}mm ${parseFloat(padding) * 1.5}mm`;
                        td.style.textAlign = 'left';
                        td.style.whiteSpace = 'nowrap';
                        td.style.overflow = 'hidden';
                        td.contentEditable = true;
                        td.setAttribute('data-colspan', '1');
                        td.textContent = `Dato ${j + 1}`;
                        td.addEventListener('click', function(e) {
                            e.stopPropagation();
                            selectTableCell(this);
                        });
                        tr.appendChild(td);
                    }
                    tbody.appendChild(tr);
                }
            } else if (newRows < currentRows) {
                while (tbody.children.length > newRows) {
                    tbody.removeChild(tbody.lastElementChild);
                }
            }
            selectTableCell(selectedTableCell);
            document.getElementById('inputTableRows').focus();
        }

        function changeMarginTop(value) {
            if (!selectedElement) return;
            selectedElement.style.marginTop = value + 'mm';
        }

        function changeMarginBottom(value) {
            if (!selectedElement) return;
            selectedElement.style.marginBottom = value + 'mm';
        }

        function changeDividerThickness(value) {
            if (!selectedElement) return;
            const hr = selectedElement.querySelector('hr');
            if (hr) {
                hr.style.borderTopWidth = value + 'px';
            }
        }

        function insertTextInTableCell(cell, text) {
            if (!cell) return;
            
            cell.focus();
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
                const range = selection.getRangeAt(0);
                
                if (cell.contains(range.commonAncestorContainer)) {
                    range.deleteContents();
                    const textNode = document.createTextNode(text);
                    range.insertNode(textNode);
                    
                    range.setStartAfter(textNode);
                    range.setEndAfter(textNode);
                    selection.removeAllRanges();
                    selection.addRange(range);
                } else {
                    const newText = document.createTextNode(' ' + text);
                    cell.appendChild(newText);
                }
            } else {
                const newText = document.createTextNode(' ' + text);
                cell.appendChild(newText);
            }
        }

        function findEditableElement(element) {
            if (element.dataset.type === 'table' && selectedTableCell) {
                return selectedTableCell;
            }
            
            const editable = element.querySelector('[contenteditable="true"]');
            if (editable) return editable;
            
            if (element.contentEditable === 'true') return element;
            
            return null;
        }

        function moveUp(btn) {
            const element = btn.closest('.dropped-element');
            const prev = element.previousElementSibling;
            if (prev) {
                element.parentNode.insertBefore(element, prev);
            }
        }

        function moveDown(btn) {
            const element = btn.closest('.dropped-element');
            const next = element.nextElementSibling;
            if (next) {
                element.parentNode.insertBefore(next, element);
            }
        }

        function deleteElement(btn) {
            const element = btn.closest('.dropped-element');
            if (element) {
                element.remove();
                selectedElement = null;
                selectedTableCell = null;
                showProperties(null);
            }
        }

        function getPageSize(pageFormat, marginTop, marginRight, marginBottom, marginLeft) {
            let size;
            let pageStyle;
            let fontSize;

            switch(pageFormat) {
                case 'A4':
                    size = pageFormat;
                    pageStyle = `width: 210mm; height: 297mm; padding: ${marginTop} ${marginRight} ${marginBottom} ${marginLeft};`;
                    fontSize = '12pt';
                    break;
                case 'A5':
                    size = pageFormat;
                    pageStyle = `width: 148mm; height: 210mm; padding: ${marginTop} ${marginRight} ${marginBottom} ${marginLeft};`;
                    fontSize = '10pt';
                    break;
                case 'A6':
                    size = pageFormat;
                    pageStyle = `width: 105mm; height: 148mm; padding: ${marginTop} ${marginRight} ${marginBottom} ${marginLeft};`;
                    fontSize = '9pt';
                    break;
                case 'A7':
                    size = pageFormat;
                    pageStyle = `width: 74mm; height: 105mm; padding: ${marginTop} ${marginRight} ${marginBottom} ${marginLeft};`;
                    fontSize = '8pt';
                    break;
                case 'A8':
                    size = pageFormat;
                    pageStyle = `width: 52mm; height: 74mm; padding: ${marginTop} ${marginRight} ${marginBottom} ${marginLeft};`;
                    fontSize = '7pt';
                    break;
                case 'Custom':
                    const customWidthInput = document.getElementById('customWidth').value.trim();
                    const customHeightInput = document.getElementById('customHeight').value.trim();
                    
                    const customWidth = customWidthInput === '' ? 'auto' : (parseInt(customWidthInput) + 'mm');
                    const customHeight = customHeightInput === '' ? 'auto' : (parseInt(customHeightInput) + 'mm');
                    
                    size = `${customWidth} ${customHeight}`;
                    pageStyle = `width: ${customWidth}; height: ${customHeight}; padding: ${marginTop} ${marginRight} ${marginBottom} ${marginLeft};`;
                    fontSize = '11pt';
                    break;
                case 'Receipt80':
                    const originalCanvas = document.getElementById('canvas');
                    let currentOriginalCanvas = originalCanvas.style.minHeight;
                    originalCanvas.style.minHeight = "auto";
                    const contentHeight = originalCanvas.scrollHeight;
                    
                    const actualContentHeight = contentHeight / (currentZoom / 100);
                    
                    const contentHeightMm = Math.ceil(actualContentHeight / 3.78);
                    const totalHeightMm = contentHeightMm;

                    size = `80mm ${totalHeightMm}mm`;
                    pageStyle = `width: 80mm; padding: ${marginTop} ${marginRight} ${marginBottom} ${marginLeft}; background: white;`;
                    fontSize = '8pt';
                    originalCanvas.style.minHeight = currentOriginalCanvas;
                    break;
            }

            return {
                size, 
                pageStyle, 
                fontSize
            }
        }

        function generateTemplate() {
            let content = '';
            const allPages = document.querySelectorAll('.canvas');
            const pageFormat = document.getElementById('pageFormat').value;
            const marginTop = document.getElementById('marginTop').value + 'mm';
            const marginLeft = document.getElementById('marginLeft').value + 'mm';
            const marginRight = document.getElementById('marginRight').value + 'mm';
            const marginBottom = document.getElementById('marginBottom').value + 'mm';

            let { size, pageStyle, fontSize } = getPageSize(pageFormat, marginTop, marginRight, marginBottom, marginLeft);

            allPages.forEach((page, index) => {
                const pageClone = page.cloneNode(true);

                pageClone.querySelectorAll('.element-controls').forEach(el => el.remove());
                pageClone.querySelectorAll('.dropped-element').forEach(el => {
                    el.classList.remove('dropped-element', 'selected');
                    el.removeAttribute('data-element-id');
                    el.removeAttribute('data-type');
                    el.style.border = 'none';
                    el.style.background = 'none';
                });
                
                pageClone.querySelectorAll('.table-cell-selected').forEach(el => {
                    el.classList.remove('table-cell-selected');
                });
                
                pageClone.querySelectorAll('[contenteditable]').forEach(el => {
                    el.removeAttribute('contenteditable');
                });
                
                pageClone.querySelectorAll('[data-colspan]').forEach(el => {
                    const colspan = el.getAttribute('data-colspan');
                    if (colspan && colspan !== '1') {
                        el.setAttribute('colspan', colspan);
                    }
                    el.removeAttribute('data-colspan');
                });

                pageClone.querySelectorAll('.vertical-guide').forEach(el => el.remove());

                let pageContent = `<div class="report-container"`;
                if (index > 0) {
                    pageContent += ` style="page-break-before: always; ${pageStyle}"`;
                } else {
                    pageContent += ` style="${pageStyle}"`;
                }
                pageContent += `>
${pageClone.innerHTML}
</div>`;

                content += pageContent;
            });

            const template = `<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ titolo_report | default('Report') }}</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        @page {
            size: ${size};
            margin: 0mm;
        }

        body {
            font-family: ${globalFont};
            color: #333;
            margin: 0;
            font-size: ${fontSize};
        }
        
        .report-container {
            background: white;
            margin-left: auto;
            margin-right: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        h1, h2, h3, h4, h5, h6 {
            color: #2c3e50;
        }

        p {
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: inherit;
            table-layout: fixed;
        }
        
        th, td {
            border: 0.3mm solid #ddd;
            padding: 2mm 3mm;
            text-align: left;
            white-space: nowrap;
            overflow: hidden;
        }
        
        th {
            background-color: #f8f9fa;
            font-weight: bold;
        }
        
        img {
            max-width: 100%;
            height: auto;
        }
        
        .page-break {
            page-break-after: always;
        }
    </style>
</head>
<body>
    ${content}
</body>
</html>`;
            
            return template;
        }

        function showCode() {
            const code = generateTemplate();
            document.getElementById('codeOutput').textContent = code;
            document.getElementById('codeModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('codeModal').style.display = 'none';
        }

        function copyCode() {
            const code = document.getElementById('codeOutput').textContent;
            navigator.clipboard.writeText(code).then(() => {
                alert('Codice copiato negli appunti!');
            }).catch(err => {
                console.error('Errore nella copia:', err);
                const textarea = document.createElement('textarea');
                textarea.value = code;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                alert('Codice copiato negli appunti!');
            });
        }

        function downloadTemplate() {
            const code = document.getElementById('codeOutput').textContent;
            const blob = new Blob([code], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'report_template.html';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function previewReport() {
            const template = generateTemplate();
            const previewWindow = window.open('', '_blank');
            previewWindow.document.write(template);
            previewWindow.document.close();
        }

        document.addEventListener('click', function(e) {
            if (e.target.id === 'canvas' || e.target.classList.contains('design-area')) {
                document.querySelectorAll('.dropped-element').forEach(el => {
                    el.classList.remove('selected');
                });
                document.querySelectorAll('.table-cell-selected').forEach(el => {
                    el.classList.remove('table-cell-selected');
                });
                selectedElement = null;
                selectedTableCell = null;
                document.getElementById('propertiesContent').innerHTML = `
                    <p style="color: #999; text-align: center; margin-top: 20px;">
                        Seleziona un elemento per modificarne le propriet√†
                    </p>
                `;
            }
        });

        document.addEventListener('keydown', function(e) {
            if (selectedElement) {
                if (e.key === 'Delete') {
                    selectedElement.remove();
                    selectedElement = null;
                    selectedTableCell = null;
                    document.getElementById('propertiesContent').innerHTML = `
                        <p style="color: #999; text-align: center; margin-top: 20px;">
                            Seleziona un elemento per modificarne le propriet√†
                        </p>
                    `;
                } else if (e.ctrlKey && e.key === 'c') {
                    localStorage.setItem('copiedElement', selectedElement.outerHTML);
                } else if (e.ctrlKey && e.key === 'v') {
                    const copiedHTML = localStorage.getItem('copiedElement');
                    if (copiedHTML) {
                        const canvas = document.getElementById('canvas');
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = copiedHTML;
                        const newElement = tempDiv.firstChild;
                        newElement.dataset.elementId = `element_${++elementCounter}`;
                        canvas.appendChild(newElement);
                        makeElementInteractive(newElement);
                    }
                }
            }
        });

        function updateGlobalFont(font) {
            globalFont = font;
            document.querySelectorAll('.canvas').forEach(page => {
                page.style.fontFamily = font;
            });
        }

        function changeElementFont(font) {
            if (!selectedElement) return;
            selectedElement.style.fontFamily = font;
            if (selectedElement.dataset.type === 'table') {
                const table = selectedElement.querySelector('table');
                if (table) {
                    table.style.fontFamily = font;
                }
            }
            if (selectedElement.dataset.type === 'heading') {
                const heading = selectedElement.querySelector('h1, h2, h3, h4');
                if (heading) {
                    heading.style.fontFamily = font;
                }
            }
        }

        async function saveProject(report) {
            let loadingNotification = null;
            
            try {
                const pagesContainer = document.getElementById('pagesContainer');
                const pageFormat = document.getElementById('pageFormat').value;
                const marginTop = document.getElementById('marginTop').value;
                const marginBottom = document.getElementById('marginBottom').value;
                const marginLeft = document.getElementById('marginLeft').value;
                const marginRight = document.getElementById('marginRight').value;

                function cleanHtml(html) {
                    return html
                        .replace(/\n/g, ' ')
                        .replace(/\s+/g, ' ')
                        // RIMOSSA la riga: .replace(/"/g, "'")
                        .trim();
                }

                let formatValue = pageFormat;
                if (pageFormat === 'Custom') {
                    const wInput = document.getElementById('customWidth').value.trim();
                    const hInput = document.getElementById('customHeight').value.trim();
                    
                    let width, height;
                    
                    if (wInput === '') {
                        const firstCanvas = document.querySelector('.canvas');
                        if (firstCanvas) {
                            const actualWidth = firstCanvas.scrollWidth / (currentZoom / 100);
                            const widthMm = Math.ceil(actualWidth / 3.78);
                            width = widthMm + 'mm';
                        } else {
                            width = 'auto';
                        }
                    } else {
                        width = wInput + 'mm';
                    }
                    
                    if (hInput === '') {
                        const firstCanvas = document.querySelector('.canvas');
                        if (firstCanvas) {
                            const currentMinHeight = firstCanvas.style.minHeight;
                            firstCanvas.style.minHeight = "auto";
                            const actualHeight = firstCanvas.scrollHeight / (currentZoom / 100);
                            const heightMm = Math.ceil(actualHeight / 3.78);
                            height = heightMm + 'mm';
                            firstCanvas.style.minHeight = currentMinHeight;
                        } else {
                            height = 'auto';
                        }
                    } else {
                        height = hInput + 'mm';
                    }
                    
                    formatValue = `${width} ${height}`;
                }

                const state = {
                    canvas: cleanHtml(pagesContainer.innerHTML),
                    html: cleanHtml(generateTemplate()),
                    format: formatValue,
                    margins: {
                        top: marginTop,
                        bottom: marginBottom,
                        left: marginLeft,
                        right: marginRight
                    },
                    zoom: currentZoom,
                    elementCounter: elementCounter,
                    totalPages: totalPages,
                    globalFont: globalFont
                };

                const jsonState = JSON.stringify(state);

                loadingNotification = showNotification('Salvataggio in corso...', false, true);
                
                const zip = new JSZip();
                zip.file('report_project.json', jsonState);
                
                const zipBlob = await zip.generateAsync({
                    type: 'blob',
                    compression: 'DEFLATE',
                    compressionOptions: { level: 9 }
                });

                const formData = new FormData();
                formData.append('file', zipBlob, 'report_project.zip');
                
                const response = await fetch(`/api/generic/report/${report}`, {
                    method: 'POST',
                    body: formData
                });

                if (loadingNotification) {
                    loadingNotification.remove();
                }

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Errore server');
                }

                const data = await response.json();
                console.log('Risposta server:', data);
                
                showNotification('‚úÖ Progetto salvato con successo sul server!');
                
                return data;

            } catch (error) {
                if (loadingNotification) {
                    loadingNotification.remove();
                }
                
                console.error('Errore:', error);
                showNotification(`‚ùå Errore: ${error.message}`, true);
                throw error;
            }
        }

        function downloadProjectLocal() {
            try {
                // Chiedi il nome del file all'utente
                const fileName = prompt('Come vuoi chiamare il file?', 'report');
                
                // Se l'utente annulla o non inserisce nulla, esci
                if (fileName === null || fileName.trim() === '') {
                    showNotification('Download annullato', false);
                    return;
                }
                
                // Pulisci il nome del file (rimuovi caratteri non validi)
                const cleanFileName = fileName.trim().replace(/[^a-z0-9_\-]/gi, '_');
                
                const pagesContainer = document.getElementById('pagesContainer');
                const pageFormat = document.getElementById('pageFormat').value;
                const marginTop = document.getElementById('marginTop').value;
                const marginBottom = document.getElementById('marginBottom').value;
                const marginLeft = document.getElementById('marginLeft').value;
                const marginRight = document.getElementById('marginRight').value;

                function cleanHtml(html) {
                    return html
                        .replace(/\n/g, ' ')
                        .replace(/\s+/g, ' ')
                        // RIMOSSA la riga: .replace(/"/g, "'")
                        .trim();
                }

                let formatValue = pageFormat;
                if (pageFormat === 'Custom') {
                    const wInput = document.getElementById('customWidth').value.trim();
                    const hInput = document.getElementById('customHeight').value.trim();
                    
                    let width, height;
                    
                    if (wInput === '') {
                        const firstCanvas = document.querySelector('.canvas');
                        if (firstCanvas) {
                            const actualWidth = firstCanvas.scrollWidth / (currentZoom / 100);
                            const widthMm = Math.ceil(actualWidth / 3.78);
                            width = widthMm + 'mm';
                        } else {
                            width = 'auto';
                        }
                    } else {
                        width = wInput + 'mm';
                    }
                    
                    if (hInput === '') {
                        const firstCanvas = document.querySelector('.canvas');
                        if (firstCanvas) {
                            const currentMinHeight = firstCanvas.style.minHeight;
                            firstCanvas.style.minHeight = "auto";
                            const actualHeight = firstCanvas.scrollHeight / (currentZoom / 100);
                            const heightMm = Math.ceil(actualHeight / 3.78);
                            height = heightMm + 'mm';
                            firstCanvas.style.minHeight = currentMinHeight;
                        } else {
                            height = 'auto';
                        }
                    } else {
                        height = hInput + 'mm';
                    }
                    
                    formatValue = `${width} ${height}`;
                }

                const state = {
                    canvas: cleanHtml(pagesContainer.innerHTML),
                    html: cleanHtml(generateTemplate()),
                    format: formatValue,
                    margins: {
                        top: marginTop,
                        bottom: marginBottom,
                        left: marginLeft,
                        right: marginRight
                    },
                    zoom: currentZoom,
                    elementCounter: elementCounter,
                    totalPages: totalPages,
                    globalFont: globalFont
                };

                const jsonState = JSON.stringify(state);
                const blob = new Blob([jsonState], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${cleanFileName}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showNotification(`üì• Download completato: ${cleanFileName}.json`);
            } catch (error) {
                console.error('Errore download:', error);
                showNotification('‚ùå Errore nel download locale', true);
            }
        }

        function importProject() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(event) {
                    const content = event.target.result;
                    let state;
                    try {
                        state = JSON.parse(content);
                    } catch (err) {
                        alert('File non valido. Assicurati di importare un file .json del progetto.');
                        return;
                    }
                    
                    loadProjectState(state);
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function loadProjectState(state, showNotificationMessage = true) {
            const pagesContainer = document.getElementById('pagesContainer');
            
            // CORREZIONE: Usa DOMParser invece di innerHTML per evitare problemi con gli apici
            const parser = new DOMParser();
            const doc = parser.parseFromString(state.canvas, 'text/html');
            
            // Svuota il container
            pagesContainer.innerHTML = '';
            
            // Copia i nodi dal documento parsato
            Array.from(doc.body.childNodes).forEach(node => {
                pagesContainer.appendChild(node.cloneNode(true));
            });
            
            const allElements = pagesContainer.querySelectorAll('.dropped-element');
            allElements.forEach(el => {
                makeElementInteractive(el);
                if (el.dataset.type === 'table') {
                    setupTableCellSelection(el);
                }
            });
            
            const allCanvases = pagesContainer.querySelectorAll('.canvas');
            allCanvases.forEach(canvas => {
                canvas.removeEventListener('dragover', canvas._dragOverHandler);
                canvas.removeEventListener('drop', canvas._dropHandler);
                canvas.removeEventListener('dragleave', canvas._dragLeaveHandler);
                
                canvas._dragOverHandler = handleDragOver;
                canvas._dropHandler = handleDrop;
                canvas._dragLeaveHandler = handleDragLeave;
                
                canvas.addEventListener('dragover', canvas._dragOverHandler);
                canvas.addEventListener('drop', canvas._dropHandler);
                canvas.addEventListener('dragleave', canvas._dragLeaveHandler);
            });
            
            elementCounter = state.elementCounter || allElements.length;
            totalPages = state.totalPages || allCanvases.length;
            
            let formatType = state.format;
            let customWidth = '';
            let customHeight = '';
            
            if (state.format && !['A4', 'A5', 'A6', 'A7', 'A8', 'Receipt80'].includes(state.format)) {
                formatType = 'Custom';
                const parts = state.format.split(' ');
                if (parts.length === 2) {
                    customWidth = parts[0].replace('mm', '');
                    customHeight = parts[1].replace('mm', '');
                }
            }
            
            if (formatType) {
                document.getElementById('pageFormat').value = formatType;
                
                if (formatType === 'Custom') {
                    document.getElementById('customWidth').value = customWidth;
                    document.getElementById('customHeight').value = customHeight;
                    document.getElementById('customSizeSection').style.display = 'block';
                } else {
                    document.getElementById('customSizeSection').style.display = 'none';
                }
            } else if (allCanvases.length > 0) {
                const firstCanvas = allCanvases[0];
                const formatClass = firstCanvas.className.split(' ')[1] || 'A4';
                document.getElementById('pageFormat').value = formatClass;
            }
            
            if (state.margins) {
                document.getElementById('marginTop').value = state.margins.top;
                document.getElementById('marginBottom').value = state.margins.bottom;
                document.getElementById('marginLeft').value = state.margins.left;
                document.getElementById('marginRight').value = state.margins.right;
            } else if (allCanvases.length > 0) {
                const firstCanvas = allCanvases[0];
                document.getElementById('marginTop').value = firstCanvas.style.paddingTop.replace('mm', '') || 25;
                document.getElementById('marginBottom').value = firstCanvas.style.paddingBottom.replace('mm', '') || 25;
                document.getElementById('marginLeft').value = firstCanvas.style.paddingLeft.replace('mm', '') || 25;
                document.getElementById('marginRight').value = firstCanvas.style.paddingRight.replace('mm', '') || 25;
            }
            
            importedFileFormat = document.getElementById('pageFormat').value;
            importedFilePadding = {
                top: document.getElementById('marginTop').value,
                bottom: document.getElementById('marginBottom').value,
                left: document.getElementById('marginLeft').value,
                right: document.getElementById('marginRight').value
            };
            
            if (importedFileFormat === 'Custom') {
                importedCustomSize = {
                    width: customWidth,
                    height: customHeight
                };
            } else {
                importedCustomSize = null;
            }
            
            currentZoom = state.zoom || 100;
            applyZoom();
            updateZoomDisplay();

            globalFont = state.globalFont || "Arial, sans-serif";
            document.getElementById('globalFont').value = globalFont;
            updateGlobalFont(globalFont);
            
            changePageFormat(true);
            
            selectedElement = null;
            selectedTableCell = null;
            document.querySelectorAll('.dropped-element').forEach(el => el.classList.remove('selected'));
            document.querySelectorAll('.table-cell-selected').forEach(el => el.classList.remove('table-cell-selected'));
            document.getElementById('propertiesContent').innerHTML = `
                <p style="color: #999; text-align: center; margin-top: 20px;">
                    Seleziona un elemento per modificarne le propriet√†
                </p>
            `;
            
            if (showNotificationMessage) showNotification('Progetto importato con successo! Ora puoi modificarlo.');
        }

        async function populateTemplates(type_default_report) {
            const select = document.getElementById('defaultReportSelect');
            const baseUrl = '/api/generic/list/default-reports';
            
            select.innerHTML = '<option value="">--Seleziona Template--</option>';
            
            try {
                const response = await fetch(baseUrl);
                if (!response.ok) throw new Error('Directory non accessibile');
                
                const data = await response.json();
                
                Object.keys(data).forEach(folder => {
                    data[folder].forEach(file => {
                        if (file.includes(type_default_report)) {
                            const option = document.createElement('option');
                            option.value = `/static/content/report/default-report/${folder}/${file}`;
                            option.textContent = file;
                            select.appendChild(option);
                        }
                    });
                });
            } catch (err) {
                console.error('Errore nel caricamento dei template default:', err);
                showNotification('Impossibile caricare i template default. Verifica il server.');
            }
        }

        function loadDefaultTemplate(url, showNotificationMessage = true) {
            url = window.location.origin + url;
            fetch(url, {
                cache: 'no-store',
                headers: {
                    'Cache-Control': 'no-cache'
                }
            })
            .then(resp => {
                if (!resp.ok) throw new Error('Template non accessibile');
                return resp.json();
            })
            .then(state => {
                loadProjectState(state, showNotificationMessage);
            })
            .catch(err => {
                console.error('Errore nel caricamento del template:', err);
                alert('Errore nel caricamento del template default');
            });
        }
    </script>
</body>
</html>