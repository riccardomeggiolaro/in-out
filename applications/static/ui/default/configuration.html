<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" href="/static/content/baronpesi_favicon.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="/static/css/snackbar.css">
    <link rel="stylesheet" href="/static/css/setup.css"></link>
    <style>
        .form-group { margin-bottom: 12px; }
        .form-group label { font-weight: 500; }
        .instance-container { display: none; }
        .instance-container.active { display: block; }
        .instance-sub-menu { margin-bottom: 20px; }
        .node-sub-menu { margin: 10px 0; }
        .node-tab-content { display: none; }
        .node-tab-content.active { display: block; }

        /* Stile tab Chrome */
        #sub-menu,
        #instance-sub-menu,
        .node-sub-menu {
            display: flex;
            gap: 0;
            border-bottom: 2px solid #dee1e6;
            padding: 0;
            margin-bottom: 0;
        }

        .menu-tab {
            position: relative;
            background: #f1f3f4;
            border: none;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
            padding: 10px 20px;
            padding-right: 35px;
            margin-right: 2px;
            margin-bottom: -2px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            opacity: 1;
            pointer-events: auto;
            box-shadow: none;
            color: #5f6368;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .menu-tab:hover:not(.selected) {
            background: #e8eaed;
            box-shadow: none;
        }

        .menu-tab.selected {
            background: white;
            color: #1967d2;
            border-bottom: 2px solid white;
            z-index: 1;
            box-shadow: 
                0 1px 3px rgba(0, 0, 0, 0.1),
                -1px 0 0 rgba(0, 0, 0, 0.04),
                1px 0 0 rgba(0, 0, 0, 0.04);
        }

        .menu-tab:enabled {
            opacity: 1;
            pointer-events: auto;
        }

        .menu-tab.add-tab {
            background: transparent;
            color: #5f6368;
            font-size: 20px;
            padding: 10px 15px;
            margin-left: auto;
        }

        .menu-tab.add-tab:hover {
            background: #f1f3f4;
        }

        /* Stile X per chiudere tab */
        .tab-close {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            line-height: 1;
            color: #5f6368;
            background: transparent;
            transition: all 0.2s ease;
            cursor: pointer;
            padding: 0;
            border: none;
            box-shadow: none;
            opacity: 1;
            pointer-events: auto;
        }

        .menu-tab:hover .tab-close {
            display: flex;
        }

        .tab-close:hover {
            background: rgba(95, 99, 104, 0.1);
            color: #202124;
            box-shadow: none;
        }

        /* Aggiusta i container per allinearsi con i tab */
        .borders.aliceblue {
            margin-top: 0;
            border-top-left-radius: 0;
        }

        .instance-container .borders.aliceblue:first-child {
            border-top-left-radius: 0;
            border-top-right-radius: 5px;
        }

        /* Stile modal */
        #new-instance-modal .modal-content,
        #edit-instance-modal .modal-content,
        #confirm-delete-modal .modal-content {
            min-width: 400px;
        }

        #new-instance-modal select,
        #new-instance-modal input,
        #edit-instance-modal select,
        #edit-instance-modal input {
            margin-top: 5px;
        }

        .connection-fields {
            display: none;
        }

        .connection-fields.active {
            display: block;
        }

        .input-error {
            border-color: #dc3545 !important;
        }

        .error-message {
            color: #dc3545;
            font-size: 12px;
            margin-top: 3px;
            display: none;
        }

        .error-message.active {
            display: block;
        }

        .edit-instance-btn {
            margin-top: 10px;
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div id="navbar-container"></div>
    <div id="config">
        <h3>CONFIGURAZIONE</h3>
        <br>
        <div id="sub-menu">
            <button class="menu-tab selected" onclick="changeSetupTab(event, 'settings')">SETTAGGI</button>
            <button class="menu-tab" onclick="changeSetupTab(event, 'instances')">TERMINALI</button>
        </div>
        <br>
        <div id="tabs">
            <div id="settings" class="tab">
                <div class="borders aliceblue">
                    <br>
                    <h3>ACCESSI</h3>
                    <br>
                    <div>
                        <label><b>Funzionamento</b>: </label>
                        <input type="radio" name="option" value="MANUALLY" id="radio-0" oninput="setMode(this.value)">
                        <label for="radio-0">Manuale</label>
                        <input type="radio" name="option" value="AUTOMATIC" id="radio-1" oninput="setMode(this.value)">
                        <label for="radio-1">Automatico</label>
                        <input type="radio" name="option" value="SEMIAUTOMATIC" id="radio-2" oninput="setMode(this.value)">
                        <label for="radio-2">Semiautomatico</label>
                    </div>
                    <br>
                    <label for="reservetion">Usa <b>prenotazioni</b>: </label>
                    <input type="checkbox" id="reservation" onclick="setUseReservation(this.checked)">
                    <br>
                    <br>
                    <label for="badge">Usa <b>badge</b> per riconoscimento tramite tessere: </label>
                    <input type="checkbox" id="badge" onclick="setUseBadge(this.checked)">
                    <br>
                    <br>
                </div>
                <br>
                <div class="borders aliceblue">
                    <br>
                    <h3>Report</h3>
                    <br>
                    <label for="report-copy">Ritorna copia del report a chi effettua la pesata: </label>
                    <input type="checkbox" id="report-copy" onclick="setReturnCopy(this.checked)">
                    <br>
                    <br>
                    <label for="entry-report">Report di stampa per <b>l'entrata</b>: </label>
                    <button onclick="openTemplateEditor('entrata')">Apri report designer</button>
                    <br>
                    <br>
                    <label for="exit-report">Report di stampa per <b>l'uscita</b>: </label>
                    <button onclick="openTemplateEditor('uscita')">Apri report designer</button>
                    <br>
                    <br>
                </div>
                <br>
                <div class="borders aliceblue">
                    <form id="sync-folder" onsubmit="event.preventDefault()">
                        <br>
                        <h3>Sincronizzazione cartella remota</h3>
                        <br>
                        <label for="ip">IP: *</label>
                        <input type="text" id="ip">
                        <br>
                        <br>
                        <label for="domain">Dominio: </label>
                        <input type="text" id="domain">
                        <br>
                        <br>
                        <label for="shared-folder">Cartella condivisa: *</label>
                        <input type="text" id="shared-folder">
                        <br>
                        <br>
                        <label for="sub-folder">Sotto cartella: </label>
                        <input type="text" id="sub-folder">
                        <br>
                        <br>
                        <label for="username">Username: *</label>
                        <input type="text" id="username">
                        <br>
                        <br>
                        <label for="password">Password: *</label>
                        <input type="text" id="password">
                        <br>
                        <br>
                        <button id="test-connection" onclick="testSyncFolder()">Testa connessione</button>
                        <br>
                        <br>
                        <button id="delete-connection" onclick="deleteSyncFolder()">Elimina</button>
                        <button id="save-connection" onclick="saveSyncFolder()">Salva</button>
                        <br>
                        <br>
                    </form>
                </div>
            </div>
            <div id="instances" class="tab">
                <div id="instance-sub-menu" class="instance-sub-menu"></div>
                <div id="instances-content"></div>
            </div>
        </div>
    </div>

    <!-- Modal per nuova istanza -->
    <div id="new-instance-modal" class="modal">
        <div class="modal-content">
            <h3>Nuova Istanza</h3>
            <br>
            <form id="new-instance-form" onsubmit="event.preventDefault()">
                <label for="connection-type"><b>Tipo di connessione:</b></label>
                <br>
                <select id="connection-type" onchange="toggleConnectionFields()">
                    <option value="">Seleziona...</option>
                    <option value="tcp">TCP/IP</option>
                    <option value="serial">Seriale</option>
                </select>
                <br>
                <br>
                
                <!-- Campi TCP -->
                <div id="tcp-fields" class="connection-fields">
                    <label for="tcp-ip"><b>IP:</b> *</label>
                    <br>
                    <input type="text" id="tcp-ip" placeholder="es. 10.0.5.178">
                    <span id="tcp-ip-error" class="error-message">Inserire un IP valido</span>
                    <br>
                    <br>
                    <label for="tcp-port"><b>Porta:</b> *</label>
                    <br>
                    <input type="number" id="tcp-port" placeholder="es. 4001" min="1" max="65535">
                    <span id="tcp-port-error" class="error-message">Porta deve essere tra 1 e 65535</span>
                    <br>
                    <br>
                    <label for="tcp-timeout"><b>Timeout (secondi):</b> *</label>
                    <br>
                    <input type="number" step="0.1" id="tcp-timeout" placeholder="es. 2.0" min="0.1">
                    <span id="tcp-timeout-error" class="error-message">Timeout deve essere maggiore di 0</span>
                    <br>
                    <br>
                </div>

                <!-- Campi Seriale -->
                <div id="serial-fields" class="connection-fields">
                    <label for="serial-port"><b>Porta seriale:</b> *</label>
                    <br>
                    <input type="text" id="serial-port" placeholder="es. /dev/ttyUSB0">
                    <span id="serial-port-error" class="error-message">Inserire una porta seriale valida</span>
                    <br>
                    <br>
                    <label for="serial-baudrate"><b>Baudrate:</b> *</label>
                    <br>
                    <input type="number" id="serial-baudrate" placeholder="es. 9600" min="1">
                    <span id="serial-baudrate-error" class="error-message">Baudrate deve essere maggiore di 0</span>
                    <br>
                    <br>
                    <label for="serial-timeout"><b>Timeout (secondi):</b> *</label>
                    <br>
                    <input type="number" step="0.1" id="serial-timeout" placeholder="es. 1.0" min="0.1">
                    <span id="serial-timeout-error" class="error-message">Timeout deve essere maggiore di 0</span>
                    <br>
                    <br>
                </div>

                <!-- Campo comune per entrambi i tipi -->
                <div id="common-fields" class="connection-fields">
                    <label for="time-between-actions"><b>Tempo tra azioni (secondi):</b> *</label>
                    <br>
                    <input type="number" step="0.1" id="time-between-actions" placeholder="es. 0.3" min="0.1">
                    <span id="time-between-actions-error" class="error-message">Deve essere maggiore di 0</span>
                    <br>
                    <br>
                </div>

                <div class="container-buttons right">
                    <button type="button" onclick="closeNewInstanceModal()">Annulla</button>
                    <button type="button" id="save-instance-btn" onclick="saveNewInstance()" disabled>Salva</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal per modifica istanza -->
    <div id="edit-instance-modal" class="modal">
        <div class="modal-content">
            <h3>Modifica Istanza</h3>
            <br>
            <form id="edit-instance-form" onsubmit="event.preventDefault()">
                <input type="hidden" id="edit-instance-id">
                
                <label for="edit-connection-type"><b>Tipo di connessione:</b></label>
                <br>
                <select id="edit-connection-type" onchange="toggleEditConnectionFields()">
                    <option value="tcp">TCP/IP</option>
                    <option value="serial">Seriale</option>
                </select>
                <br>
                <br>
                
                <!-- Campi TCP -->
                <div id="edit-tcp-fields" class="connection-fields">
                    <label for="edit-tcp-ip"><b>IP:</b> *</label>
                    <br>
                    <input type="text" id="edit-tcp-ip" placeholder="es. 10.0.5.178">
                    <span id="edit-tcp-ip-error" class="error-message">Inserire un IP valido</span>
                    <br>
                    <br>
                    <label for="edit-tcp-port"><b>Porta:</b> *</label>
                    <br>
                    <input type="number" id="edit-tcp-port" placeholder="es. 4001" min="1" max="65535">
                    <span id="edit-tcp-port-error" class="error-message">Porta deve essere tra 1 e 65535</span>
                    <br>
                    <br>
                    <label for="edit-tcp-timeout"><b>Timeout (secondi):</b> *</label>
                    <br>
                    <input type="number" step="0.1" id="edit-tcp-timeout" placeholder="es. 2.0" min="0.1">
                    <span id="edit-tcp-timeout-error" class="error-message">Timeout deve essere maggiore di 0</span>
                    <br>
                    <br>
                </div>

                <!-- Campi Seriale -->
                <div id="edit-serial-fields" class="connection-fields">
                    <label for="edit-serial-port"><b>Porta seriale:</b> *</label>
                    <br>
                    <input type="text" id="edit-serial-port" placeholder="es. /dev/ttyUSB0">
                    <span id="edit-serial-port-error" class="error-message">Inserire una porta seriale valida</span>
                    <br>
                    <br>
                    <label for="edit-serial-baudrate"><b>Baudrate:</b> *</label>
                    <br>
                    <input type="number" id="edit-serial-baudrate" placeholder="es. 9600" min="1">
                    <span id="edit-serial-baudrate-error" class="error-message">Baudrate deve essere maggiore di 0</span>
                    <br>
                    <br>
                    <label for="edit-serial-timeout"><b>Timeout (secondi):</b> *</label>
                    <br>
                    <input type="number" step="0.1" id="edit-serial-timeout" placeholder="es. 1.0" min="0.1">
                    <span id="edit-serial-timeout-error" class="error-message">Timeout deve essere maggiore di 0</span>
                    <br>
                    <br>
                </div>

                <!-- Campo comune per entrambi i tipi -->
                <div id="edit-common-fields" class="connection-fields">
                    <label for="edit-time-between-actions"><b>Tempo tra azioni (secondi):</b> *</label>
                    <br>
                    <input type="number" step="0.1" id="edit-time-between-actions" placeholder="es. 0.3" min="0.1">
                    <span id="edit-time-between-actions-error" class="error-message">Deve essere maggiore di 0</span>
                    <br>
                    <br>
                </div>

                <div class="container-buttons right">
                    <button type="button" onclick="closeEditInstanceModal()">Annulla</button>
                    <button type="button" id="update-instance-btn" onclick="updateInstance()" disabled>Aggiorna</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal per conferma eliminazione -->
    <div id="confirm-delete-modal" class="modal">
        <div class="modal-content">
            <h3>Conferma Eliminazione</h3>
            <br>
            <p>Sei sicuro di voler eliminare questa istanza?</p>
            <p><b id="instance-to-delete-name"></b></p>
            <br>
            <div class="container-buttons right">
                <button type="button" onclick="closeConfirmDeleteModal()">Annulla</button>
                <button type="button" class="red-button" onclick="confirmDeleteInstance()">Elimina</button>
            </div>
        </div>
    </div>

    <!-- Snackbar -->
    <div id="snackbar" class="snackbar"></div>
    
    <script type="module" src="/static/javascript/auth.js"></script>
    <script type="module" src="/static/javascript/interceptor.js"></script>
    <script src="/static/javascript/navbar.js"></script>
    <script src="/static/javascript/snackbar.js"></script>
    <script>
        document.querySelector('#instances').style.display = "none";

        const radio0 = document.querySelector("#radio-0");
        const radio1 = document.querySelector("#radio-1");
        const radio2 = document.querySelector("#radio-2");
        const useReservation = document.querySelector("#reservation");
        const useBadge = document.querySelector("#badge");
        const reportCopy = document.querySelector("#report-copy");
        const syncFolder = document.querySelector("#sync-folder");
        const ip = document.querySelector("#ip");
        const domain = document.querySelector("#domain");
        const sharedFolder = document.querySelector("#shared-folder");
        const subFolder = document.querySelector("#sub-folder");
        const username = document.querySelector("#username");
        const password = document.querySelector("#password");
        const testConnection = document.querySelector("#test-connection");
        const deleteConnection = document.querySelector("#delete-connection");
        const saveConnection = document.querySelector("#save-connection");

        let weighersData = {};
        let instanceToDelete = null;

        document.addEventListener("DOMContentLoaded", (e) => {
            fetch('/api/config-weigher/configuration', {
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(res => res.json())
            .then(res => {
                if (res.mode == "MANUALLY") {
                    radio0.checked = true;
                } else if (res.mode == "AUTOMATIC") {
                    radio1.checked = true;
                } else if (res.mode == "SEMIAUTOMATIC") {
                    radio2.checked = true;
                }

                if (res.use_reservation) useReservation.checked = true;

                if (res.use_badge) useBadge.checked = true;

                if (res.return_pdf_copy_after_weighing) reportCopy.checked = true;

                if (res.sync_folder.remote_folder) {
                    ip.value = res.sync_folder.remote_folder.ip;
                    ip.dataset.lastSaved = res.sync_folder.remote_folder.ip;
                    domain.value = res.sync_folder.remote_folder.domain;
                    domain.dataset.lastSaved = res.sync_folder.remote_folder.domain;
                    sharedFolder.value = res.sync_folder.remote_folder.share_name;
                    sharedFolder.dataset.lastSaved = res.sync_folder.remote_folder.share_name;
                    subFolder.value = res.sync_folder.remote_folder.sub_path;
                    subFolder.dataset.lastSaved = res.sync_folder.remote_folder.sub_path;
                    username.value = res.sync_folder.remote_folder.username;
                    username.dataset.lastSaved = res.sync_folder.remote_folder.username;
                    password.value = res.sync_folder.remote_folder.password;
                    password.dataset.lastSaved = res.sync_folder.remote_folder.password;
                } else {
                    testConnection.disabled = true;
                    deleteConnection.disabled = true;
                }
                saveConnection.disabled = true;

                // Salva i dati e genera i tab delle istanze
                weighersData = res.weighers;
                loadInstances(weighersData);
            });
        });

        function getConnectionName(connection) {
            if (connection.ip) {
                return `TCP ${connection.ip}:${connection.port}`;
            } else if (connection.serial_port_name) {
                return `Seriale ${connection.serial_port_name}`;
            }
            return 'Sconosciuta';
        }

        function isValidIP(ip) {
            const ipPattern = /^(\d{1,3}\.){3}\d{1,3}$/;
            if (!ipPattern.test(ip)) return false;
            const parts = ip.split('.');
            return parts.every(part => {
                const num = parseInt(part, 10);
                return num >= 0 && num <= 255;
            });
        }

        function isValidSerialPort(port) {
            return port.trim().length > 0 && (port.startsWith('/dev/') || port.startsWith('COM'));
        }

        function loadInstances(weighers) {
            const instanceSubMenu = document.querySelector('#instance-sub-menu');
            const instancesContent = document.querySelector('#instances-content');
            instanceSubMenu.innerHTML = '';
            instancesContent.innerHTML = '';

            Object.keys(weighers).forEach((instanceId, index) => {
                const instance = weighers[instanceId];
                const connectionName = getConnectionName(instance.connection);

                // Crea il bottone per l'istanza
                const instanceButton = document.createElement('button');
                instanceButton.className = 'menu-tab';
                instanceButton.dataset.instanceId = instanceId;
                if (index === 0) instanceButton.classList.add('selected');
                
                // Testo del tab
                const tabText = document.createElement('span');
                tabText.textContent = connectionName;
                instanceButton.appendChild(tabText);
                
                // Bottone X per chiudere
                const closeBtn = document.createElement('span');
                closeBtn.className = 'tab-close';
                closeBtn.innerHTML = '×';
                closeBtn.onclick = (e) => {
                    e.stopPropagation();
                    openConfirmDeleteModal(instanceId);
                };
                instanceButton.appendChild(closeBtn);
                
                instanceButton.onclick = (e) => {
                    if (!e.target.classList.contains('tab-close')) {
                        changeInstanceTab(e, instanceId);
                    }
                };
                
                instanceSubMenu.appendChild(instanceButton);

                // Crea il container per l'istanza
                const instanceDiv = document.createElement('div');
                instanceDiv.className = 'instance-container';
                instanceDiv.id = `instance-${instanceId}`;
                if (index === 0) instanceDiv.classList.add('active');

                // Informazioni sulla connessione
                const connectionInfo = document.createElement('div');
                connectionInfo.className = 'borders aliceblue';
                
                let connectionHtml = `
                    <br>
                    <h3>CONNESSIONE</h3>
                    <br>
                    <div>
                `;

                if (instance.connection.ip) {
                    connectionHtml += `
                        <label><b>Tipo</b>: TCP/IP</label>
                        <br>
                        <br>
                        <label><b>IP</b>: ${instance.connection.ip}</label>
                        <br>
                        <br>
                        <label><b>Porta</b>: ${instance.connection.port}</label>
                        <br>
                        <br>
                        <label><b>Timeout</b>: ${instance.connection.timeout}s</label>
                    `;
                } else if (instance.connection.serial_port_name) {
                    connectionHtml += `
                        <label><b>Tipo</b>: Seriale</label>
                        <br>
                        <br>
                        <label><b>Porta seriale</b>: ${instance.connection.serial_port_name}</label>
                        <br>
                        <br>
                        <label><b>Baudrate</b>: ${instance.connection.baudrate}</label>
                        <br>
                        <br>
                        <label><b>Timeout</b>: ${instance.connection.timeout}s</label>
                    `;
                }

                connectionHtml += `
                        <br>
                        <br>
                        <label><b>Tempo tra azioni</b>: ${instance.time_between_actions}s</label>
                    </div>
                    <br>
                    <button class="edit-instance-btn" onclick="openEditInstanceModal('${instanceId}')">Modifica</button>
                    <br>
                `;
                connectionInfo.innerHTML = connectionHtml;

                // Sotto-menu per i nodi
                const nodeSubMenu = document.createElement('div');
                nodeSubMenu.className = 'node-sub-menu';
                
                const nodes = instance.nodes;
                Object.keys(nodes).forEach((nodeId, nodeIndex) => {
                    const nodeButton = document.createElement('button');
                    nodeButton.className = 'menu-tab';
                    if (nodeIndex === 0) nodeButton.classList.add('selected');
                    nodeButton.textContent = `PESA ${nodeId}`;
                    nodeButton.onclick = (e) => changeNodeTab(e, instanceId, nodeId);
                    nodeSubMenu.appendChild(nodeButton);
                });

                // Contenuto dei nodi
                const nodesContainer = document.createElement('div');
                nodesContainer.className = 'nodes-container';
                nodesContainer.style.marginTop = '0';

                Object.keys(nodes).forEach((nodeId, nodeIndex) => {
                    const node = nodes[nodeId];
                    const nodeContent = document.createElement('div');
                    nodeContent.className = 'node-tab-content borders aliceblue';
                    nodeContent.id = `node-${instanceId}-${nodeId}`;
                    if (nodeIndex === 0) nodeContent.classList.add('active');

                    nodeContent.innerHTML = `
                        <br>
                        <h3>PESA ${nodeId}</h3>
                        <br>
                        <div>
                            <label><b>Terminale</b>: ${node.terminal || 'N/A'}</label>
                            <br>
                            <br>
                            <label><b>Peso massimo</b>: ${node.max_weight} kg</label>
                            <br>
                            <br>
                            <label><b>Peso minimo</b>: ${node.min_weight} kg</label>
                            <br>
                            <br>
                            <label><b>Divisione</b>: ${node.division}</label>
                            <br>
                            <br>
                            <label><b>Attivo</b>: ${node.run ? 'Sì' : 'No'}</label>
                            <br>
                            <br>
                            <label><b>Nodo</b>: ${node.node || 'N/A'}</label>
                        </div>
                        <br>
                    `;
                    nodesContainer.appendChild(nodeContent);
                });

                instanceDiv.appendChild(connectionInfo);
                instanceDiv.appendChild(document.createElement('br'));
                instanceDiv.appendChild(nodeSubMenu);
                instanceDiv.appendChild(nodesContainer);
                instancesContent.appendChild(instanceDiv);
            });

            // Aggiungi il bottone "+"
            const addButton = document.createElement('button');
            addButton.className = 'menu-tab add-tab';
            addButton.textContent = '+';
            addButton.onclick = openNewInstanceModal;
            instanceSubMenu.appendChild(addButton);
        }

        function addNewInstanceTab(instanceId, instance) {
            const connectionName = getConnectionName(instance.connection);
            const instanceSubMenu = document.querySelector('#instance-sub-menu');
            const instancesContent = document.querySelector('#instances-content');

            // Rimuovi la selezione da tutti i tab
            document.querySelectorAll('#instance-sub-menu .menu-tab:not(.add-tab)').forEach(button => {
                button.classList.remove("selected");
            });
            document.querySelectorAll('.instance-container').forEach(div => {
                div.classList.remove("active");
            });

            // Trova il bottone "+" e inserisci il nuovo tab prima di esso
            const addButton = instanceSubMenu.querySelector('.add-tab');
            
            // Crea il nuovo bottone per l'istanza
            const instanceButton = document.createElement('button');
            instanceButton.className = 'menu-tab selected';
            instanceButton.dataset.instanceId = instanceId;
            
            // Testo del tab
            const tabText = document.createElement('span');
            tabText.textContent = connectionName;
            instanceButton.appendChild(tabText);
            
            // Bottone X per chiudere
            const closeBtn = document.createElement('span');
            closeBtn.className = 'tab-close';
            closeBtn.innerHTML = '×';
            closeBtn.onclick = (e) => {
                e.stopPropagation();
                openConfirmDeleteModal(instanceId);
            };
            instanceButton.appendChild(closeBtn);
            
            instanceButton.onclick = (e) => {
                if (!e.target.classList.contains('tab-close')) {
                    changeInstanceTab(e, instanceId);
                }
            };
            
            instanceSubMenu.insertBefore(instanceButton, addButton);

            // Crea il container per la nuova istanza
            const instanceDiv = document.createElement('div');
            instanceDiv.className = 'instance-container active';
            instanceDiv.id = `instance-${instanceId}`;

            // Informazioni sulla connessione
            const connectionInfo = document.createElement('div');
            connectionInfo.className = 'borders aliceblue';
            
            let connectionHtml = `
                <br>
                <h3>CONNESSIONE</h3>
                <br>
                <div>
            `;

            if (instance.connection.ip) {
                connectionHtml += `
                    <label><b>Tipo</b>: TCP/IP</label>
                    <br>
                    <br>
                    <label><b>IP</b>: ${instance.connection.ip}</label>
                    <br>
                    <br>
                    <label><b>Porta</b>: ${instance.connection.port}</label>
                    <br>
                    <br>
                    <label><b>Timeout</b>: ${instance.connection.timeout}s</label>
                `;
            } else if (instance.connection.serial_port_name) {
                connectionHtml += `
                    <label><b>Tipo</b>: Seriale</label>
                    <br>
                    <br>
                    <label><b>Porta seriale</b>: ${instance.connection.serial_port_name}</label>
                    <br>
                    <br>
                    <label><b>Baudrate</b>: ${instance.connection.baudrate}</label>
                    <br>
                    <br>
                    <label><b>Timeout</b>: ${instance.connection.timeout}s</label>
                `;
            }

            connectionHtml += `
                    <br>
                    <br>
                    <label><b>Tempo tra azioni</b>: ${instance.time_between_actions}s</label>
                </div>
                <br>
                <button class="edit-instance-btn" onclick="openEditInstanceModal('${instanceId}')">Modifica</button>
                <br>
            `;
            connectionInfo.innerHTML = connectionHtml;

            // Sotto-menu per i nodi (vuoto per ora, può essere aggiunto in seguito)
            const nodeSubMenu = document.createElement('div');
            nodeSubMenu.className = 'node-sub-menu';
            nodeSubMenu.innerHTML = '<p style="padding: 10px;">Nessuna pesa configurata</p>';

            instanceDiv.appendChild(connectionInfo);
            instanceDiv.appendChild(document.createElement('br'));
            instanceDiv.appendChild(nodeSubMenu);
            instancesContent.appendChild(instanceDiv);
        }

        function updateInstanceDisplay(instanceId) {
            const instance = weighersData[instanceId];
            const connectionName = getConnectionName(instance.connection);

            // Aggiorna il testo del tab
            const instanceButton = document.querySelector(`#instance-sub-menu .menu-tab[data-instance-id="${instanceId}"]`);
            if (instanceButton) {
                const tabText = instanceButton.querySelector('span:first-child');
                tabText.textContent = connectionName;
            }

            // Aggiorna il contenuto dell'istanza
            const connectionInfo = document.querySelector(`#instance-${instanceId} .borders.aliceblue`);
            if (connectionInfo) {
                let connectionHtml = `
                    <br>
                    <h3>CONNESSIONE</h3>
                    <br>
                    <div>
                `;

                if (instance.connection.ip) {
                    connectionHtml += `
                        <label><b>Tipo</b>: TCP/IP</label>
                        <br>
                        <br>
                        <label><b>IP</b>: ${instance.connection.ip}</label>
                        <br>
                        <br>
                        <label><b>Porta</b>: ${instance.connection.port}</label>
                        <br>
                        <br>
                        <label><b>Timeout</b>: ${instance.connection.timeout}s</label>
                    `;
                } else if (instance.connection.serial_port_name) {
                    connectionHtml += `
                        <label><b>Tipo</b>: Seriale</label>
                        <br>
                        <br>
                        <label><b>Porta seriale</b>: ${instance.connection.serial_port_name}</label>
                        <br>
                        <br>
                        <label><b>Baudrate</b>: ${instance.connection.baudrate}</label>
                        <br>
                        <br>
                        <label><b>Timeout</b>: ${instance.connection.timeout}s</label>
                    `;
                }

                connectionHtml += `
                        <br>
                        <br>
                        <label><b>Tempo tra azioni</b>: ${instance.time_between_actions}s</label>
                    </div>
                    <br>
                    <button class="edit-instance-btn" onclick="openEditInstanceModal('${instanceId}')">Modifica</button>
                    <br>
                `;
                connectionInfo.innerHTML = connectionHtml;
            }
        }

        function openEditInstanceModal(instanceId) {
            const instance = weighersData[instanceId];
            
            document.querySelector('#edit-instance-id').value = instanceId;
            
            if (instance.connection.ip) {
                document.querySelector('#edit-connection-type').value = 'tcp';
                document.querySelector('#edit-tcp-ip').value = instance.connection.ip;
                document.querySelector('#edit-tcp-port').value = instance.connection.port;
                document.querySelector('#edit-tcp-timeout').value = instance.connection.timeout;
            } else if (instance.connection.serial_port_name) {
                document.querySelector('#edit-connection-type').value = 'serial';
                document.querySelector('#edit-serial-port').value = instance.connection.serial_port_name;
                document.querySelector('#edit-serial-baudrate').value = instance.connection.baudrate;
                document.querySelector('#edit-serial-timeout').value = instance.connection.timeout;
            }
            
            document.querySelector('#edit-time-between-actions').value = instance.time_between_actions;
            
            // Mostra i campi corretti
            toggleEditConnectionFields();
            
            const modal = document.querySelector('#edit-instance-modal');
            modal.style.display = 'block';
            setTimeout(() => {
                modal.style.opacity = '1';
            }, 10);
            
            validateEditInstanceForm();
        }

        function closeEditInstanceModal() {
            const modal = document.querySelector('#edit-instance-modal');
            modal.style.opacity = '0';
            setTimeout(() => {
                modal.style.display = 'none';
                document.querySelector('#edit-instance-form').reset();
                document.querySelectorAll('#edit-instance-modal .connection-fields').forEach(field => field.classList.remove('active'));
                document.querySelectorAll('#edit-instance-modal .error-message').forEach(msg => msg.classList.remove('active'));
                document.querySelectorAll('#edit-instance-modal input').forEach(input => input.classList.remove('input-error'));
                document.querySelector('#update-instance-btn').disabled = true;
            }, 300);
        }

        function toggleEditConnectionFields() {
            const connectionType = document.querySelector('#edit-connection-type').value;
            const tcpFields = document.querySelector('#edit-tcp-fields');
            const serialFields = document.querySelector('#edit-serial-fields');
            const commonFields = document.querySelector('#edit-common-fields');

            // Reset errori
            document.querySelectorAll('#edit-instance-modal .error-message').forEach(msg => msg.classList.remove('active'));
            document.querySelectorAll('#edit-instance-modal input:not([type="hidden"])').forEach(input => input.classList.remove('input-error'));

            tcpFields.classList.remove('active');
            serialFields.classList.remove('active');

            if (connectionType === 'tcp') {
                tcpFields.classList.add('active');
            } else if (connectionType === 'serial') {
                serialFields.classList.add('active');
            }

            commonFields.classList.add('active');
            validateEditInstanceForm();
        }

        function validateEditInstanceForm() {
            const connectionType = document.querySelector('#edit-connection-type').value;
            const timeBetweenActions = document.querySelector('#edit-time-between-actions').value;
            const updateBtn = document.querySelector('#update-instance-btn');
            let isValid = true;

            // Reset errori
            document.querySelectorAll('#edit-instance-modal .error-message').forEach(msg => msg.classList.remove('active'));
            document.querySelectorAll('#edit-instance-form input:not([type="hidden"])').forEach(input => input.classList.remove('input-error'));

            if (connectionType === 'tcp') {
                const tcpIp = document.querySelector('#edit-tcp-ip');
                const tcpPort = document.querySelector('#edit-tcp-port');
                const tcpTimeout = document.querySelector('#edit-tcp-timeout');

                if (!tcpIp.value || !isValidIP(tcpIp.value)) {
                    tcpIp.classList.add('input-error');
                    document.querySelector('#edit-tcp-ip-error').classList.add('active');
                    isValid = false;
                }

                const port = parseInt(tcpPort.value);
                if (!tcpPort.value || port < 1 || port > 65535) {
                    tcpPort.classList.add('input-error');
                    document.querySelector('#edit-tcp-port-error').classList.add('active');
                    isValid = false;
                }

                const timeout = parseFloat(tcpTimeout.value);
                if (!tcpTimeout.value || timeout <= 0) {
                    tcpTimeout.classList.add('input-error');
                    document.querySelector('#edit-tcp-timeout-error').classList.add('active');
                    isValid = false;
                }

            } else if (connectionType === 'serial') {
                const serialPort = document.querySelector('#edit-serial-port');
                const serialBaudrate = document.querySelector('#edit-serial-baudrate');
                const serialTimeout = document.querySelector('#edit-serial-timeout');

                if (!serialPort.value || !isValidSerialPort(serialPort.value)) {
                    serialPort.classList.add('input-error');
                    document.querySelector('#edit-serial-port-error').classList.add('active');
                    isValid = false;
                }

                const baudrate = parseInt(serialBaudrate.value);
                if (!serialBaudrate.value || baudrate <= 0) {
                    serialBaudrate.classList.add('input-error');
                    document.querySelector('#edit-serial-baudrate-error').classList.add('active');
                    isValid = false;
                }

                const timeout = parseFloat(serialTimeout.value);
                if (!serialTimeout.value || timeout <= 0) {
                    serialTimeout.classList.add('input-error');
                    document.querySelector('#edit-serial-timeout-error').classList.add('active');
                    isValid = false;
                }
            }

            const timeBetweenActionsInput = document.querySelector('#edit-time-between-actions');
            const time = parseFloat(timeBetweenActions);
            if (!timeBetweenActions || time <= 0) {
                timeBetweenActionsInput.classList.add('input-error');
                document.querySelector('#edit-time-between-actions-error').classList.add('active');
                isValid = false;
            }

            updateBtn.disabled = !isValid;
        }

        document.querySelector('#edit-instance-form').addEventListener('input', validateEditInstanceForm);

        function updateInstance() {
            const instanceId = document.querySelector('#edit-instance-id').value;
            const connectionType = document.querySelector('#edit-connection-type').value;
            const timeBetweenActions = parseFloat(document.querySelector('#edit-time-between-actions').value);
            
            let connection = {
                instance_name: instanceId,
                time_between_actions: timeBetweenActions
            };

            if (connectionType === 'tcp') {
                connection.ip = document.querySelector('#edit-tcp-ip').value;
                connection.port = parseInt(document.querySelector('#edit-tcp-port').value);
                connection.timeout = parseFloat(document.querySelector('#edit-tcp-timeout').value);
            } else if (connectionType === 'serial') {
                connection.serial_port_name = document.querySelector('#edit-serial-port').value;
                connection.baudrate = parseInt(document.querySelector('#edit-serial-baudrate').value);
                connection.timeout = parseFloat(document.querySelector('#edit-serial-timeout').value);
            }

            // Disabilita il form durante l'aggiornamento
            document.querySelector('#update-instance-btn').disabled = true;
            document.querySelector('#edit-instance-form').querySelectorAll('input, select, button').forEach(el => el.disabled = true);

            fetch('/api/config-weigher/instance/connection', {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(connection)
            })
            .then(res => {
                if (!res.ok) {
                    throw new Error('Errore nell\'aggiornamento dell\'istanza');
                }
                return res.json();
            })
            .then(data => {
                // Aggiorna i dati locali
                const updatedInstance = weighersData[instanceId];
                updatedInstance.time_between_actions = timeBetweenActions;
                
                if (connectionType === 'tcp') {
                    updatedInstance.connection = {
                        ip: connection.ip,
                        port: connection.port,
                        timeout: connection.timeout,
                        connecting: false
                    };
                } else if (connectionType === 'serial') {
                    updatedInstance.connection = {
                        serial_port_name: connection.serial_port_name,
                        baudrate: connection.baudrate,
                        timeout: connection.timeout,
                        connecting: false
                    };
                }

                // Aggiorna l'interfaccia
                updateInstanceDisplay(instanceId);

                showSnackbar("snackbar", "Istanza aggiornata con successo", 'rgb(208, 255, 208)', 'black');
                closeEditInstanceModal();
            })
            .catch(error => {
                console.error('Errore:', error);
                showSnackbar("snackbar", "Errore nell'aggiornamento dell'istanza", 'rgb(255, 208, 208)', 'black');
                
                // Riabilita il form in caso di errore
                document.querySelector('#edit-instance-form').querySelectorAll('input, select, button').forEach(el => el.disabled = false);
                validateEditInstanceForm();
            });
        }

        function openConfirmDeleteModal(instanceId) {
            instanceToDelete = instanceId;
            const instance = weighersData[instanceId];
            const connectionName = getConnectionName(instance.connection);
            
            document.querySelector('#instance-to-delete-name').textContent = connectionName;
            
            const modal = document.querySelector('#confirm-delete-modal');
            modal.style.display = 'block';
            setTimeout(() => {
                modal.style.opacity = '1';
            }, 10);
        }

        function closeConfirmDeleteModal() {
            const modal = document.querySelector('#confirm-delete-modal');
            modal.style.opacity = '0';
            setTimeout(() => {
                modal.style.display = 'none';
                instanceToDelete = null;
            }, 300);
        }

        function confirmDeleteInstance() {
            if (!instanceToDelete) return;

            const instanceId = instanceToDelete;

            fetch(`/api/config-weigher/instance/connection/${instanceId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(res => {
                if (!res.ok) {
                    throw new Error('Errore nell\'eliminazione dell\'istanza');
                }
                return res.json();
            })
            .then(data => {
                // Rimuovi l'istanza dai dati
                delete weighersData[instanceId];

                // Rimuovi il tab e il contenuto dall'interfaccia
                const instanceButton = document.querySelector(`#instance-sub-menu .menu-tab[data-instance-id="${instanceId}"]`);
                const instanceContainer = document.querySelector(`#instance-${instanceId}`);
                const wasActive = instanceContainer.classList.contains('active');

                instanceButton.remove();
                instanceContainer.remove();

                // Se l'istanza eliminata era attiva, attiva un'altra istanza
                if (wasActive) {
                    const remainingButtons = document.querySelectorAll('#instance-sub-menu .menu-tab:not(.add-tab)');
                    if (remainingButtons.length > 0) {
                        const firstButton = remainingButtons[0];
                        const firstInstanceId = firstButton.dataset.instanceId;
                        firstButton.classList.add('selected');
                        document.querySelector(`#instance-${firstInstanceId}`).classList.add('active');
                    }
                }

                showSnackbar("snackbar", "Istanza eliminata con successo", 'rgb(208, 255, 208)', 'black');
                closeConfirmDeleteModal();
            })
            .catch(error => {
                console.error('Errore:', error);
                showSnackbar("snackbar", "Errore nell'eliminazione dell'istanza", 'rgb(255, 208, 208)', 'black');
                closeConfirmDeleteModal();
            });
        }

        function openNewInstanceModal() {
            const modal = document.querySelector('#new-instance-modal');
            modal.style.display = 'block';
            setTimeout(() => {
                modal.style.opacity = '1';
            }, 10);
        }

        function closeNewInstanceModal() {
            const modal = document.querySelector('#new-instance-modal');
            modal.style.opacity = '0';
            setTimeout(() => {
                modal.style.display = 'none';
                document.querySelector('#new-instance-form').reset();
                document.querySelectorAll('.connection-fields').forEach(field => field.classList.remove('active'));
                document.querySelectorAll('.error-message').forEach(msg => msg.classList.remove('active'));
                document.querySelectorAll('input').forEach(input => input.classList.remove('input-error'));
                document.querySelector('#save-instance-btn').disabled = true;
            }, 300);
        }

        function toggleConnectionFields() {
            const connectionType = document.querySelector('#connection-type').value;
            const tcpFields = document.querySelector('#tcp-fields');
            const serialFields = document.querySelector('#serial-fields');
            const commonFields = document.querySelector('#common-fields');

            tcpFields.classList.remove('active');
            serialFields.classList.remove('active');
            commonFields.classList.remove('active');

            // Reset errori
            document.querySelectorAll('.error-message').forEach(msg => msg.classList.remove('active'));
            document.querySelectorAll('input').forEach(input => input.classList.remove('input-error'));

            if (connectionType === 'tcp') {
                tcpFields.classList.add('active');
                commonFields.classList.add('active');
            } else if (connectionType === 'serial') {
                serialFields.classList.add('active');
                commonFields.classList.add('active');
            }

            validateNewInstanceForm();
        }

        function validateNewInstanceForm() {
            const connectionType = document.querySelector('#connection-type').value;
            const timeBetweenActions = document.querySelector('#time-between-actions').value;
            const saveBtn = document.querySelector('#save-instance-btn');
            let isValid = true;

            // Reset errori
            document.querySelectorAll('.error-message').forEach(msg => msg.classList.remove('active'));
            document.querySelectorAll('#new-instance-form input').forEach(input => input.classList.remove('input-error'));

            if (connectionType === 'tcp') {
                const tcpIp = document.querySelector('#tcp-ip');
                const tcpPort = document.querySelector('#tcp-port');
                const tcpTimeout = document.querySelector('#tcp-timeout');

                // Validazione IP
                if (!tcpIp.value || !isValidIP(tcpIp.value)) {
                    tcpIp.classList.add('input-error');
                    document.querySelector('#tcp-ip-error').classList.add('active');
                    isValid = false;
                }

                // Validazione Porta
                const port = parseInt(tcpPort.value);
                if (!tcpPort.value || port < 1 || port > 65535) {
                    tcpPort.classList.add('input-error');
                    document.querySelector('#tcp-port-error').classList.add('active');
                    isValid = false;
                }

                // Validazione Timeout
                const timeout = parseFloat(tcpTimeout.value);
                if (!tcpTimeout.value || timeout <= 0) {
                    tcpTimeout.classList.add('input-error');
                    document.querySelector('#tcp-timeout-error').classList.add('active');
                    isValid = false;
                }

            } else if (connectionType === 'serial') {
                const serialPort = document.querySelector('#serial-port');
                const serialBaudrate = document.querySelector('#serial-baudrate');
                const serialTimeout = document.querySelector('#serial-timeout');

                // Validazione Porta Seriale
                if (!serialPort.value || !isValidSerialPort(serialPort.value)) {
                    serialPort.classList.add('input-error');
                    document.querySelector('#serial-port-error').classList.add('active');
                    isValid = false;
                }

                // Validazione Baudrate
                const baudrate = parseInt(serialBaudrate.value);
                if (!serialBaudrate.value || baudrate <= 0) {
                    serialBaudrate.classList.add('input-error');
                    document.querySelector('#serial-baudrate-error').classList.add('active');
                    isValid = false;
                }

                // Validazione Timeout
                const timeout = parseFloat(serialTimeout.value);
                if (!serialTimeout.value || timeout <= 0) {
                    serialTimeout.classList.add('input-error');
                    document.querySelector('#serial-timeout-error').classList.add('active');
                    isValid = false;
                }
            } else {
                isValid = false;
            }

            // Validazione Tempo tra azioni (comune)
            if (connectionType) {
                const timeBetweenActionsInput = document.querySelector('#time-between-actions');
                const time = parseFloat(timeBetweenActions);
                if (!timeBetweenActions || time <= 0) {
                    timeBetweenActionsInput.classList.add('input-error');
                    document.querySelector('#time-between-actions-error').classList.add('active');
                    isValid = false;
                }
            }

            saveBtn.disabled = !isValid;
        }

        // Aggiungi listener per validazione
        document.querySelector('#new-instance-form').addEventListener('input', validateNewInstanceForm);

        function saveNewInstance() {
            const connectionType = document.querySelector('#connection-type').value;
            const timeBetweenActions = parseFloat(document.querySelector('#time-between-actions').value);
            let connection = {
                time_between_actions: timeBetweenActions
            };

            if (connectionType === 'tcp') {
                connection.ip = document.querySelector('#tcp-ip').value;
                connection.port = parseInt(document.querySelector('#tcp-port').value);
                connection.timeout = parseFloat(document.querySelector('#tcp-timeout').value);
            } else if (connectionType === 'serial') {
                connection.serial_port_name = document.querySelector('#serial-port').value;
                connection.baudrate = parseInt(document.querySelector('#serial-baudrate').value);
                connection.timeout = parseFloat(document.querySelector('#serial-timeout').value);
            }

            // Disabilita il form durante il salvataggio
            document.querySelector('#save-instance-btn').disabled = true;
            document.querySelector('#new-instance-form').querySelectorAll('input, select, button').forEach(el => el.disabled = true);

            fetch('/api/config-weigher/instance/connection', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(connection)
            })
            .then(res => {
                if (!res.ok) {
                    throw new Error('Errore nella creazione dell\'istanza');
                }
                return res.json();
            })
            .then(data => {
                // Aggiungi la nuova istanza ai dati
                const newInstanceId = data.instance_id || Object.keys(weighersData).length + 1;
                const newInstance = {
                    connection: connectionType === 'tcp' ? {
                        ip: connection.ip,
                        port: connection.port,
                        timeout: connection.timeout,
                        connecting: false
                    } : {
                        serial_port_name: connection.serial_port_name,
                        baudrate: connection.baudrate,
                        timeout: connection.timeout,
                        connecting: false
                    },
                    time_between_actions: timeBetweenActions,
                    nodes: {}
                };

                weighersData[newInstanceId] = newInstance;

                // Aggiungi il nuovo tab all'interfaccia
                addNewInstanceTab(newInstanceId, newInstance);

                showSnackbar("snackbar", "Istanza creata con successo", 'rgb(208, 255, 208)', 'black');
                closeNewInstanceModal();
            })
            .catch(error => {
                console.error('Errore:', error);
                showSnackbar("snackbar", "Errore nella creazione dell'istanza", 'rgb(255, 208, 208)', 'black');
                
                // Riabilita il form in caso di errore
                document.querySelector('#new-instance-form').querySelectorAll('input, select, button').forEach(el => el.disabled = false);
                validateNewInstanceForm();
            });
        }

        function changeInstanceTab(event, instanceId) {
            document.querySelectorAll('#instance-sub-menu .menu-tab:not(.add-tab)').forEach(button => button.classList.remove("selected"));
            document.querySelectorAll('.instance-container').forEach(div => div.classList.remove("active"));
            
            document.querySelector(`#instance-${instanceId}`).classList.add("active");
            event.currentTarget.classList.add("selected");
        }

        function changeNodeTab(event, instanceId, nodeId) {
            const instance = document.querySelector(`#instance-${instanceId}`);
            instance.querySelectorAll('.node-sub-menu .menu-tab').forEach(button => button.classList.remove("selected"));
            instance.querySelectorAll('.node-tab-content').forEach(div => div.classList.remove("active"));
            
            document.querySelector(`#node-${instanceId}-${nodeId}`).classList.add("active");
            event.target.classList.add("selected");
        }

        syncFolder.addEventListener("input", (e) => {
            if (
                ip.value &&
                sharedFolder.value &&
                username.value &&
                password.value &&
                (
                    ip.value !== ip.dataset.lastSaved ||
                    sharedFolder.value !== sharedFolder.dataset.lastSaved ||
                    username.value !== username.dataset.lastSaved ||
                    password.value !== password.dataset.lastSaved
                )
            ) {
                saveConnection.disabled = false;
            } else {
                saveConnection.disabled = true;
            }
        })

        function changeSetupTab(event, tab) {
            document.querySelectorAll('#sub-menu .menu-tab').forEach(button => button.classList.remove("selected"));
            document.querySelectorAll(".tab").forEach(div => div.style.display = 'none');
            document.querySelector(`#${tab}`).style.display = "block";
            event.target.classList.toggle("selected");
        }

        function setMode(mode) {
            fetch(`/api/config-weigher/configuration/mode/${mode}`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(res => res.json());
        }

        function setUseReservation(status) {
            fetch(`/api/config-weigher/configuration/use-reservation/${status}`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(res => res.json());
        }

        function setUseBadge(status) {
            fetch(`/api/config-weigher/configuration/use-badge/${status}`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(res => res.json());
        }

        function setReturnCopy(status) {
            fetch(`/api/config-weigher/configuration/return-pdf-copy-after-weighing/${status}`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(res => res.json());
        }

        function openTemplateEditor(type) {
            window.open(`/report-designer/${type}`, '_blank');
        }

        function testSyncFolder() {
            fetch(`/api/sync-folder/test`, {
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(res => res.json())
            .then(res => {
                if (res.mounted === true) {
                    showSnackbar("snackbar", "Cartella remota sincronizzazione", 'rgb(208, 255, 208)', 'black');
                } else if (res.mounted === false) {
                    showSnackbar("snackbar", 'Cartella remota non sincronizzata correttamente', 'rgb(255, 208, 208)', 'black');
                }
            });
        }

        function deleteSyncFolder() {
            fetch(`/api/sync-folder`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(res => {
                if (res.status !== 200) {
                    showSnackbar("snackbar", 'Errore nella eliminazione', 'rgb(255, 208, 208)', 'black');
                } else {
                    showSnackbar("snackbar", "Sincronizzazione remota eliminata", 'rgb(208, 255, 208)', 'black');
                    ip.value = '';
                    ip.dataset.lastSaved = '';
                    domain.value = '';
                    domain.dataset.lastSaved = '';
                    sharedFolder.value = '';
                    sharedFolder.dataset.lastSaved = '';
                    subFolder.value = '';
                    subFolder.dataset.lastSaved = '';
                    username.value = '';
                    username.dataset.lastSaved = '';
                    password.value = '';
                    password.dataset.lastSaved = '';
                    testConnection.disabled = true;
                    deleteConnection.disabled = true;
                    saveConnection.disabled = true;
                }
            });
        }

        function saveSyncFolder() {
            syncFolder.querySelectorAll("input, button").forEach(e => e.disabled = true);
            fetch(`/api/sync-folder`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    "ip": ip.value,
                    "domain": domain.value,
                    "share_name": sharedFolder.value,
                    "sub_path": subFolder.value,
                    "username": username.value,
                    "password": password.value
                })
            })
            .then(res => {
                const status = res.status;
                return res.json()
                .then(value => {
                    if (status !== 200) {
                        const message = value.detail ? value.detail[0].msg.replace("Value error, ", "") : 'Errore nel salvataggio';
                        showSnackbar("snackbar", message, 'rgb(255, 208, 208)', 'black');
                    }
                    else {
                        showSnackbar("snackbar", "Cartella remota configurata", 'rgb(208, 255, 208)', 'black');
                    }
                    return value;
                });
            })
            .then(res => {
                syncFolder.querySelectorAll("input").forEach(e => e.disabled = false);
                if (res.remote_folder) {
                    ip.dataset.lastSaved = res.remote_folder.ip;
                    domain.dataset.lastSaved = res.remote_folder.domain;
                    sharedFolder.dataset.lastSaved = res.remote_folder.share_name;
                    subFolder.dataset.lastSaved = res.remote_folder.sub_path;
                    username.dataset.lastSaved = res.remote_folder.username;
                    password.dataset.lastSaved = res.remote_folder.password;
                    testConnection.disabled = false;
                    deleteConnection.disabled = false;
                    saveConnection.disabled = true;
                } else if (ip.dataset.lastSaved) {
                    testConnection.disabled = false;
                    deleteConnection.disabled = false;
                    saveConnection.disabled = false;
                }
            })
        }
    </script>
</body>
</html>