<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Peso - Semplificata</title>
    <link rel="icon" href="/static/content/baronpesi_favicon.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: system-ui, -apple-system, sans-serif;
        }

        body {
            background-color: aliceblue;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
            max-width: 600px;
            width: 100%;
            padding: 30px;
        }

        .weigher-section {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 30px;
        }

        .weigher-select-container {
            flex: 0 0 auto;
            min-width: 150px;
            position: relative;
        }

        .weigher-select-container label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .weight-display {
            flex: 1;
            background: cornflowerblue;
            color: white;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .weight-value {
            font-size: 3.5rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .weight-unit {
            font-size: 1.5rem;
            opacity: 0.9;
        }

        .weight-status {
            font-size: 1.2rem;
            margin-top: 10px;
            opacity: 0.8;
        }

        #materialId,
        #operatorId {
            display: none;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .input-group input,
        .input-group select,
        .weigher-select-container select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 1.1rem;
            transition: all 0.3s ease;
            background-color: white;
        }

        .input-group input:focus,
        .weigher-select-container select:focus {
            outline: none;
            border-color: cornflowerblue;
            box-shadow: 0 0 0 3px rgba(100, 149, 237, 0.1);
        }

        .suggestions-list {
            position: absolute;
            width: 100%;
            background: white;
            border: 1px solid #ccc;
            border-radius: 5px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
            display: none;
        }

        .suggestions-list.show {
            display: block;
        }

        .suggestions-list li {
            padding: 12px;
            cursor: pointer;
            list-style: none;
            transition: background-color 0.2s;
        }

        .suggestions-list li:hover {
            background-color: #f0f0f0;
        }

        .suggestions-list li.selected {
            background-color: #e0e0e0;
            font-weight: bold;
        }

        .highlight {
            background-color: yellow;
        }

        .buttons-group {
            display: flex;
            gap: 10px;
            margin-top: 30px;
        }

        button {
            flex: 1;
            padding: 15px;
            background-color: cornflowerblue;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        button:hover:not(:disabled) {
            background-color: #4169e1;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        button:active:not(:disabled) {
            transform: translateY(0);
        }

        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        input:disabled,
        select:disabled {
            background-color: #f5f5f5;
            cursor: not-allowed;
        }

        .snackbar {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background-color: #333;
            color: white;
            padding: 16px 24px;
            border-radius: 5px;
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 2000;
        }

        .snackbar.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        /* Popup styles */
        .popup {
            display: none;
            position: fixed;
            z-index: 3000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }

        .popup-content {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            text-align: center;
            max-width: 400px;
            width: 90%;
            opacity: 0;
            transform: scale(0.7);
            transition: all 0.3s ease;
        }

        .popup-content.show {
            opacity: 1;
            transform: scale(1);
        }

        .popup-content p {
            margin-bottom: 20px;
            font-size: 1.1rem;
            color: #333;
        }

        .popup-content button {
            width: 100%;
            margin-top: 10px;
        }

        @media (max-width: 600px) {
            .weigher-section {
                flex-direction: column;
            }

            .weigher-select-container {
                width: 100%;
            }

            .weight-value {
                font-size: 2.5rem;
            }

            .buttons-group {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div id="navbar-container"></div>

    <br>

    <div class="container">
        <!-- Sezione peso e selezione pesa -->
        <div class="weigher-section">
            <div class="weigher-select-container">
                <label for="weigherSelect">Pesa</label>
                <select id="weigherSelect">
                    <option value="">Seleziona pesa...</option>
                </select>
            </div>
            
            <div class="weight-display">
                <div class="weight-value" id="weightValue">------</div>
                <div class="weight-unit" id="weightUnit">--</div>
                <div class="weight-status" id="weightStatus">--</div>
            </div>
        </div>

        <!-- Campo Descrizione -->
        <div class="input-group">
            <label for="noteInput">Descrizione</label>
            <input type="text" id="noteInput" placeholder="Inserisci descrizione...">
        </div>

        <!-- Campo Materiale con suggerimenti -->
        <div class="input-group" style="position: relative;">
            <label for="materialInput">Materiale</label>
            <input 
                type="number" 
                id="materialId" 
                autocomplete="off">
            <input 
                type="text" 
                id="materialInput" 
                placeholder="Materiale"
                autocomplete="off">
            <ul class="suggestions-list" id="materialSuggestions"></ul>
        </div>

        <!-- Campo Operatore con suggerimenti -->
        <div class="input-group" style="position: relative;">
            <label for="operatorInput">Operatore</label>
            <input 
                type="number" 
                id="operatorId" 
                autocomplete="off">
            <input 
                type="text" 
                id="operatorInput" 
                placeholder="Operatore"
                autocomplete="off">
            <ul class="suggestions-list" id="operatorSuggestions"></ul>
        </div>

        <!-- Pulsante stampa -->
        <div class="buttons-group">
            <button id="weighingButton">Stampa</button>
        </div>
    </div>

    <!-- Popup di riconnessione -->
    <div id="reconnectionPopup" class="popup">
        <div class="popup-content">
            <p>Clicca ok per riconnettere...</p>
            <button id="reconnectionButton">OK</button>
        </div>
    </div>

    <div class="snackbar" id="snackbar"></div>

    <script type="module" src="/static/javascript/auth.js"></script>
    <script type="module" src="/static/javascript/interceptor.js"></script>
    <script src="/static/javascript/navbar.js"></script>
    <script>
        // Variabili globali
        let currentWeigherPath = null;
        let websocket = null;
        let selectedMaterialId = null;
        let selectedOperatorId = null;
        let websocket_connection = null;
        let requestIdCounter = 0;
        const pendingRequests = new Map();
        let isRefreshing = false;
        let intentionalClose = false;
        let currentPopup = null;
        
        const weigherSelect = document.getElementById('weigherSelect');
        const weightValue = document.getElementById('weightValue');
        const weightUnit = document.getElementById('weightUnit');
        const weightStatus = document.getElementById('weightStatus');
        const note = document.getElementById('noteInput');
        const materialId = document.getElementById('materialId');
        const materialDescription = document.getElementById('materialInput');
        const operatorId = document.getElementById('operatorId');
        const operatorDescription = document.getElementById('operatorInput');
        const weighingButton = document.getElementById('weighingButton');
        const reconnectionButton = document.getElementById('reconnectionButton');

        // Gestione refresh pagina
        window.onbeforeunload = function() {
            isRefreshing = true;
        };

        // Funzioni per gestire i popup
        function openPopup(name) {
            currentPopup = name;
            const popup = document.getElementById(name);
            const popupContent = popup.querySelector(".popup-content");
            popup.style.display = "flex";
            setTimeout(() => {
                popupContent.classList.add("show");
            }, 10);
        }

        function closePopup(name) {
            const popup = document.getElementById(name);
            const popupContent = popup.querySelector(".popup-content");
            
            popupContent.classList.remove("show");
            
            setTimeout(() => {
                popup.style.display = "none";
                currentPopup = null;
            }, 300);
        }

        // Funzione per validare i campi e abilitare/disabilitare il pulsante
        function validateInputs() {
            const isNoteValid = note.value.trim() !== '';
            const isMaterialValid = materialDescription.value.trim() !== '';
            const isOperatorValid = operatorDescription.value.trim() !== '';
            
            weighingButton.disabled = !(isNoteValid && isMaterialValid && isOperatorValid);
        }

        // Funzioni per gestire abilitazione/disabilitazione input
        function disableAllElements() {
            // Disabilita solo gli input di pesata
            note.disabled = true;
            materialId.disabled = true;
            materialDescription.disabled = true;
            operatorId.disabled = true;
            operatorDescription.disabled = true;
            weighingButton.disabled = true;
        }

        function enableAllElements() {
            const elements = document.querySelectorAll('button, input, select, textarea, [role="button"]');
            elements.forEach(element => {
                element.disabled = false;
            });
            
            // Valida gli input dopo aver abilitato gli elementi
            validateInputs();
        }

        function disableInputs() {
            note.disabled = true;
            materialId.disabled = true;
            materialDescription.disabled = true;
            operatorId.disabled = true;
            operatorDescription.disabled = true;
            weighingButton.disabled = true;
        }

        function enableInputs() {
            note.disabled = false;
            materialId.disabled = false;
            materialDescription.disabled = false;
            operatorId.disabled = false;
            operatorDescription.disabled = false;
            validateInputs();
        }

        function clearAllInputs() {            
            if (materialId.value) {
                deselectAnagrafic('material');
            }
            if (operatorId.value) {
                deselectAnagrafic('operator');
            }
            note.value = '';
            materialId.value = null;
            materialDescription.value = '';
            operatorId.value = null;
            operatorDescription.value = '';
            
            validateInputs();
        }

        // Inizializzazione
        document.addEventListener('DOMContentLoaded', () => {
            loadWeighers();
            setupEventListeners();
            connectWebSocketAnagrafic();
            disableInputs();
        });

        // Setup listener per il pulsante di riconnessione
        reconnectionButton.addEventListener('click', attemptReconnect);

        // Carica lista pese
        async function loadWeighers() {
            try {
                const res = await fetch('/api/config-weigher/configuration');
                const data = await res.json();
                
                const select = document.getElementById('weigherSelect');
                select.innerHTML = '<option value="">Seleziona pesa...</option>';
                
                for (let instance in data.weighers) {
                    for (let weigher in data.weighers[instance].nodes) {
                        const option = document.createElement('option');
                        option.value = `?instance_name=${instance}&weigher_name=${weigher}`;
                        option.textContent = weigher;
                        select.appendChild(option);
                    }
                }
            } catch (error) {
                showSnackbar('Errore nel caricamento delle pese', 'error');
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            weigherSelect.addEventListener('change', handleWeigherChange);
            
            note.addEventListener('input', validateInputs);
            materialDescription.addEventListener('input', (e) => {
                const value = e.target.value;
                if (materialId.value) {
                    deselectAnagrafic('material');
                }
                showSuggestions('material', value);
                validateInputs();
            });
            operatorDescription.addEventListener('input', (e) => {
                const value = e.target.value;
                if (operatorId.value) {
                    deselectAnagrafic('operator');
                }
                showSuggestions('operator', value);
                validateInputs();
            });

            materialDescription.addEventListener('focus', (e) => {
                const value = e.target.value;
                if (!materialId.value) {
                    showSuggestions('material', value);
                }
            });

            materialDescription.addEventListener('blur', () => {
                closeSuggestions('materialInput', 'materialSuggestions', 'material');
            });

            operatorDescription.addEventListener('focus', (e) => {
                const value = e.target.value;
                if (!operatorId.value) {
                    showSuggestions('operator', value);
                }
            });

            operatorDescription.addEventListener('blur', () => {
                closeSuggestions('operatorInput', 'operatorSuggestions', 'operator');
            });

            weighingButton.addEventListener('click', handleWeighing);

            document.addEventListener('click', (e) => {
                if (!e.target.closest('.input-group') && !e.target.closest('.weigher-select-container')) {
                    document.querySelectorAll('.suggestions-list').forEach(list => {
                        list.classList.remove('show');
                    });
                }
            });

            window.onclick = function(event) {
                if (currentPopup && event.target.classList.contains('popup') && currentPopup !== "reconnectionPopup") {
                    closePopup(currentPopup);
                }
            };
        }

        // Gestione cambio pesa
        function handleWeigherChange(e) {
            currentWeigherPath = e.target.value;
            
            closeWebSocket(true);
            
            if (currentWeigherPath) {
                enableInputs();
                connectWebSocket();
            } else {
                disableInputs();
                clearAllInputs();
                
                weightValue.textContent = '------';
                weightUnit.textContent = '--';
                weightStatus.textContent = '--';
            }
        }

        // Connessione WebSocket
        function connectWebSocket() {
            const baseUrl = window.location.origin.replace(/^http/, 'ws');
            const wsUrl = `${baseUrl}/api/command-weigher/realtime${currentWeigherPath}`;
            
            closeWebSocket(true);
            
            websocket = new WebSocket(wsUrl);
            
            websocket.addEventListener('open', () => {
                console.log('WebSocket peso connesso');
                intentionalClose = false;
                enableAllElements();
                if (currentPopup === 'reconnectionPopup') {
                    closePopup('reconnectionPopup');
                }
            });
            
            websocket.addEventListener('message', (e) => {
                const data = JSON.parse(e.data);
                updateWeightDisplay(data);
            });

            websocket.addEventListener('error', () => {
                if (!isRefreshing && !intentionalClose) {
                    console.error('WebSocket error');
                    closeWebSocket(false);
                    disableAllElements();
                    weigherSelect.disabled = false;
                    reconnectionButton.disabled = false;
                    document.querySelector('#reconnectionPopup .popup-content p').textContent = "Clicca ok per riconnettere...";
                    openPopup('reconnectionPopup');
                } else if (!isRefreshing) {
                    // FALLBACK: riabilita sempre
                    reconnectionButton.disabled = false;
                    weigherSelect.disabled = false;
                }
            });

            websocket.addEventListener('close', () => {
                if (!isRefreshing && !intentionalClose) {
                    console.log('WebSocket chiuso');
                    disableAllElements();
                    weigherSelect.disabled = false;
                    reconnectionButton.disabled = false;
                    document.querySelector('#reconnectionPopup .popup-content p').textContent = "Clicca ok per riconnettere...";
                    openPopup('reconnectionPopup');
                } else if (!isRefreshing) {
                    // FALLBACK: riabilita sempre
                    reconnectionButton.disabled = false;
                    weigherSelect.disabled = false;
                }
                intentionalClose = false;
            });
        }

        // Chiudi WebSocket
        function closeWebSocket(isIntentional = false) {
            if (websocket) {
                intentionalClose = isIntentional;
                websocket.onclose = null;
                websocket.onerror = null;
                websocket.close();
                websocket = null;
            }
        }

        // Tentativo di riconnessione - CORRETTO!
        function attemptReconnect() {
            if (!currentWeigherPath) {
                showSnackbar('Seleziona una pesa', 'error');
                closePopup('reconnectionPopup');
                return;
            }

            reconnectionButton.disabled = true;
            document.querySelector('#reconnectionPopup .popup-content p').textContent = "Riconnessione in corso...";
            
            closeWebSocket(true);
            // RESET DEL FLAG - FONDAMENTALE!!!
            intentionalClose = false;
            connectWebSocket();
        }

        // Aggiorna visualizzazione peso
        function updateWeightDisplay(data) {
            if (data.tare !== undefined) {
                weightValue.textContent = data.net_weight !== undefined ? data.net_weight : 'N/A';
                weightUnit.textContent = data.unite_measure !== undefined ? data.unite_measure : '--';
                weightStatus.textContent = data.status !== undefined ? data.status : '--';
            }
            
            if (data.message) {
                showSnackbar(data.message, 'success');
            }
            
            if (data.error_message) {
                showSnackbar(data.error_message, 'error');
            }
        }

        // Mostra suggerimenti
        async function showSuggestions(type, query) {
            const listId = type === 'material' ? 'materialSuggestions' : 'operatorSuggestions';
            const list = document.getElementById(listId);
            let endpoint = type === 'material' ? 
                `/api/anagrafic/material/list` :
                `/api/anagrafic/operator/list`;
            
            if (query) {
                endpoint += `?description=${query}%`;
            }

            try {
                const res = await fetch(endpoint);
                const data = await res.json();
                
                list.innerHTML = '';
                
                data.data.forEach(item => {
                    const li = document.createElement('li');
                    const text = item.description;
                    li.innerHTML = highlightText(text, query);
                    li.dataset.id = item.id;
                    
                    li.addEventListener('mousedown', (e) => {
                        e.preventDefault();
                        selectAnagrafic(type, item);
                        if (type === "material") {
                            materialId.value = item.id;
                            materialDescription.value = item.description;
                            materialDescription.blur();
                        } else if (type === "operator") {
                            operatorId.value = item.id;
                            operatorDescription.value = item.description;
                            operatorDescription.blur();
                        }
                        validateInputs();
                    });
                    
                    list.appendChild(li);
                });
                
                list.classList.add('show');
            } catch (error) {
                console.error('Errore nel caricamento suggerimenti:', error);
            }
        }

        // Chiudi suggerimenti al blur
        function closeSuggestions(inputId, listId, type) {
            const list = document.getElementById(listId);
            const input = document.getElementById(inputId);
            const value = input.value.trim();
            
            list.classList.remove('show');
            
            if (!value) return;
            
            const options = list.querySelectorAll('li');
            
            if (options.length === 1) {
                const itemId = options[0].dataset.id;
                const itemText = options[0].textContent.trim();
                
                if (itemText.toLowerCase() === value.toLowerCase()) {
                    const isAlreadySelected = type === 'material' ? materialId.value == itemId : operatorId.value == itemId;
                    
                    if (!isAlreadySelected) {
                        const item = {
                            id: itemId,
                            description: itemText
                        };
                        
                        selectAnagrafic(type, item);
                    }
                }
            }
        }
        
        // Connessione WebSocket per anagrafiche
        function connectWebSocketAnagrafic() {
            const token = localStorage.getItem('token');
            const baseUrl = window.location.origin.replace(/^http/, 'ws');
            const wsUrl = `${baseUrl}/api/anagrafic/access?token=${encodeURIComponent(token)}`;
            
            websocket_connection = new WebSocket(wsUrl);
            
            websocket_connection.addEventListener('open', () => {
                console.log('WebSocket anagrafiche connesso');
            });

            websocket_connection.addEventListener('message', (e) => {
                const data = JSON.parse(e.data);
                
                if (data.action === "lock" && data.success === true && data.type === "SELECT") {
                    removeWebSocketRequest(data.idRequest);
                    showSnackbar('Anagrafica selezionata', 'success');
                } else if (data.action === "unlock" && data.success === true) {
                    removeWebSocketRequest(data.idRequest);
                } else if (data.error) {
                    showSnackbar(data.error, 'error');
                }
            });

            websocket_connection.addEventListener('error', () => {
                console.error('Errore WebSocket anagrafiche');
            });

            websocket_connection.addEventListener('close', () => {
                console.log('WebSocket anagrafiche chiuso');
                setTimeout(() => connectWebSocketAnagrafic(), 3000);
            });
        }

        function removeWebSocketRequest(id) {
            if (pendingRequests.has(id)) {
                const request = pendingRequests.get(id);
                if (request.callback_anagrafic) request.callback_anagrafic();
                request.resolve();
                pendingRequests.delete(id);
            }
        }

        async function sendWebSocketRequest(action, data, callback_anagrafic) {
            return new Promise((resolve, reject) => {
                if (!websocket_connection) {
                    reject(new Error("WebSocket non inizializzato"));
                    return;
                }

                const idRequest = ++requestIdCounter;
                pendingRequests.set(idRequest, { resolve, reject, callback_anagrafic });

                const message = { action, ...data, idRequest };
                websocket_connection.send(JSON.stringify(message));

                setTimeout(() => {
                    if (pendingRequests.has(idRequest)) {
                        pendingRequests.delete(idRequest);
                        reject(new Error("Request timed out"));
                    }
                }, 10000);
            });
        }

        // Seleziona anagrafica
        async function selectAnagrafic(type, item) {
            if (!currentWeigherPath) {
                showSnackbar('Seleziona una pesa', 'error');
                return;
            }

            try {
                const anagrafic = type === 'material' ? 'material' : 'operator';
                const idRecord = item.id;
                
                await sendWebSocketRequest("lock", { 
                    idRecord, 
                    type: "SELECT", 
                    anagrafic 
                }, null);

                if (type === 'material') {
                    materialId.value = item.id;
                    materialDescription.value = item.description;
                } else if (type === 'operator') {
                    operatorId.value = item.id;
                    operatorDescription.value = item.description;
                }
                
                validateInputs();
            } catch (error) {
                showSnackbar('Errore nella selezione', 'error');
            }
        }

        // Deseleziona anagrafica
        function deselectAnagrafic(type) {
            if (!materialId.value && !operatorId.value) return;

            try {
                const anagrafic = type === 'material' ? 'material' : 'operator';
                const idRecord = type === 'material' ? Number(materialId.value) : Number(operatorId.value);
                
                if (!idRecord) return;

                sendWebSocketRequest("unlock", { 
                    idRecord, 
                    type: "", 
                    anagrafic 
                }, null);

                if (type === 'material') {
                    materialId.value = null;
                } else if (type === 'operator') {
                    operatorId.value = null;
                }
                
                validateInputs();
            } catch (error) {
                console.error('Errore nella deselezione:', error);
            }
        }

        // Evidenzia testo
        function highlightText(text, query) {
            const regex = new RegExp(`^(${query})`, 'i');
            if (regex.test(text)) {
                return text.replace(regex, '<span class="highlight">$1</span>');
            }
            return text;
        }

        // Gestione pesata
        async function handleWeighing() {
            if (!currentWeigherPath) {
                showSnackbar('Seleziona una pesa', 'error');
                return;
            }

            try {
                const res = await fetch(`/api/command-weigher/weighing-without-pid${currentWeigherPath}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        note: note.value,
                        material: {
                            id: materialId.value ? Number(materialId.value) : null,
                            description: materialDescription.value
                        },
                        operator: {
                            id: operatorId.value ? Number(operatorId.value) : null,
                            description: operatorDescription.value
                        }
                    })
                });
                const data = await res.json();
                
                if (data.in_out && data.in_out.id) {
                    showSnackbar('Pesata di non conformitÃ  eseguita', 'success');
                    note.value = "";
                    materialId.value = null;
                    materialDescription.value = "";
                    operatorId.value = null;
                    operatorDescription.value = "";
                    validateInputs();
                } else {
                    showSnackbar(data.error_message, 'error');
                }
            } catch (error) {
                showSnackbar('Errore nell\'esecuzione della pesata', 'error');
            }
        }

        // Mostra snackbar
        function showSnackbar(message, type = 'info') {
            const snackbar = document.getElementById('snackbar');
            snackbar.textContent = message;
            snackbar.style.backgroundColor = type === 'error' ? '#f44336' : 
                                           type === 'success' ? '#4caf50' : '#333';
            snackbar.classList.add('show');
            
            setTimeout(() => {
                snackbar.classList.remove('show');
            }, 3000);
        }
    </script>
</body>
</html>